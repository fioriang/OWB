---
title: "lasso_disposal"
author: "Fiori Anglou"
date: "2023-03-28"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(glmnet)
library(extrafont)
library(tidyverse)
loadfonts(device = "win")
state_data_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/03. State_Data"
post_syp_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/06. Post SYP"
figure_path <- "C:/Users/fa24575/Dropbox/Apps/Overleaf/Organic Waste Bans/Figures"
municipal_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/03.1. Municipal Data"
```

# Basic Data

Apart from waste information, I also use population data (from the Bureau of Labor) and GDP data. The GDP is standardized in 2012 dollars and is in millions. In the analysis, wherever I use it, I normalize it with the population. 

```{r, include=FALSE}
loadfonts(device = "win")

plotCol <- c('royalblue4','deepskyblue3','skyblue','purple1','purple4','lightslateblue','darkmagenta', 'mediumorchid', 'goldenrod', 'honeydew3', 'firebrick3','palegreen3','plum', "aquamarine", "brown4", "cyan4", "darkslategray3", "darkolivegreen4")

ut_colors <- c(
  rgb(132, 59,14, max=255), # dark orange
  rgb(255, 127, 21, max=255), # bright orange
  rgb(191,87,0, max=255), # ut orange
  rgb(51,73,72, max=255), # dark grey
  rgb(156, 173, 183, max=255), #light grey
  rgb(191,87,0,alpha=50, max=255))# ut orange

# Population
population <- read.csv(paste0(state_data_path,"/00. Controls/Population/population.csv"))
population <- cbind(population[1:2], stack(population[3:31]))
colnames(population)<- c("state_id", "county_name", "pop", "year")
population$year <- substring(population$year, 2) %>% as.integer
population$pop <- as.numeric(population$pop)
population$county_name[population$county_name=="doña ana"] <- "dona ana"
population <- population[population$state_id!="AK" & population$state_id!="co" & population$state_id!="ia",] # contiguous states, DC is considered a contiguous state

population_2020 <- read.csv(paste0(state_data_path,"/00. Controls/Population/population_2020.csv"))
population_2020 <- population_2020[population_2020$state_id !="DC",]
population_2020$county_name[population_2020$county_name=="doña ana"] <- "dona ana"
population <- rbind(population, population_2020)
rm(population_2020)


# Waste Data
#power2 <- read.csv("power2_2.csv")
power2 <- read.csv("power2_impexp.csv")
all_treated <- c("VT", "MA", "CA", "CT", "RI")# Never changes
bans <- c(2014, 2014, 2016, 2014, 2016)
#bans <- c(2014, 2014, 2016, 2014, 2016)
bans_passage <- c(2012, 2013, 2014, 2011, 2014) #passage dates

```

## Pre-Processing

In pre-processing of the data I want to make sure that the following hold: 

-There are no missing data, so each location that is included in the analysis has all the observations from `year_start` to `year_cutoff`
-Some very very small values have been excluded, specifically if the mean of `tons_pc` is less than 0.3
- Some locations that have very big spikes (up or down). I filtered those by looking at the percentage change between two consecutive years. I allow only changes that are less than 60\% 


```{r, include=FALSE}
year_start <- 2006
year_cutoff <- 2018
year_end <- 2011

dt <- power2

dt <- 
  dt %>% 
  filter(
    year >= year_start, 
    year <= year_cutoff, 
    type == "disposal") %>% 
  group_by (year, state_id, county_name) %>% 
  summarise(tons = sum(tons)) %>% 
  left_join (
    population %>% group_by(state_id, year) %>% summarise(state_pop = sum(pop)), 
    by = c("state_id", "year")
  ) %>%
  left_join (
    population,
    by = c("state_id", "county_name", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(county_name),tons/state_pop, tons/pop), 
    county_id = ifelse(is.na(county_name), state_id, paste0(county_name, state_id) )
  )%>% 
    filter(
      tons_pc > 0.2
    )


#Exclude missing values and small values
exc<- 
  as.data.frame(
    dt %>% 
      group_by(county_id) %>% 
      summarize(
        m = mean(tons_pc), 
        min_year = min(year), 
        min_tons = min(tons_pc), 
        max_tons = max(tons_pc)) %>% 
      filter(
        m < 0.3 | min_year > year_start)
  )

dt <- dt[!(dt$county_id %in% exc$county_id),]
dt <- dt[dt$year >=year_start  & dt$year <=year_cutoff,]
exc<- 
  as.data.frame(
    dt %>% 
      group_by(county_id) %>% 
      summarize(n=  n()) %>% 
      filter(
        n < (year_cutoff- year_start+1)
      )
  )
dt <- dt[!(dt$county_id %in% exc$county_id),]
# Percentage change in disposal tons
f <- 
  as.data.frame(
    dt %>% 
      group_by(county_id) %>% 
      mutate(
        percentage = (tons-dplyr::lag(tons, n = 1, default = NA))/dplyr::lag(tons, n = 1, default = NA),
        percentage_1 = (tons-dplyr::lead(tons, n = 1, default = NA))/dplyr::lead(tons, n = 1, default = NA)
      )
  )

f <- f[!is.na(f$percentage),]
threshold <- 0.6
exclude2 <- unique(f$county_id[f$percentage > threshold | f$percentage < -threshold | f$percentage_1 > threshold | f$percentage_1 < -threshold])
dt <- dt[!dt$county_id %in% exclude2,]

donors <- unique(dt$county_id)
rm(f, exc, exclude2, population_2020)

#dt$tons_pc <- log(dt$tons_pc)
dt_initial <- dt
```



## Functions
```{r}
# Understanding the LASSO Placebo Approach
lasso_pre <- function (k, dt,ban_year,offset, donors)
{
  treated_location <- donors[k]
  year_end <- ban_year-offset
  state_treated <- ifelse(
    str_length(treated_location)>2, 
    substr(treated_location, str_length(treated_location)-1, str_length(treated_location)), 
    treated_location)
  
  don_new <- donors[donors!=treated_location]
  don_new <- 
    don_new %>% 
    as_tibble %>% 
    mutate(
      state = ifelse( 
        str_length(value)>2, 
        substr(value, str_length(value)-1, str_length(value)), 
        value)
    ) %>% 
    filter(
      state != state_treated
    ) %>% as.data.frame()
  
  don_new <- don_new[,"value"]
  
  n_don <- length(don_new)
  test_ind_end1 <- year_end - year_start+1
  test_ind_end2 <- ban_year-year_end-1 +test_ind_end1
  
  
  
  y <- dt[dt$county_id==treated_location, c("tons_pc")]
  y_train <- y[1:test_ind_end1]
  y_test <-  y[(test_ind_end1+1):test_ind_end2]
  y_att <- y[(test_ind_end2+1):length(y)]
  
  x <- dt[dt$county_id!=treated_location, c("tons_pc", "county_id")]
  x <- as.matrix(unstack(x, tons_pc ~ county_id))
  x_train <- x[1:test_ind_end1,]
  x_test <-  x[(test_ind_end1+1):test_ind_end2,]
  x_att <- x[(test_ind_end2+1):length(y),]
  
  a1 <-lasso_att(y_train, y_test,y_att, x_train, x_test, x_att, test_ind_end1, test_ind_end2)
  a2 <-lasso_att_modification(y_train, y_test,y_att, x_train, x_test, x_att, test_ind_end1, test_ind_end2)
  c(a1, a2)
  
  a <- rbind(a1, a2) %>%  as_data_frame()
  colnames(a) <- c("att", "mape", "r_sq", "nreg", "lambda")
  a$type <- c(rep("No Constraint", 1),rep("Constraint", 1))
  a$ban_year <- ban_year
  a$county_id <- treated_location
  
  return(a)
}

lasso_att <- function(y_train, y_test,y_att, x_train, x_test, x_att, test_ind_end1, test_ind_end2)
{
  cv_model <- cv.glmnet(x_train, y_train, alpha = 1)
  best_lambda <- cv_model$lambda.min
  best_model <- glmnet(x_train, y_train, alpha = 1, lambda = best_lambda)
  x_with_coef_test <- cbind(1,x_test)
  x_with_coef_att <- cbind(1,x_att)
  
  #find Rsquared
  #ss_res <- sum((y_test- x_with_coef_test%*%as.matrix(coef(best_model)))^2)
  #ss_tot <- sum((y_train-mean(y_train))^2)
  #R_sq_out <- 1- ss_res/ss_tot
  ma <- (x_with_coef_test%*%as.matrix(coef(best_model)) - y_test) %>%  abs %>% mean
  
  att <- mean(x_with_coef_att%*%as.matrix(coef(best_model))-y_att)
  c(att, ma,  best_model$dev.ratio, best_model$df, best_lambda)
}

lasso_att_modification <- function(y_train, y_test,y_att, x_train, x_test, x_att, test_ind_end1, test_ind_end2)
{
  cv_model <- cv.glmnet(x_train, y_train, alpha = 1, dfmax = 5)
  best_lambda <- cv_model$lambda.min
  best_model <- glmnet(x_train, y_train, alpha = 1, lambda = best_lambda, dfmax = 5)
  x_with_coef_test <- cbind(1,x_test)
  x_with_coef_att <- cbind(1,x_att)
  
  #find Rsquared
  #ss_res <- sum((y_test- x_with_coef_test%*%as.matrix(coef(best_model)))^2)
  #ss_tot <- sum((y_train-mean(y_train))^2)
  #R_sq_out <- 1- ss_res/ss_tot
  ma <- (x_with_coef_test%*%as.matrix(coef(best_model)) - y_test) %>%  abs %>% mean
  
  att <- mean(x_with_coef_att%*%as.matrix(coef(best_model))-y_att)
  c(att, ma,  best_model$dev.ratio, best_model$df, best_lambda)
}

get_plac_res_alt_state_county_lasso <- function (dt,r_threshold, mape_threshold )
{
  
  dt <-   
    dt%>%
    filter(
      r_sq > r_threshold, 
      mape < mape_threshold
    )
  
  plac_res_alt_state_county <- 
    dt %>% 
    left_join (
      pop_plac, 
      by =c("county_id")
    ) %>% 
    mutate(
      state_id = ifelse(is.na(state_id), county_id, state_id), 
      weight = ifelse(is.na(mean_pop), 1, mean_pop/ state_pop)
    ) %>% 
    group_by(state_id, county_id, ban_year, type)%>% 
    summarise(
      att = median(att), 
      mape = median(mape), 
      r_sq = median(r_sq), 
      weight = median(weight)
    ) %>% 
    ungroup() %>% 
    group_by(state_id, ban_year, type) %>% 
    summarise(
      att = sum(att* weight), 
      r_sq = sum(r_sq * weight),
      mape = sum(mape * weight)
    ) %>% 
    ungroup()
  
  plac_res_alt_state_county
}

pool_function_lasso <-function(i, data, donors, r_threshold,mape_threshold)
{
  donors <- tibble(
    county_id =donors, 
    num_id = 1:length(donors)
  )
  

  pooled <- 
    data %>%
    left_join(
      donors, 
      by = c("county_id")
    ) %>% 
    group_by(county_id) %>% 
    mutate(
      pools = sample(nrow(donors),4) %>% list()
    )%>% 
    ungroup
  
  
  pooled %>%
    mutate(
      num_id = num_id %>% as.integer
    ) %>% 
    filter(
      num_id %in% (
        pooled%>% 
          filter(num_id==i) %>% 
          slice(1) %>% 
          pluck("pools") %>% 
          unlist
      )
    ) %>% 
    group_by(ban_year, type) %>% 
    summarise(
      att = mean(att), 
      mape = mean(mape), 
      r_sq = mean(r_sq), 
      i
    ) %>% 
    ungroup
}
```

# County

## County Pre
```{r, include=FALSE}
dt_intial <- pre_processing_dt (power2)
dt <- dt_initial
col <- plotCol[1]
treated_counties_id <- unique(dt$county_id[dt$state_id%in% all_treated])
dt <- dt[!(dt$state_id %in% all_treated),] %>% as.data.frame
#dt$tons_pc <- log(dt$tons_pc)
donors <- unique(dt$county_id[!(dt$state_id%in% all_treated)])
```

## Basic
```{r}
lasso_att_res <- lapply(1:length(donors), lasso_pre,dt,ban_year=2015,offset=4, donors)
lasso_att_res_2015 <- lasso_att_res %>%  bind_rows()


lasso_att_res <- lapply(1:length(donors), lasso_pre,dt,ban_year=2014,offset=4, donors)
lasso_att_res_2014 <- lasso_att_res %>%  bind_rows()


lasso_att_res <- lapply(1:length(donors), lasso_pre,dt,ban_year=2016,offset=4, donors)
lasso_att_res_2016 <- lasso_att_res %>%  bind_rows()

lasso_att_res <- rbind(lasso_att_res_2015, lasso_att_res_2014, lasso_att_res_2016)

write.csv(lasso_att_res, "lasso_att_res.csv", row.names = FALSE)

```

## County Pooled State

```{r}
pop_plac <- 
  population %>% 
  filter (
    year >= 2015, 
    year <= 2018, 
    state_id  %in% c(dt %>% select(state_id) %>% summarise(state_id = unique(state_id))%>% unlist)
  ) %>% 
  group_by(county_name, state_id) %>% 
  summarise(mean_pop = mean(pop)) %>% 
  mutate(
    county_id = paste(county_name,state_id, sep = "")
  ) %>% 
  group_by (state_id) %>% 
  mutate(
    state_pop = sum(mean_pop)
  )

lasso_state_county <- get_plac_res_alt_state_county_lasso(lasso_att_res, r_threshold = 0, mape_threshold = Inf)

```


## County Pooled

```{r}
pool_estimates <- lapply(seq(1:length(donors)), pool_function_lasso, data = lasso_att_res, donors, r_threshold = 0, mape_threshold = Inf)
pool_estimates <- pool_estimates %>% bind_rows()


write.csv(pool_estimates, "lasso_pool_estimates.csv", row.names = FALSE)
```


# State

## State Pre

```{r}
dt_state <- 
  dt_initial %>% 
  mutate(
    county_id = state_id,
    pop = ifelse(is.na(pop), state_pop, pop)
  ) %>% 
  group_by(county_id, year) %>% 
  summarise(tons_pc = sum(tons)/ sum(pop)) %>% 
  ungroup %>% 
  mutate(state_id = county_id) 

col <- plotCol[1]
treated_counties_id <- unique(dt_state$county_id[dt_state$state_id%in% all_treated])
dt_state <- dt_state[!(dt_state$state_id %in% all_treated),] %>% as.data.frame
#dt$tons_pc <- log(dt$tons_pc)
donors_state <- unique(dt_state$county_id[!(dt_state$state_id%in% all_treated)])
```


## Basic
```{r}
lasso_att_res <- lapply(1:length(donors_state), lasso_pre,dt_state,ban_year=2015,offset=3, donors_state)
lasso_att_res_2015 <- lasso_att_res %>%  bind_rows()


lasso_att_res <- lapply(1:length(donors_state), lasso_pre,dt_state,ban_year=2014,offset=3, donors_state)
lasso_att_res_2014 <- lasso_att_res %>%  bind_rows()


lasso_att_res <- lapply(1:length(donors_state), lasso_pre,dt_state,ban_year=2016,offset=3, donors_state)
lasso_att_res_2016 <- lasso_att_res %>%  bind_rows()

lasso_att_res_state <- rbind(lasso_att_res_2015, lasso_att_res_2014, lasso_att_res_2016)

write.csv(lasso_att_res_state, "lasso_att_res_state.csv", row.names = FALSE)

```


## State Pooled

```{r}
pool_estimates_state <- lapply(seq(1:length(donors_state)), pool_function_lasso, data = lasso_att_res_state, donors_state, r_threshold = 0, mape_threshold = Inf)
pool_estimates_state <- pool_estimates_state %>% bind_rows()

write.csv(pool_estimates_state, "lasso_pool_estimates_state.csv", row.names = FALSE)

```

# Final Plots

## Importing the data
```{r}

## County ## 
lasso_att_res <- read.csv("lasso_att_res.csv")

spec1 <- lasso_att_res %>%
  mutate(specification= "County")

## County Pooled by State##
lasso_state_county <- get_plac_res_alt_state_county_lasso(lasso_att_res, r_threshold = 0, mape_threshold = Inf)

spec2 <- lasso_state_county %>%
  mutate(specification= "County Pooled State")

## County Pooled##
lasso_pool_estimates <- read.csv("lasso_pool_estimates.csv")

spec3 <- lasso_pool_estimates %>%
  mutate(specification= "County Pooled")

## State ##
lasso_att_res_state <- read.csv("lasso_att_res_state.csv")

spec4 <- lasso_att_res_state %>%
  mutate(specification= "State")

## State Pooled ## 
lasso_pool_estimates_state <- read.csv("lasso_pool_estimates_state.csv")

spec5 <- lasso_pool_estimates_state %>%
  mutate(specification= "State Pooled")
```


## Plot 1: CI Specification

```{r}

col = ut_colors[4]

ci_specifications_LASSO <-
  rbind(
    spec1 %>% ungroup %>% select(ban_year, r_sq, mape, att, specification, type),
    spec2 %>% ungroup %>% select(ban_year, r_sq, mape, att, specification, type),
    spec3 %>% ungroup %>% select(ban_year, r_sq, mape, att, specification, type),
    spec4 %>% ungroup %>% select(ban_year, r_sq, mape, att, specification, type),
    spec5 %>% ungroup %>% select(ban_year, r_sq, mape, att, specification, type)
  ) %>% 
  group_by(specification, type) %>%
  summarise(
    att = quantile(att, c(0.05, 0.5,  0.95)) %>% list
  ) %>%
  ungroup %>% 
  unnest(att) %>% 
  mutate(
    specification = specification %>% as.factor,
    ci_level = rep(c("lower", "median","upper"),5*2), 
    specification = factor(specification, levels = c("County", "County Pooled State", "County Pooled", "State", "State Pooled"))
  ) %>%
  pivot_wider(
    names_from = ci_level, 
    values_from = att
  ) %>% 
  ggplot()+
  aes(x=specification, y= median) + 
  geom_errorbar(aes(ymin= lower, ymax=upper), width=0.2, linewidth=0.5, color= ut_colors[5])+
  #geom_point(color= col) + 
  labs(x="", y= "LASSO")+
  facet_grid(vars(type), scales = "free_y")+
  geom_hline(yintercept = 0, lty = "dotted", color = ut_colors[5])+
  #scale_y_continuous(breaks = c(seq(-0.20, 0.20, by = 0.05)), limits = c(-0.22, 0.22))+ 
  theme_classic()+
  theme(
    strip.background = element_rect(color = "white", fill = "white"),
    panel.grid.major.x = element_blank() ,
    panel.grid.major.y = element_blank(), 
    text = element_text(family = "Helvetica",size = 16), 
    axis.line.x = element_blank(),
    axis.line.y = element_blank()
  )
ci_specifications_LASSO

# ggsave(
#   "ci_specifications_lasso.jpeg", ci_specifications,
#   path= figure_path,
#   height = 4, width = 10, dpi = 320)
```

