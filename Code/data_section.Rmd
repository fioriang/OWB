---
title: "Data Section"
author: "Fiorentia Zoi Anglou"
date: "2023-02-09"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyverse)
library(extrafont)
library(latex2exp)
library(ggnewscale)
#rmarkdown::render("C:/Users/fa24575/Desktop/what .Rmd")
state_data_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/03. State_Data"
post_syp_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/06. Post SYP"
figure_path <- "C:/Users/fa24575/Dropbox/Apps/Overleaf/Organic Waste Bans/Figures"
```


# Outputs 

## Importing the data 

```{r}
power2 <- read.csv("power2_impexp.csv")

dt <- 
  power2 %>%
  filter(!is.na(county_name)) %>% 
  left_join(
    population, by =c("state_id", "county_name", "year")
  )%>% 
  rbind(
    power2 %>%
      filter(is.na(county_name)) %>% 
      left_join(
        (
          population %>% 
            group_by(state_id, year) %>% 
            summarise(pop = sum(pop))
        )
        , by =c("state_id", "year")
      )
  ) %>% 
  filter(!is.na(pop),!is.na(tons)) %>% 
  mutate(
    tons_pc = tons/pop, 
    type = ifelse(type=="msw_generated", "generation", type),
    type = ifelse(type=="msw_disposed", "disposal", type), 
    type = ifelse(type == "msw_recycled", "recycling", type), 
    type = ifelse(type == "organics", "composting", type), 
    tons = ifelse(state_id=="DE" & year < 2009, NA, tons)
  ) %>%
  group_by (year, state_id, type)%>% 
  summarise(tons_pc = sum(tons, na.rm=TRUE)/ sum(pop))

```


## Figure 1: Data all info 


### a. Subtract the first observation

```{r}

dates <- tibble (
  state_id = c("VT", "MA", "CA", "CT", "RI"),# Never changes
  ban_year  = c(2015, 2015, 2016, 2014, 2016),
  passage_year = c(2012, 2013, 2014, 2011, 2014) #passage dates
)

regions <-
  tibble(
    state_id = c("CT" ,"IN" ,"MN" ,"UT" ,"WI" ,"OR", "TX" ,"VT" ,"WA" ,"CA", "MI" ,"PA" ,"NJ", "FL" ,"MS" ,"NC" ,"OH" ,"SC", "IL", "MA", "GA", "IA", "KY", "TN" ,"MO" ,"CO" ,"DE","RI" ,"MD", "NM" ,"NV" ,"ME", "OK" ,"AZ") ,
    region = c("Northeast", "Midwest", "Midwest", "West","Midwest","West", "Southwest", "Northeast", "West", "West","Midwest", "Northeast", "Northeast", "Southeast", "Southeast", "Southeast", "Midwest", "Southeast", "Midwest", "Northeast", "Southeast", "Midwest", "Southeast", "Southeast", "Midwest", "West", "Northeast", "Northeast", "Northeast", "Southwest", "West", "Northeast","Southwest", "Southwest")
  )



data_availability <- 
  dt %>% 
  filter(
    year >= 2000, 
    year <= 2018, 
    !type %in% c("food_total", "food_donation")
    # food total is in Florida, there's another category for composting
    # food donation is a field in TN, it is empty
  ) %>% 
  filter (
    type != "generation"
  ) %>%
  mutate(
    type = factor(type,
                  levels = c("disposal", "recycling", "composting")
    ),
    type = type %>% 
      forcats::fct_recode(
        Disposal = "disposal", 
        Recycling = "recycling", 
        Composting = "composting"
      )
  ) %>% 
  left_join(
    dates, 
    by = c("state_id")
  ) %>% 
  left_join(
    regions, 
    by = c("state_id")
  ) %>% 
  group_by(state_id, type) %>%  
  mutate(
    min_year = min(year), 
    min_year = ifelse(year==min_year, tons_pc, 0), 
    min_year = max(min_year), 
    tons_pc = tons_pc-min_year, 
    ban_cross = ifelse(year==ban_year, tons_pc, NA),
    passage_cross = ifelse(year==passage_year, tons_pc, NA)
  ) %>%  ungroup %>% 
  ggplot()+
  aes(x=year, y=tons_pc, color = type,linetype = type)+
  geom_line(linewidth = 1)+
  geom_point(aes(x=year, y=ban_cross), color = "goldenrod")+
  geom_point(aes(x=year, y=passage_cross),color = "seagreen")+
  facet_wrap(
    vars(state_id), 
    ncol= 7
  ) + 
  scale_colour_grey(start = 0.2, end =0.6)+
  scale_linetype_manual(values = c("solid", "dotted", "solid"))+
  labs(x="Year", y = "Tons per Capita" ) + 
  scale_x_continuous (breaks = c(2005, 2015))+
  scale_y_continuous (breaks = c(-0.5, 0, 0.5))+
  #scale_y_continuous (breaks = c(2005, 2015))+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    #axis.ticks = element_blank(), 
    #axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())
  

  

# ggsave(
#   "data_availability.jpeg", data_availability,
#   path= figure_path,
#   height = 8, width = 14, dpi = 320)
# 
ggsave(data_availability, filename = "data_availability.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 8, dpi=320, units = "in")

```


### b. Region

```{r}

dates <- tibble (
  state_id = c("VT", "MA", "CA", "CT", "RI"),# Never changes
  ban_year  = c(2015, 2015, 2016, 2014, 2016),
  passage_year = c(2012, 2013, 2014, 2011, 2014) #passage dates
)

regions <-
  tibble(
    state_id = c("CT" ,"IN" ,"MN" ,"UT" ,"WI" ,"OR", "TX" ,"VT" ,"WA" ,"CA", "MI" ,"PA" ,"NJ", "FL" ,"MS" ,"NC" ,"OH" ,"SC", "IL", "MA", "GA", "IA", "KY", "TN" ,"MO" ,"CO" ,"DE","RI" ,"MD", "NM" ,"NV" ,"ME", "OK" ,"AZ", "AL", "NY") ,
    region = c("Northeast", "Midwest", "Midwest", "West","Midwest","West", "Southwest", "Northeast", "West", "West","Midwest", "Northeast", "Northeast", "Southeast", "Southeast", "Southeast", "Midwest", "Southeast", "Midwest", "Northeast", "Southeast", "Midwest", "Southeast", "Southeast", "Midwest", "West", "Northeast", "Northeast", "Northeast", "Southwest", "West", "Northeast","Southwest", "Southwest", "Southeast", "Northeast")
  )

data_availability <- function (chosen_region)
{
    concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      !is.na(tons_pc),
      year >= 1996,
      year <= 2019, 
      !type %in% c("food_total", "food_donation")
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = tons_pc %>%  {(. -first(.))}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
    ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    #geom_point(aes(x=year, y=ban_cross), color = "#417c5b3")+
    #geom_point(aes(x=year, y=passage_cross),color = "goldenrod")+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(2000, 2020))+    
    scale_y_continuous (breaks = c(-0.4, 0, .4), limits = c(-.60, .50))+
    new_scale_color()+
    geom_point(aes(x=year, y=Date, color=Type_Date))+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "none", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10), 
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_legend <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      !is.na(tons_pc),
      year >= 1996,
      year <= 2019, 
      !type %in% c("food_total", "food_donation")
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = tons_pc %>%  {(. -first(.))}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  

 
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
    ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    #geom_point(aes(x=year, y=ban_cross), color = "#417c5b")+
    #geom_point(aes(x=year, y=passage_cross), color = "goldenrod")+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    #scale_color_manual(name = "Group", values=colors)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(2000, 2020))+
    scale_y_continuous (breaks = c(-0.4, 0, .4), limits = c(-.60, .50))+
    new_scale_color()+
    geom_point(aes(x=year, y=Date, color=Type_Date))+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "top", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10), 
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_axes <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      !is.na(tons_pc),
      year >= 1996,
      year <= 2019, 
      !type %in% c("food_total", "food_donation")
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = tons_pc %>%  {(. -first(.))}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
    ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    #geom_point(aes(x=year, y=ban_cross), color = "#417c5b3")+
    #geom_point(aes(x=year, y=passage_cross),color = "goldenrod")+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    new_scale_color()+
    geom_point(aes(x=year, y=Date, color=Type_Date))+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(1997, 2007, 2017), limits = c(1995, 2019),labels = c("'97", "'07", "'17"))+
    scale_y_continuous (breaks = c(-0.4, 0, .4), limits = c(-.60, .50))+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "none", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10)
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}
  
p1 <- data_availability_with_legend("Northeast")
p2 <- data_availability("Southeast")
p3 <- data_availability("West")
p4 <- data_availability("Southwest")
p5 <- data_availability_with_axes("Midwest")

#library(egg)
f <- ggpubr:: ggarrange(p1,p2,p3, p4, p5,nrow=5, widths = rep(14,5), heights = c(8,rep(6,4)))
#library(latex2exp)

f <- ggpubr::annotate_figure(f, left = ggpubr::text_grob(TeX("$\\Delta$ Tons per capita "), family= "Helvetica", rot = 90))



ggsave(f, filename = "data_availability.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 9, dpi=320, units = "in")

```


### b2. Region- Disposal Only % change

```{r}

dates <- tibble (
  state_id = c("VT", "MA", "CA", "CT", "RI"),# Never changes
  ban_year  = c(2015, 2015, 2016, 2014, 2016),
  passage_year = c(2012, 2013, 2014, 2011, 2014) #passage dates
)

regions <-
  tibble(
    state_id = c("CT" ,"IN" ,"MN" ,"UT" ,"WI" ,"OR", "TX" ,"VT" ,"WA" ,"CA", "MI" ,"PA" ,"NJ", "FL" ,"MS" ,"NC" ,"OH" ,"SC", "IL", "MA", "GA", "IA", "KY", "TN" ,"MO" ,"CO" ,"DE","RI" ,"MD", "NM" ,"NV" ,"ME", "OK" ,"AZ", "AL", "NY") ,
    region = c("Northeast", "Midwest", "Midwest", "West","Midwest","West", "Southwest", "Northeast", "West", "West","Midwest", "Northeast", "Northeast", "Southeast", "Southeast", "Southeast", "Midwest", "Southeast", "Midwest", "Northeast", "Southeast", "Midwest", "Southeast", "Southeast", "Midwest", "West", "Northeast", "Northeast", "Northeast", "Southwest", "West", "Northeast","Southwest", "Southwest", "Southeast", "Northeast")
  )

data_availability <- function (chosen_region)
{
    concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1995, 
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal",
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = 100*tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
  ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    #geom_point(aes(x=year, y=ban_cross), color = "#417c5b3")+
    #geom_point(aes(x=year, y=passage_cross),color = "goldenrod")+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(1995, 2019))+
    scale_y_continuous (breaks = c(-40, 0, 40), limits = c(-60, 50))+
    new_scale_color()+
    # geom_point(aes(x=year, y=Date, color=Type_Date), size =2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "top", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10), 
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_legend <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1995, 
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal", 
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = 100*tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  

 
  dt_in %>%mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
  ) %>%  
    ggplot()+
    aes(x=year, y=tons_pc)+#, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    #scale_color_manual(name = "Group", values=colors)+
    #scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(1995, 2019))+
    scale_y_continuous (breaks = c(-40, 0, 40), limits = c(-60, 50))+
    new_scale_color()+
    # geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "top", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10), 
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_axes <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1995,
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal",
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      tons_pc = 100* tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
  ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    new_scale_color()+
    # geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(1997, 2007, 2017), limits = c(1995, 2019),labels = c("'97", "'07", "'17"))+
    scale_y_continuous (breaks = c(-40, 0, 40), limits = c(-60, 50))+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "none", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10)
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}
  
p1 <- data_availability_with_legend("Northeast")
p2 <- data_availability("Southeast")
p3 <- data_availability("West")
p4 <- data_availability("Southwest")
p5 <- data_availability_with_axes("Midwest")

#library(egg)
f <- ggpubr:: ggarrange(p1,p2,p3, p4, p5, nrow=5, widths = rep(14,5), heights = c(8,rep(6,4)))
#library(latex2exp)

f <- ggpubr::annotate_figure(f, left = ggpubr::text_grob(TeX(" Percentage change relative to the first observation "), family= "Helvetica", rot = 90))

ggsave(f, filename = "data_availability_disposal_only_all_years.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 9, dpi=320, units = "in")

```


### b3. Region- Disposal Only

```{r}

dates <- tibble (
  state_id = c("VT", "MA", "CA", "CT", "RI"),# Never changes
  ban_year  = c(2015, 2015, 2016, 2014, 2016),
  passage_year = c(2012, 2013, 2014, 2011, 2014) #passage dates
)

regions <-
  tibble(
    state_id = c("CT" ,"IN" ,"MN" ,"UT" ,"WI" ,"OR", "TX" ,"VT" ,"WA" ,"CA", "MI" ,"PA" ,"NJ", "FL" ,"MS" ,"NC" ,"OH" ,"SC", "IL", "MA", "GA", "IA", "KY", "TN" ,"MO" ,"CO" ,"DE","RI" ,"MD", "NM" ,"NV" ,"ME", "OK" ,"AZ", "AL", "NY") ,
    region = c("Northeast", "Midwest", "Midwest", "West","Midwest","West", "Southwest", "Northeast", "West", "West","Midwest", "Northeast", "Northeast", "Southeast", "Southeast", "Southeast", "Midwest", "Southeast", "Midwest", "Northeast", "Southeast", "Midwest", "Southeast", "Southeast", "Midwest", "West", "Northeast", "Northeast", "Northeast", "Southwest", "West", "Northeast","Southwest", "Southwest", "Southeast", "Northeast")
  )

data_availability <- function (chosen_region)
{
    concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1996, 
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal",
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      #tons_pc = 100*tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
  ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    #geom_point(aes(x=year, y=ban_cross), color = "#417c5b3")+
    #geom_point(aes(x=year, y=passage_cross),color = "goldenrod")+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(1995, 2019))+
    scale_y_continuous (breaks = c(0.5, 0.8, 1.1, 1.4), limits = c(0.4, 1.6))+
    new_scale_color()+
    
    #geom_pointrange(aes(x=year, y=Date, color=Type_Date))+
    geom_errorbar(aes(x=year, ymin = Date-0.1, ymax = Date+0.1, color =Type_Date), width = 0.2, size=0.8)+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    # geom_point(aes(x=year, y=Date, color=Type_Date), size =2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "none", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10), 
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_legend <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1996, 
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal", 
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      #tons_pc = 100*tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  

  
  dt_in %>%mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation")) 
    #Type_Date = ifelse(is.na(Date), NA, Type_Date)
  ) %>%  
    ggplot()+
    aes(x=year, y=tons_pc, color = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    #scale_colour_grey(start = 0.2, end =0.6)+
    scale_color_manual(values=ut_colors[4])+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(2005, 2015), limits = c(1995, 2019))+
    scale_y_continuous (breaks = c(0.5, 0.8, 1.1, 1.4), limits = c(0.4, 1.6))+
    new_scale_color()+
    
    #geom_point(aes(x=year, y=Date, color=Type_Date))+
    geom_errorbar(aes(x=year, ymin = Date-0.1, ymax = Date+0.1, color =Type_Date), width = 0.2, size=0.8)+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    
    # geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "top", 
      panel.background = element_blank(),
      axis.line.x = element_blank(), 
      axis.text.x = element_blank(),
      axis.ticks.x= element_blank(),
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}

data_availability_with_axes <- function (chosen_region)
{
  
  concat_spaces <- function(num_spaces) {
    if (num_spaces <= 0) {
      return("")
    } else {
      return(paste0(" ", concat_spaces(num_spaces - 1)))
    }
  }
  
  dummies_counter <-
    regions %>% 
    group_by (region) %>%  
    summarise(n = n()) %>%  
    ungroup %>%  
    mutate( def =max(n)-n) %>% 
    filter(region == chosen_region) %>% 
    select(def) %>%  pluck("def")
  
  
  dt_in <- 
    dt %>% 
    filter(
      year >= 1996,
      year <= 2019, 
      !type %in% c("food_total", "food_donation"),
      type == "disposal",
      !is.na(tons_pc)
      # food total is in Florida, there's another category for composting
      # food donation is a field in TN, it is empty
    ) %>% 
    filter (
      type != "generation"
    ) %>%
    mutate(
      type = factor(
        type,
        levels = c("disposal", "recycling", "composting")
      ),
      type = type %>% 
        forcats::fct_recode(
          Disposal = "disposal", 
          Recycling = "recycling", 
          Composting = "composting"
        )
    ) %>% 
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    left_join(
      regions, 
      by = c("state_id")
    ) %>% 
    group_by(state_id, type) %>%  
    mutate(
      min_year = min(year), 
      min_year = ifelse(year==min_year, tons_pc, 0), 
      min_year = max(min_year), 
      #tons_pc = 100* tons_pc %>%  {(. -first(.))/first(.)}, 
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%  ungroup %>%
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    filter(region ==chosen_region) 
  
  if(dummies_counter > 0)
  {
    dummies <-
      tibble(
        year = 2005:2020, 
        state_id ="",
        type = "Disposal",
        tons_pc = NA,
        ban_year = NA, 
        passage_year = NA, 
        region = chosen_region, 
        min_year = NA,
        Type_Date = NA, 
        Date =NA)
    
    
    if(dummies_counter >1){
      for (i in 2: dummies_counter)
    {
      dummies <- rbind(
        dummies, 
        tibble(
          year = 2005:2020, 
          state_id =concat_spaces(i),
          type = "Disposal",
          tons_pc = NA,
          ban_year = NA, 
          passage_year = NA, 
          region = chosen_region, 
          min_year = NA,
          Type_Date = NA, 
          Date =NA)
      )
    }
    }
    
    dt_in <- 
      dt_in %>% 
      rbind(dummies)
  }else{dt_in <- dt_in}
  
  
  dt_in %>% mutate(
    Type_Date = factor(Type_Date, levels=c("Passage", "Implementation"))
  ) %>% 
    ggplot()+
    aes(x=year, y=tons_pc, color = type,linetype = type)+
    geom_line(linewidth = .5)+ geom_point(size = 0.5)+
    facet_grid(
      cols = vars(state_id), 
      rows  = vars(region)
    ) + 
    scale_colour_grey(start = 0.2, end =0.6)+
    scale_linetype_manual(values = c("solid", "dotted", "solid"))+
    new_scale_color()+
    
    geom_errorbar(aes(x=year, ymin = Date-0.1, ymax = Date+0.1, color =Type_Date), width = 0.2, size=0.8)+
    scale_color_manual(values=c("goldenrod", "seagreen"), na.translate = FALSE)+
    # geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
    # scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+
    labs(x="", y = "" ) + 
    scale_x_continuous (breaks = c(1997, 2007, 2017), limits = c(1995, 2019),labels = c("'97", "'07", "'17"))+
    scale_y_continuous (breaks = c(0.5, 0.8, 1.1, 1.4), limits = c(0.4, 1.6))+
    #scale_y_continuous (breaks = c(2005, 2015))+
    theme(
      panel.border = element_blank(),
      legend.position = "none", 
      panel.background = element_blank(),
      #axis.ticks = element_blank(), 
      #axis.text=element_blank(),
      #plot.title = element_text(hjust = 0.5, size=10),
      #plot.caption = element_text(hjust=0.5,size = 10)
      text = element_text(family="Helvetica",size = 16), 
      legend.title = element_blank(),
      strip.background = element_blank(), 
      legend.key = element_blank())
  
}
  
p1 <- data_availability_with_legend("Northeast")
p2 <- data_availability("Southeast")
p3 <- data_availability("West")
p4 <- data_availability("Southwest")
p5 <- data_availability_with_axes("Midwest")

#library(egg)
f <- ggpubr:: ggarrange(p1,p2,p3, p4, p5, nrow=5, widths = rep(14,5), heights = c(8,rep(6,4)))
#library(latex2exp)

f <- ggpubr::annotate_figure(f, left = ggpubr::text_grob(TeX(" Disposal (tons per capita) "), family= "Helvetica", rot = 90))

ggsave(f, filename = "data_availability_disposal_only_all_years.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 9, dpi=320, units = "in")

```



### b4. Region- 5 different

```{r}


dt %>% as_tibble %>% 
  filter(
    year >= 1995,
    year <= 2018, 
    type %in% c("disposal", "msw_disposed")
  ) %>% 
  left_join(
    regions, by = c("state_id")
  ) %>% 
  group_by(state_id) %>% 
  mutate(
    x_lab= ifelse(year==max(year), year+1, NA), 
    y_lab = ifelse(year==max(year), tons_pc, NA)
  ) %>% 
  ggplot()+
  aes(x=year,y=tons_pc, group= state_id)+
  geom_line()+
  facet_wrap(vars(region))+
  ggrepel::geom_text_repel(aes(x=x_lab, y = y_lab, label=state_id))
    
  

```



### c. Actual

```{r}

data_availability <- 
  dt %>% 
  filter(
    year >= 2000, 
    year <= 2018, 
    !type %in% c("food_total", "food_donation")
    # food total is in Florida, there's another category for composting
    # food donation is a field in TN, it is empty
  ) %>% 
  filter (
    type != "generation"
  ) %>%
  mutate(
    type = factor(type,
        levels = c("disposal", "recycling", "composting")
      ),
    type = type %>% 
      forcats::fct_recode(
        Disposal = "disposal", 
        Recycling = "recycling", 
        Composting = "composting"
      )
  ) %>% 
  ggplot()+
  aes(x=year, y=tons_pc, color = type,linetype = type)+
  geom_line(linewidth = 1)+
  facet_wrap(
    vars(state_id), 
    ncol= 7
  ) + 
  scale_colour_grey(start = 0.2, end =0.6)+
  scale_linetype_manual(values = c("solid", "dotted", "solid"))+
  labs(x="Year", y = "Tons per Capita" ) + 
  scale_x_continuous (breaks = c(2005, 2015))+
  #scale_y_continuous (breaks = c(-0.5, 0, 0.5))+
  scale_y_continuous (breaks = c(0.5, 1.5))+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    #axis.ticks = element_blank(), 
    #axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())

data_availability

```

### d. CA Counties

```{r}
ca_counties_plot <-
  power2 %>% 
  filter(year >=1996) %>% 
  mutate(
    tons = ifelse(county_name=="butte" & state_id == "CA" & year == 2019, 181914, tons), #I think one digit was wron original is: 1819143
    tons = ifelse(county_name=="colusa" & state_id == "CA" & year == 1995, 13375, tons), # Use next year's tonnage 13375
    tons = ifelse(county_name=="glenn" & state_id == "CA" & year == 2019, 27394, tons), # First quarter tonnage is 60,200 --> i think it should have been 6,020 
    tons = ifelse(county_name=="tehama" & state_id == "CA" & year == 2011, (67376+41921)/2, tons), # Linear extrapolation between 2010 and 2012. The original is more than 3 times as high. 
    tons = ifelse(county_name=="trinity" & state_id == "CA" & year == 2017, 8669, tons), # Fourth quarter tonnage is 21,493 which is unusually high=> I think it should have been 2,149
    tons = ifelse(county_name=="modoc" & state_id == "CA" & year == 2019, tons-11537, tons), # Unusally high 
    tons = ifelse(county_name=="mariposa" & state_id == "CA" & year == 2017, 14559, tons), #3rd quarter is extremely high
    tons = ifelse(county_name=="mariposa" & state_id == "CA" & year == 2019, 13500, tons), #2nd quarter is extremely high
    tons = ifelse(county_name=="del norte" & state_id == "CA" & year == 2019, tons+ 4883*2, tons), #missing 3rd and 4th quarter
    tons = ifelse(county_name=="mono" & state_id == "CA" & year == 1995, 22024, tons), #linear interpolation from years 1996 1997
    tons = ifelse(county_name=="sonoma" & state_id == "CA" & year == 2017, tons-495370, tons), #4th quarter is 4times as much as the previous- use the third
    tons = ifelse(county_name=="sonoma" & state_id == "CA" & year == 2018, tons-662089, tons), #1st quarter is 5times as much as the next- use the second
    tons = ifelse(county_name=="shasta" & state_id == "CA" & year == 2018, 198899, tons), #use the average between the previous and the next year
    tons = ifelse(county_name=="sierra" & state_id == "CA" & year == 2019, tons+1371, tons), #3rd and 4th quarter missing (adding the 2018 ones)
    tons = ifelse(county_name=="nevada" & state_id == "CA" & year == 2012, 68165, tons), #2012 has unusually low tonnage
    tons = ifelse(county_name=="calaveras" & state_id == "CA" & year == 2015, (31741.23+42755.94)/2, tons), #use the average between the previous and the next year
    tons = ifelse(county_name=="san benito" & state_id == "CA" & year %in% c(1995, 1996, 1997), 56821.52, tons), #use the 1998 for all the years between 95 and 98 because its like half
    tons = ifelse(county_name=="siskiyou" & state_id == "CA" & year == 2014, (27811.48+35305.71)/2, tons) #use the average between the previous and the next year
  )%>%
  filter(
    state_id == "CA", 
    type == "disposal", 
    !county_name %in% c("lake", "mendocino") #don't know what to do with it. 
  ) %>% 
  left_join(population, by = c("year", "state_id", "county_name")) %>% 
  mutate(tons_pc = tons/pop, county_name = str_to_title(county_name)) %>% 
  filter(tons_pc >0.3, tons_pc < 4) %>% 
  group_by(county_name) %>% mutate(n = n()) %>% filter(n == max(year)-min(year)+1) %>%
  #ungroup %>% summarise(n_distinct(county_name))
  ungroup %>% group_by(county_name) %>% 
  mutate(tons_pc = 100*tons_pc %>% {(. - first(.))/first(.)}) %>% 
  ggplot(aes(x=year, y=tons_pc))+
  geom_line()+
  #geom_point()+
  facet_wrap (vars(county_name), scales="free_y")+
  # geom_vline(xintercept = 2016, color = "firebrick")+
  # geom_vline(xintercept = 2014, color = "goldenrod")+
  scale_y_continuous(breaks = scales::pretty_breaks(3))+
  scale_x_continuous(breaks = c(1997, 2007, 2017), labels = c("'97", "'07", "'17"))+
  labs(x="Year", y = " Percentage chnage relative to the first observation")+
  theme(
    panel.border = element_blank(),
    legend.position = "none", 
    panel.background = element_blank(),
    text = element_text(family="Helvetica",size = 11), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())

ggsave(ca_counties_plot, filename = "ca_counties_plot.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 9, dpi=320, units = "in")

rm(ca_counties_plot)
```

### d2. CA Counties

```{r}
ca_counties_plot<-
  power2 %>% 
  filter(year >=1996) %>% 
  mutate(
    tons = ifelse(county_name=="butte" & state_id == "CA" & year == 2019, 181914, tons), #I think one digit was wron original is: 1819143
    tons = ifelse(county_name=="colusa" & state_id == "CA" & year == 1995, 13375, tons), # Use next year's tonnage 13375
    tons = ifelse(county_name=="glenn" & state_id == "CA" & year == 2019, 27394, tons), # First quarter tonnage is 60,200 --> i think it should have been 6,020 
    tons = ifelse(county_name=="tehama" & state_id == "CA" & year == 2011, (67376+41921)/2, tons), # Linear extrapolation between 2010 and 2012. The original is more than 3 times as high. 
    tons = ifelse(county_name=="trinity" & state_id == "CA" & year == 2017, 8669, tons), # Fourth quarter tonnage is 21,493 which is unusually high=> I think it should have been 2,149
    tons = ifelse(county_name=="modoc" & state_id == "CA" & year == 2019, tons-11537, tons), # Unusally high 
    tons = ifelse(county_name=="mariposa" & state_id == "CA" & year == 2017, 14559, tons), #3rd quarter is extremely high
    tons = ifelse(county_name=="mariposa" & state_id == "CA" & year == 2019, 13500, tons), #2nd quarter is extremely high
    tons = ifelse(county_name=="del norte" & state_id == "CA" & year == 2019, tons+ 4883*2, tons), #missing 3rd and 4th quarter
    tons = ifelse(county_name=="mono" & state_id == "CA" & year == 1995, 22024, tons), #linear interpolation from years 1996 1997
    tons = ifelse(county_name=="sonoma" & state_id == "CA" & year == 2017, tons-495370, tons), #4th quarter is 4times as much as the previous- use the third
    tons = ifelse(county_name=="sonoma" & state_id == "CA" & year == 2018, tons-662089, tons), #1st quarter is 5times as much as the next- use the second
    tons = ifelse(county_name=="shasta" & state_id == "CA" & year == 2018, 198899, tons), #use the average between the previous and the next year
    tons = ifelse(county_name=="sierra" & state_id == "CA" & year == 2019, tons+1371, tons), #3rd and 4th quarter missing (adding the 2018 ones)
    tons = ifelse(county_name=="nevada" & state_id == "CA" & year == 2012, 68165, tons), #2012 has unusually low tonnage
    tons = ifelse(county_name=="calaveras" & state_id == "CA" & year == 2015, (31741.23+42755.94)/2, tons), #use the average between the previous and the next year
    tons = ifelse(county_name=="san benito" & state_id == "CA" & year %in% c(1995, 1996, 1997), 56821.52, tons), #use the 1998 for all the years between 95 and 98 because its like half
    tons = ifelse(county_name=="siskiyou" & state_id == "CA" & year == 2014, (27811.48+35305.71)/2, tons) #use the average between the previous and the next year
  )%>%
  filter(
    state_id == "CA", 
    type == "disposal", 
    county_name %in% c("los angeles", "san diego", "orange", "riverside", "san bernardino"),#, "santa clara", "alameda"),#don't know what to do with it. 
    year>1995
  ) %>% 
  left_join(population, by = c("state_id", "county_name", "year")) %>% 
  mutate(
    tons_pc=tons/pop,
    label_x = ifelse(year== max(year), year+1.7, NA),
    label_y = ifelse(year== max(year), tons_pc, NA),
    county_name = county_name %>% str_to_title
  ) %>% 
  ggplot(aes(x=year, y=tons_pc, color=county_name))+geom_line()+
  geom_text(aes(x=label_x, y = label_y, label = county_name)) +
  scale_x_continuous(limits = c(1995, 2022), breaks = seq(1995, 2020, by =3))+
  scale_y_continuous(limits = c(0.6, 1.5), breaks = seq(0.6, 1.5, by =0.1))+
  scale_color_manual(values = gray(seq(0, 0.7, length.out = 5)))+
  labs(x="Year", y = "Disposal (tons per capita)")+
   theme(
    panel.border = element_blank(),
    legend.position = "none", 
    panel.background = element_blank(),
    text = element_text(family="Helvetica",size = 18), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())

ggsave(ca_counties_plot, filename = "ca_counties_plot_top7.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 9, dpi=320, units = "in")

rm(ca_counties_plot)


```


### e. Only treated

```{r}


dates <- tibble (
  state_id =c("VT", "MA", "CA", "CT", "RI", "seattle", "boulder", "san francisco"),# Never changes
  ban_year  = c(2015, 2015, 2016, 2014, 2016, 2015, 2016, 2009),
  passage_year = c(2012, 2013, 2014, 2011, 2014, 2014, 2015, NA) #passage dates
)

plot_treated <- function (type_need, state_chosen, dot_type)
{
  options(digits = 2) #number of decimal places
  
  dummies <-
    tibble(
      year = 1995:2018, 
      type = "disposal",
      tons_pc = NA,
      ban_year = NA, 
      passage_year = NA, 
      min_year = NA,
      Type_Date = NA, 
      category = "City",
      Date =NA) %>% expand_grid(state_id = c("", " ")) %>%  select(year, state_id, type, tons_pc, ban_year, passage_year, Type_Date, Date)
  
  dt <-   
    dt %>% 
    rbind(rbind(seattle, boulder ) %>% select(year, county_name, type, tons_pc) %>% rename(state_id = county_name )) %>% 
    rbind(
      power2 %>% filter(county_name== "san francisco") %>% left_join(population,by=c("year", "state_id", "county_name")) %>% mutate(tons_pc = tons/pop)%>%  select(year, county_name, type, tons_pc)%>% rename(state_id = county_name)
    ) %>% 
    filter(state_id %in% all_treated| state_id%in% c("seattle", "boulder", "san francisco"), year <=2018, year >=1995) %>%
    left_join(
      dates, 
      by = c("state_id")
    ) %>% 
    group_by(state_id) %>% 
    mutate(
      #tons_pc = 100*tons_pc %>% {(.-first(.))/first(.)}, 
      tons_pc= tons_pc,
      Implementation = ifelse(year==ban_year, tons_pc, NA),
      Passage = ifelse(year==passage_year, tons_pc, NA)
    ) %>%     
    pivot_longer(
      cols = c("Implementation", "Passage"), 
      names_to = "Type_Date", 
      values_to = "Date"
    ) %>% 
    group_by(state_id) %>% 
    mutate(
      Type_Date = factor(Type_Date, levels=c("Passage", "Implementation")), 
      state_id = ifelse(!state_id %in% all_treated, str_to_title(state_id), state_id), 
      state_id = factor (state_id, levels = c("CA", "MA", "VT", "CT", "RI","San Francisco", "Seattle", "Boulder")) 
    ) %>% rbind(dummies) %>% 
    filter(state_id == state_chosen, type == type_need)
  
  
  if(dot_type==1)
  {
    if(state_chosen %in% c("CA", "MA", "CT", "RI", "VT"))
    {
      p <- 
        dt %>% 
        ggplot(aes(x=year, y=tons_pc), color = ut_colors[4])+geom_line() + 
        #facet_wrap(vars(state_id), scales = "free_y", ncol= n)+
        #geom_point()+
        new_scale_color()+
        geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
        scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+    
        scale_x_continuous(breaks = seq(1995, 2015, by =5), limits = c(1995, 2018))+
        scale_y_continuous(labels = function(x) sprintf("%.2f", x))+
        labs(x="", y="", title = paste0(state_chosen))+
        theme(
          panel.border = element_blank(),
          legend.position = "top", 
          panel.background = element_blank(),
          axis.ticks.x = element_blank(), 
          axis.text.x=element_blank(),
          text = element_text(family="Helvetica",size = 13), 
          legend.title = element_blank(),
          strip.background = element_blank(), 
          legend.key = element_blank())
    }else{
      p <- 
        dt %>% 
        ggplot(aes(x=year, y=tons_pc), color = ut_colors[4])+geom_line() + 
        #facet_wrap(vars(state_id), scales = "free_y", ncol= n)+
        #geom_point()+
        new_scale_color()+
        geom_point(aes(x=year, y=Date, color=Type_Date), size=2)+
        scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+    
        scale_x_continuous(breaks = seq(1995, 2015, by =5), limits = c(1995, 2018))+
        scale_y_continuous(labels = function(x) sprintf("%.2f", x))+
        labs(x="", y="", title = paste0(state_chosen))+
        theme(
          panel.border = element_blank(),
          legend.position = "none", 
          panel.background = element_blank(),
          #axis.ticks.x = element_blank(), 
          #axis.text.x=element_blank(),
          text = element_text(family="Helvetica",size = 13), 
          legend.title = element_blank(),
          strip.background = element_blank(), 
          legend.key = element_blank())
    }
  }else{
    if(state_chosen %in% c("CA", "MA", "CT", "RI", "VT"))
    {
      p <- 
        dt %>% 
        ggplot(aes(x=year, y=tons_pc), color = ut_colors[4])+geom_line() + 
        #facet_wrap(vars(state_id), scales = "free_y", ncol= n)+
        #geom_point()+
        new_scale_color()+
        scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+    
        scale_x_continuous(breaks = seq(1995, 2015, by =5), limits = c(1995, 2018))+
        scale_y_continuous(labels = function(x) sprintf("%.2f", x))+
        labs(x="", y="", title = paste0(state_chosen))+
        theme(
          panel.border = element_blank(),
          legend.position = "top", 
          panel.background = element_blank(),
          axis.ticks.x = element_blank(), 
          axis.text.x=element_blank(),
          text = element_text(family="Helvetica",size = 13), 
          legend.title = element_blank(),
          strip.background = element_blank(), 
          legend.key = element_blank())
    }else{
      p <- 
        dt %>% 
        ggplot(aes(x=year, y=tons_pc), color = ut_colors[4])+geom_line() + 
        #facet_wrap(vars(state_id), scales = "free_y", ncol= n)+
        #geom_point()+
        new_scale_color()+
        scale_color_manual(values=c("goldenrod", "firebrick"), na.translate = FALSE)+    
        scale_x_continuous(breaks = seq(1995, 2015, by =5), limits = c(1995, 2018))+
        scale_y_continuous(labels = function(x) sprintf("%.2f", x))+
        labs(x="", y="", title = paste0(state_chosen))+
        theme(
          panel.border = element_blank(),
          legend.position = "none", 
          panel.background = element_blank(),
          #axis.ticks.x = element_blank(), 
          #axis.text.x=element_blank(),
          text = element_text(family="Helvetica",size = 13), 
          legend.title = element_blank(),
          strip.background = element_blank(), 
          legend.key = element_blank())
    }
  }
  
  return(p)
  
}

dot_type_chosen <-1 
p1 <- plot_treated("disposal", "CA", dot_type_chosen)
p2 <- plot_treated("disposal", "MA", dot_type_chosen)
p3 <- plot_treated("disposal", "VT", dot_type_chosen)
p4 <- plot_treated("disposal", "CT", dot_type_chosen)
p5 <- plot_treated("disposal", "RI", dot_type_chosen)
p6 <- plot_treated("disposal", "Boulder", dot_type_chosen)
p7 <- plot_treated("disposal", "Seattle", dot_type_chosen)
p8 <- plot_treated("disposal", "San Francisco", dot_type_chosen)
p9 <- plot_treated("disposal", "", dot_type_chosen)
p10 <- plot_treated("disposal", " ", dot_type_chosen)


top_row <- ggpubr::ggarrange(p1,p2,p3, p4, p5, common.legend = TRUE, nrow=1, widths = rep(1,5))
bottom_row <- ggpubr::ggarrange(p6, p7, p8, p9, p10, nrow=1, widths = rep(0.6,3))
plot_treated_v2 <-ggpubr::ggarrange(top_row, bottom_row, ncol=1, heights = c(1.2,1), common.legend = TRUE)
plot_treated_v2 <- ggpubr::annotate_figure(plot_treated_v2, left = ggpubr::text_grob(TeX("MSW Tons Per Capita"), family= "Helvetica", rot = 90))
plot_treated_v2

ggsave(plot_treated_v2, filename = "data_availability_treated_only2.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 7, dpi=320, units = "in")

dot_type_chosen <-0 
p1 <- plot_treated("disposal", "CA", dot_type_chosen)
p2 <- plot_treated("disposal", "MA", dot_type_chosen)
p3 <- plot_treated("disposal", "VT", dot_type_chosen)
p4 <- plot_treated("disposal", "CT", dot_type_chosen)
p5 <- plot_treated("disposal", "RI", dot_type_chosen)
p6 <- plot_treated("disposal", "Boulder", dot_type_chosen)
p7 <- plot_treated("disposal", "Seattle", dot_type_chosen)
p8 <- plot_treated("disposal", "San Francisco", dot_type_chosen)
p9 <- plot_treated("disposal", "", dot_type_chosen)
p10 <- plot_treated("disposal", " ", dot_type_chosen)


top_row <- ggpubr::ggarrange(p1,p2,p3, p4, p5, common.legend = TRUE, nrow=1, widths = rep(1,5))
bottom_row <- ggpubr::ggarrange(p6, p7, p8, p9, p10, nrow=1, widths = rep(0.6,3))
plot_treated_v2 <-ggpubr::ggarrange(top_row, bottom_row, ncol=1, heights = c(1,1), common.legend = TRUE)
plot_treated_v2 <- ggpubr::annotate_figure(plot_treated_v2, left = ggpubr::text_grob(TeX("MSW Tons Per Capita"), family= "Helvetica", rot = 90))
plot_treated_v2

ggsave(plot_treated_v2, filename = "data_availability_treated_only.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 7, dpi=320, units = "in")


dot_type_chosen <-1 
p3 <- plot_treated("composting", "VT", dot_type_chosen)
p4 <- plot_treated("composting", "CT", dot_type_chosen)
p6 <- plot_treated("composting", "Boulder", dot_type_chosen)
p7 <- plot_treated("composting", "Seattle", dot_type_chosen)


top_row <- ggpubr::ggarrange(p3, p4, common.legend = TRUE, nrow=1, widths = rep(1,5))
bottom_row <- ggpubr::ggarrange(p6, p7, nrow=1, widths = rep(0.6,3))
plot_treated_v2 <-ggpubr::ggarrange(top_row, bottom_row, ncol=1, heights = c(1.2,1), common.legend = TRUE)
plot_treated_v2 <- ggpubr::annotate_figure(plot_treated_v2, left = ggpubr::text_grob(TeX("Composting Tons Per Capita"), family= "Helvetica", rot = 90))
plot_treated_v2

ggsave(plot_treated_v2, filename = "data_availability_treated_only_composting2.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 5, dpi=320, units = "in")

dot_type_chosen <-0 
p3 <- plot_treated("composting", "VT", dot_type_chosen)
p4 <- plot_treated("composting", "CT", dot_type_chosen)
p6 <- plot_treated("composting", "Boulder", dot_type_chosen)
p7 <- plot_treated("composting", "Seattle", dot_type_chosen)

top_row <- ggpubr::ggarrange(p3, p4, common.legend = TRUE, nrow=1, widths = rep(1,5))
bottom_row <- ggpubr::ggarrange(p6, p7, nrow=1, widths = rep(0.6,3))
plot_treated_v2 <-ggpubr::ggarrange(top_row, bottom_row, ncol=1, heights = c(1,1), common.legend = TRUE)
plot_treated_v2 <- ggpubr::annotate_figure(plot_treated_v2, left = ggpubr::text_grob(TeX("Composting Tons Per Capita"), family= "Helvetica", rot = 90))
plot_treated_v2

ggsave(plot_treated_v2, filename = "data_availability_treated_only_comsosting.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 5, dpi=320, units = "in")

```



## Table 1: Data Availability

```{r, eval=FALSE}
install.packages("xtable")
library(xtable)
  
reporting_level <- 
  power2 %>% 
  mutate(
    level = ifelse(is.na(county_name), "Facility", "County")
  ) %>% 
  filter(
    type == "disposal"
  )%>%
  group_by(
    state_id
  ) %>% 
  summarize(Level = unique(level)) %>% 
  arrange(state_id) 


dt %>% 
  filter(
    !is.na(tons_pc), 
    type %in% c("disposal","recycling", "composting"), 
    tons_pc > 0
    ) %>%
  group_by (state_id, type) %>% 
  summarize(
    min_year = min(year), 
    max_year = max(year)) %>%
  mutate(
    period = paste0(min_year, "-", max_year)) %>% 
  dplyr::select(state_id, type, period) %>%
  left_join(
    reporting_level, by =c("state_id")
  ) %>% 
  pivot_wider (
    names_from = type, 
    values_from = period) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    )%>% as_tibble, 
    by = c("state_id")
  ) %>% 
  ungroup %>%
  select(
    state_name,Level, disposal, composting, recycling
  ) %>% 
  rename(
    State = state_name,
    Reporting_Level = Level,
    Disposal = disposal, 
    Composting = composting, 
    Recycling = recycling
  ) %>%
  {
    print(xtable(.), include.rownames=FALSE)
  }

remove.packages("xtable")
```


## Figure 1: Maps

### a. Disposal

```{r, echo=FALSE, fig.width=7, fig.height=4}
state_us <- map_data("state")
state_us$id <- state_us$region
state_us <- state_us[ ,-6]
names(state_us)[6] <- 'id'
colnames(state_us)<- c("long", "lat", "group", "order", "state", "id")

map_dt <- 
  dt %>% 
  filter(
    !is.na(tons_pc), 
    type %in% c("disposal","recycling", "composting")
  ) %>%
  group_by (state_id, type) %>% 
  summarize(
    min_year = min(year), 
    max_year = max(year)) %>%
  dplyr::select(state_id, type, min_year, max_year) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    )%>% as_tibble, 
    by = c("state_id")) %>% 
  mutate(
    state_name = str_to_lower(state_name)
  ) %>% 
  filter(
    type == "disposal"
  ) %>%
  ungroup %>% 
  dplyr::select(
    state_name, min_year, max_year
  ) %>% 
  rename(
    id = state_name
  ) %>% 
  right_join(
    state_us, 
    by =c("id")
  ) %>% 
  expand_grid(
    year = c(2000, 2005, 2010, 2018)
  ) %>% 
  mutate (
    reports = ifelse(year >= min_year, 1, 0) * ifelse(year <= max_year, 1, 0),
    reports = ifelse(is.na(reports), 0, reports),
    reports = ifelse(reports==1, "Yes", "No")
  ) %>% 
  left_join (
    population %>%
      group_by (state_id, year) %>% 
      summarise(state_pop = sum(pop, na.rm = TRUE)) %>% 
      left_join(
        cbind (
          state_id = state.abb, 
          state_name = state.name
        )%>% as_tibble, 
        by = c("state_id")) %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ) %>% 
      rename(
        id =state_name
      ), 
    by = c("id", "year")
  )
  

pop_coverage <- 
  map_dt %>% 
  filter(reports =="Yes") %>% 
  group_by (year, state_id) %>% 
  summarise(state_pop= unique(state_pop)) %>% 
  ungroup %>% 
  group_by (year) %>% 
  summarise(covered = sum(state_pop)) %>% 
  left_join (
    population %>% 
      filter (!state_id %in% c("AK", "HI", "DC")) %>% 
      group_by (year) %>% 
      summarize(total_pop= sum(pop, na.rm = TRUE)), 
    by = c("year")
  ) %>% 
  mutate(
    coverage = (covered/total_pop) %>% round(3) *100 ,
    coverage = paste0 (coverage %>% as.character, "%"), 
    id = "arizona"
  )


map_plot <- 
  map_dt %>%
  ggplot(aes(map_id = id))+
  geom_map(aes(fill = as.factor(reports)), color="grey80", map = state_us) + 
  expand_limits(x = state_us$long, y = state_us$lat)  + 
  scale_fill_manual(values=c("grey90", "grey40"))+
  labs(x = "", y = "", fill = "Reports")+
  coord_map()+
  facet_grid(cols=vars(year))+
  geom_text(
    data = pop_coverage,
    mapping = aes(label = coverage, y= 27, x=-113), 
    size =6
  )+
  theme(
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    legend.text=element_text(size=16),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(size = 16)
    ) 

map_plot
# ggsave(
#   "map_plot.jpeg", map_plot,
#   path= figure_path,
#   height = 4, width = 15, dpi = 320)



```

### b. Composting

```{r, echo=FALSE, fig.width=7, fig.height=4}
state_us <- map_data("state")
state_us$id <- state_us$region
state_us <- state_us[ ,-6]
names(state_us)[6] <- 'id'
colnames(state_us)<- c("long", "lat", "group", "order", "state", "id")

map_dt <- 
  dt %>% 
  filter(
    !is.na(tons_pc), 
    type %in% c("disposal","recycling", "composting")
  ) %>%
  group_by (state_id, type) %>% 
  summarize(
    min_year = min(year), 
    max_year = max(year)) %>%
  dplyr::select(state_id, type, min_year, max_year) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    )%>% as_tibble, 
    by = c("state_id")) %>% 
  mutate(
    state_name = str_to_lower(state_name)
  ) %>% 
  filter(
    type == "composting"
  ) %>%
  ungroup %>% 
  dplyr::select(
    state_name, min_year, max_year
  ) %>% 
  rename(
    id = state_name
  ) %>% 
  right_join(
    state_us, 
    by =c("id")
  ) %>% 
  expand_grid(
    year = c(2000, 2005, 2010, 2018)
  ) %>% 
  mutate (
    reports = ifelse(year >= min_year, 1, 0) * ifelse(year <= max_year, 1, 0),
    reports = ifelse(is.na(reports), 0, reports),
    reports = ifelse(reports==1, "Yes", "No")
  ) %>% 
  left_join (
    population %>%
      group_by (state_id, year) %>% 
      summarise(state_pop = sum(pop, na.rm = TRUE)) %>% 
      left_join(
        cbind (
          state_id = state.abb, 
          state_name = state.name
        )%>% as_tibble, 
        by = c("state_id")) %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ) %>% 
      rename(
        id =state_name
      ), 
    by = c("id", "year")
  )
  

pop_coverage <- 
  map_dt %>% 
  filter(reports =="Yes") %>% 
  group_by (year, state_id) %>% 
  summarise(state_pop= unique(state_pop)) %>% 
  ungroup %>% 
  group_by (year) %>% 
  summarise(covered = sum(state_pop)) %>% 
  left_join (
    population %>% 
      filter (!state_id %in% c("AK", "HI", "DC")) %>% 
      group_by (year) %>% 
      summarize(total_pop= sum(pop, na.rm = TRUE)), 
    by = c("year")
  ) %>% 
  mutate(
    coverage = (covered/total_pop) %>% round(3) *100 ,
    coverage = paste0 (coverage %>% as.character, "%"), 
    id = "arizona"
  )


map_plot <- map_dt %>%
  ggplot(aes(map_id = id))+
  geom_map(aes(fill = as.factor(reports)), color="grey80", map = state_us) + 
  expand_limits(x = state_us$long, y = state_us$lat)  + 
  scale_fill_manual(values=c("grey90", "grey40"))+
  labs(x = "", y = "", fill = "Reports")+
  coord_map()+
  facet_grid(cols=vars(year))+
  geom_text(
    data = pop_coverage,
    mapping = aes(label = coverage, y= 27, x=-113), 
    size =6
  )+
  theme(
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    legend.text=element_text(size=16),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(size = 16)
    ) 


ggsave("map_plot_composting.jpeg", map_plot, 
       path= figure_path, 
       height = 4, width = 15, dpi = 320)



```

### c. Together

```{r}

state_us <- map_data("state")
state_us$id <- state_us$region
state_us <- state_us[ ,-6]
names(state_us)[6] <- 'id'
colnames(state_us)<- c("long", "lat", "group", "order", "state", "id")

map_dt <- 
  dt %>% 
  filter(
    !is.na(tons_pc), 
    type %in% c("disposal","recycling", "composting")
  ) %>%
  group_by (state_id, type) %>% 
  summarize(
    min_year = min(year), 
    max_year = max(year)) %>%
  dplyr::select(state_id, type, min_year, max_year) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    )%>% as_tibble, 
    by = c("state_id")) %>% 
  mutate(
    state_name = str_to_lower(state_name)
  ) %>% 
  filter(
    type %in% c("disposal", "composting")
  ) %>%
  ungroup %>% 
  dplyr::select(
    state_name, min_year, max_year, type
  ) %>% 
  rename(
    id = state_name
  ) 


map_dt <- 
  map_dt %>%
  filter(type=="composting") %>% 
  right_join(
    state_us, 
    by =c("id")
  ) %>% 
  expand_grid(
    year = c(1996, 2000, 2005, 2010,2018)
  ) %>% 
  mutate (
    reports = ifelse(year >= min_year, 1, 0) * ifelse(year <= max_year, 1, 0),
    reports = ifelse(is.na(reports), 0, reports),
    reports = ifelse(reports==1, "Yes", "No"), 
    type ="composting"
  ) %>%
  rbind(
    map_dt %>%
      filter(type=="disposal") %>% 
      right_join(
        state_us, 
        by =c("id")
      ) %>% 
      expand_grid(
        year = c(1996, 2000, 2005, 2010, 2018)
      ) %>% 
      mutate (
        reports = ifelse(year >= min_year, 1, 0) * ifelse(year <= max_year, 1, 0),
        reports = ifelse(is.na(reports), 0, reports),
        reports = ifelse(reports==1, "Yes", "No"), 
        type="disposal"
      ) 
  ) %>% left_join (
    population %>%
      group_by (state_id, year) %>% 
      summarise(state_pop = sum(pop, na.rm = TRUE)) %>% 
      left_join(
        cbind (
          state_id = state.abb, 
          state_name = state.name
        )%>% as_tibble, 
        by = c("state_id")) %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ) %>% 
      rename(
        id =state_name
      ), 
    by = c("id", "year")
  ) 

pop_coverage <- 
  map_dt %>% 
  filter(reports =="Yes") %>% 
  group_by (year, state_id, type) %>% 
  summarise(state_pop= unique(state_pop)) %>% 
  ungroup %>% 
  group_by (year, type) %>% 
  summarise(covered = sum(state_pop)) %>% 
  left_join(
    population %>% 
      filter(state_id == "NY", county_name %in% c("kings", "new york county", "queens", "richmond", "bronx")) %>% 
      group_by(year) %>%  summarise(nyc_pop = sum(pop)) %>% select(year, nyc_pop), 
    by = "year"
  ) %>%
  mutate(
    covered = ifelse(year>=2010 & type == "disposal", covered-nyc_pop, covered)
  ) %>% 
  select(-nyc_pop) %>% 
  left_join (
    population %>% 
      filter (!state_id %in% c("AK", "HI", "DC")) %>% 
      group_by (year) %>% 
      summarize(total_pop= sum(pop, na.rm = TRUE)), 
    by = c("year")
  ) %>% 
  mutate(
    coverage = (covered/total_pop) %>% round(3) *100 ,
    coverage = paste0 (coverage %>% as.character, "%"), 
    id = "arizona", 
    type = ifelse(type=="disposal", "Disposal", "Composting"), 
    type = factor(type, levels = c("Disposal", "Composting"))
  ) 


col <- ut_colors[4]# For text
#col <- "royalblue4" #For presentation 

map_plot <- 
  map_dt %>%
  mutate(
    type = ifelse(type=="disposal", "Disposal", "Composting"), 
    type = factor(type, levels = c("Disposal", "Composting")), 
  ) %>% 
  ggplot(aes(map_id = id))+
  geom_map(aes(fill = as.factor(reports)), color="grey80", map = state_us) + 
  expand_limits(x = state_us$long, y = state_us$lat)  + 
  scale_fill_manual(values=c("grey90", col))+
  labs(x = "", y = "", fill = "Reports")+
  coord_map()+
  facet_grid(
    cols=vars(year), 
    rows = vars(type), 
    switch = 'y')+
  geom_text(
    data = pop_coverage,
    mapping = aes(label = coverage, y= 27, x=-113), 
    size =5, 
    family = "Helvetica"
  )+
  theme(
    panel.border = element_blank(),
    legend.position = "top",
    #legend.position = "right",
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.text=element_text(size=16),
    strip.background = element_blank(), 
    panel.spacing = unit(2, "lines")
  ) 

 
# #For text
ggsave(map_plot, filename = "map_plot.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 5, dpi=320, units = "in")

# # For presentation
# ggsave(map_plot, filename = "map_plot_presentation.pdf", device = cairo_pdf,
#        path= figure_path,
#        width = 15, height = 5, dpi=320, units = "in")


map_plot <- 
  map_dt %>% filter(type == "disposal") %>% 
  ggplot(aes(map_id = id))+
  geom_map(aes(fill = as.factor(reports)), color="grey80", map = state_us) + 
  expand_limits(x = state_us$long, y = state_us$lat)  + 
  scale_fill_manual(values=c("grey90", col))+
  labs(x = "", y = "", fill = "Reports")+
  coord_map()+
  facet_grid(
    cols=vars(year), 
    switch = 'y')+
  geom_text(
    data = pop_coverage %>% filter(type == "Disposal"),
    mapping = aes(label = coverage, y= 27, x=-113), 
    size =5, 
    family = "Helvetica"
  )+
  theme(
    panel.border = element_blank(),
    legend.position = "top",
    #legend.position = "right",
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.text=element_text(size=16),
    strip.background = element_blank(), 
    panel.spacing = unit(2, "lines")
  ) 

ggsave(map_plot, filename = "map_plot_pres.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 3, dpi=320, units = "in")
```



### d. County Level

```{r}
year1 <- 2010
year2 <- 2018
year3 <- 2015
state_us <- map_data("state")


county_us <- 
  map_data("county") %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")
  ) %>% as_tibble() %>% expand_grid(year = c(year1,year2, year3)) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(year1, year2, year3), !is.na(county_name), type == "disposal") %>% 
      left_join(population, by = c("year", "county_name", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>% 
      select(county_name, tons_pc, state_id, year),
    by = c("state_id", "year", "subregion" = "county_name")
  ) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(year1, year2, year3), is.na(county_name), type == "disposal") %>% 
      left_join(population %>% group_by (state_id, year) %>% summarise(pop = sum(pop)), by = c("year", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>%
      select(tons_pc, state_id, year),
    by = c("state_id", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(tons_pc.x) & !is.na(tons_pc.y), tons_pc.y, NA),
    tons_pc = ifelse(!is.na(tons_pc.x) & is.na(tons_pc.y), tons_pc.x, tons_pc)
  ) %>% 
  select(long, lat, group, order, region, subregion, state_id, tons_pc, year) %>% 
  mutate(
   tons_pc_frac = factor(
     ifelse(tons_pc >= 1.5, ">1.5", 
            ifelse(tons_pc >= 1, "1-1.5", 
                   ifelse(tons_pc >= 0.75, "0.75-1",
                   ifelse(tons_pc >= 0.5, "0.5-0.75", "< 0.5")))),
     levels = c("< 0.5", "0.5-0.75", "0.75-1", "1-1.5", ">1.5"))
  )


map_plot_county1 <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(year1, year2)), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  scale_fill_manual(
    values =c(
      ">1.5" = "#27408B", 
      "1-1.5" = "#5669A1", 
      "0.75-1" ="#8692B8",
      "0.5-0.75" = "#B5BBCE", 
      "< 0.5" ="#E5E5E5"),
    na.value = "grey100" )+
  labs (x="", y="", fill = "Tons Per Capita")+
  facet_grid(cols= vars(year))+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  geom_path(
    data =   state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")), 
    aes(x = long, y = lat, group = group), 
    color = ut_colors[3], 
    linewidth= 0.5
  )+
  theme(
    panel.border = element_blank(),
    legend.position = "right", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family="Helvetica"), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines") 
  ) 

map_plot_county1

png(paste0(figure_path, "/map_plot_county_MT.png"), bg = "transparent", width = 13, height = 4, units = "in", res=300)
print(map_plot_county1)
dev.off()
  
sum_stats <- 
  dt %>% filter(type=="disposal", year == year3) %>% 
  group_by(year) %>% 
  summarise(
    mean = mean(tons_pc) %>% round(2),
    min = min(tons_pc)%>% round(2), 
    max = max(tons_pc)%>% round(2), 
    sd = sd(tons_pc)%>% round(2)
  )

# sum_stats <- 
#   power2 %>% filter(type=="disposal", year == year3, !is.na(county_name)) %>% 
#   left_join(population, by= c("year", "state_id", "county_name")) %>%
#   mutate(tons_pc=tons/pop) %>% 
#   filter(!is.na(tons_pc), tons_pc > 0.09) %>% 
#   group_by(year) %>% 
#   summarise(
#     mean = mean(tons_pc) %>% round(2),
#     min = min(tons_pc)%>% round(2), 
#     max = max(tons_pc)%>% round(2), 
#     sd = sd(tons_pc)%>% round(2)
#   )


transparent_color <- rgb(0, 0, 0, alpha = 0)

map_plot_county <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year == year3), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  scale_fill_manual(
    values =c(
      ">1.5" = "#27408B", 
      "1-1.5" = "#5669A1", 
      "0.75-1" ="#8692B8",
      "0.5-0.75" = "#B5BBCE", 
      "< 0.5" ="#E5E5E5"),
    na.value = "grey100" )+
  labs (x="", y="", fill = "Tons Per Capita")+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  # geom_path(
  #   data =   state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")),
  #   aes(x = long, y = lat, group = group),
  #   color = ut_colors[3],
  #   linewidth= 1
  # )+
  #annotate("text", x=-119.1, y=30, label ="Summary Statistics", color=plotCol[1], size=6)+
  annotate("text", x=-121.7, y=29, label = paste0("Mean: ",sum_stats %>% pluck("mean")), color="black", size=6)+
  annotate("text", x=-122.4, y=27.5, label = paste0("Min: ",sum_stats %>% pluck("min")), color="black", size=6)+
  annotate("text", x=-122.2, y=26, label = paste0("Max: ",sum_stats %>% pluck("max")), color="black", size=6)+
  annotate("text", x=-121.2, y=24.5, label = paste0("St. Dev: ",sum_stats %>% pluck("sd")), color="black", size=6)+
  theme(
    panel.border = element_blank(),
    legend.position = "right", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family="Helvetica"), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines"),panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_blank()
  ) 

map_plot_county

# png(paste0(figure_path, "/map_plot_county_borders.png"), bg = "transparent", width = 12, height = 6, units = "in", res=300)
# print(map_plot_county)
# dev.off()

png(paste0(figure_path, "/map_plot_county.png"), bg = "transparent", width = 12, height = 6, units = "in", res=300)
print(map_plot_county)
dev.off()
```



### d1. County Level Science (only 2018)


```{r}
year1 <- 2018
year2 <- 2019
year3 <- 2015
state_us <- map_data("state")


avg_disp <- 
  power2 %>% 
  filter(type=="disposal") %>% 
  group_by(state_id, year) %>% 
  summarise(tons=sum(tons)) %>% 
  left_join(
    population %>% group_by(state_id, year) %>% summarise(pop=sum(pop)), 
    by =  c("state_id", "year")) %>% 
  filter(year %in% c(year1, year2, year3)) %>% 
  group_by(year) %>% 
  summarise(avg = sum(tons)/ sum(pop))
  

county_us <- 
  map_data("county") %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")
  ) %>% as_tibble() %>% expand_grid(year = c(seq(year1,year2))) %>% 
  left_join(
    power2 %>% 
      filter(year %in%c(seq(year1,year2)), !is.na(county_name), type == "disposal") %>% 
      left_join(population, by = c("year", "county_name", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>% 
      select(county_name, tons_pc, state_id, year),
    by = c("state_id", "year", "subregion" = "county_name")
  ) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(seq(year1,year2)), is.na(county_name), type == "disposal") %>% 
      left_join(population %>% group_by (state_id, year) %>% summarise(pop = sum(pop)), by = c("year", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>%
      select(tons_pc, state_id, year),
    by = c("state_id", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(tons_pc.x) & !is.na(tons_pc.y), tons_pc.y, NA),
    tons_pc = ifelse(!is.na(tons_pc.x) & is.na(tons_pc.y), tons_pc.x, tons_pc)
  ) %>% 
  select(long, lat, group, order, region, subregion, state_id, tons_pc, year) %>% 
  mutate(
    tons_pc_frac = factor(
      ifelse(is.na(tons_pc), "No data",
             ifelse(tons_pc >= 1.1, ">1.1", 
                    ifelse(tons_pc >= 0.9, "0.9-1.1", 
                           ifelse(tons_pc >= 0.7, "0.7-0.9",
                                  ifelse(tons_pc >= 0.5, "0.5-0.7", "< 0.5"))))),
      levels = c("No data", "< 0.5", "0.5-0.7", "0.7-0.9", "0.9-1.1", ">1.1"))
  )

pop_coverage <- 
  county_us %>% 
  filter(!is.na(tons_pc)) %>% 
  group_by(year, region, tons_pc) %>% 
  summarise(subregion=unique(subregion)) %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")) %>% 
  left_join(
    population %>% 
      group_by(year) %>% mutate(total_pop = sum(pop, na.rm=TRUE)), 
    by = c("state_id", "subregion"= "county_name", "year")) %>% 
  group_by(year) %>% 
  summarise(
    pop = 100*sum(pop/total_pop, na.rm=TRUE) %>% round(2)
  ) %>% 
  mutate(
    pop = paste0(pop, "%"), 
    pop= ifelse(year==min(year), paste0("Population coverage: ", pop), pop),
    label_x = ifelse(year==min(year), -115, -112),
    label_y = 28 
  ) %>% 
  rbind(
    avg_disp %>% 
      mutate(
        pop = paste0("Mean disposal: ", round(avg, 2)), 
        label_x = -115, 
        label_y = 26.5
      ) %>% 
      select(-avg)
  )


borders  =c(
      ">1.1" = "#27408B",
      "0.9-1.1" = "#5669A1",
      "0.7-0.9" ="#8692B8",
      "0.5-0.7" = "#B5BBCE",
      "< 0.5" ="#E5E5E5",
      "No data" = "white")

borders  =c(
      ">1.1" = "#8c8c8c",
      "0.9-1.1" = "#a3a3a3",
      "0.7-0.9" ="#c0c0c0",
      "0.5-0.7" = "#d0d0d0",
      "< 0.5" ="#e0e0e0",
      "No data" = "white")



sum_stats <- 
  dt %>% filter(type=="disposal", year %in% c(year1, year2)) %>% 
  group_by(year) %>% 
  summarise(
    mean = mean(tons_pc) %>% round(2),
    min = min(tons_pc)%>% round(2),
    max = max(tons_pc)%>% round(2),
    sd = sd(tons_pc)%>% round(2),
  ) %>% 
  rename (
    Mean = mean, Min = min, Max=max, `St. Dev`=sd
  ) %>% 
  pivot_longer(cols = c("Mean", "Min", "Max", "St. Dev")) %>%
  left_join(
    tibble (
      xlab = rep(-122, 4),
      ylab = c(30, 29, 28, 27),
      name = c("Mean", "Min", "Max", "St. Dev")
    ), by = c("name")
  ) %>%
  mutate(
    label = paste0(name , ": ", value)
  )



transparent_color <- rgb(0, 0, 0, alpha = 0)

map_plot_county <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(seq(year1,year2, by=2))), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  
  scale_fill_manual(
    values =c(
      ">1.1" = "#8c8c8c", 
      "0.9-1.1" = "#a3a3a3", 
      "0.7-0.9" ="#c0c0c0",
      "0.5-0.7" = "#d0d0d0", 
      "< 0.5" ="#e0e0e0",
      "No data" = "white"), 
    guide = guide_legend(override.aes = list(colour = c("black", "black", "black", "black", "black", "black"))))+
  guides(fill = guide_legend(nrow = 1, override.aes = list(colour = borders)))+
  labs (x="", y="", fill = "Disposal (tons per capita)")+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = ut_colors[4], 
    linewidth= 0.5
  )+
  #ggnewscale::new_scale_color()+
  #facet_wrap(vars(year), ncol=2)+
  theme(
    panel.border = element_blank(),
    legend.position = "top", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #text = element_text(size=25, element_text(family="Helvetica")), 
    strip.background = element_blank(), 
    #legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines"),panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_blank(), 
    text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
    legend.text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
    
  ) 


# 
# map_plot_county <- 
#   map_plot_county+
#   geom_path(
#     data = 
#       state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")) %>% 
#       expand_grid(year = c(seq(year1,year2))) %>% 
#       left_join(
#         tibble(
#           region = c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey"), 
#           ban_year = c(2014, 2014, 2014, 2016, 2022, 2023, 2016, 2024, 2021)
#         )) %>% filter(year %in% c(seq(year1,year2, by =2))) %>% 
#       mutate(ban = ifelse(year>=ban_year, 1, 0)) %>% filter(ban==1),
#       #mutate(ban = ifelse(is.na(ban_year), 0, 1)) %>% filter (ban==1),
#     aes(x = long, y = lat, group = group),
#     color="#417c5b",
#     linewidth= 1
#   )+
#   #scale_color_manual(values="#417c5b", name="")+
#   #labs(x="", y="",color="" )+
#   geom_text(
#     data=pop_coverage %>% filter(year %in% c(seq(year1, year2, by =2))), 
#     family = "Helvetica", color = ut_colors[4], size=4,
#     aes(x=label_x, y=label_y, label = pop), family = "Helvetica", color = ut_colors[4])+
#   geom_line(
#     data = tibble(x=seq(-124, -122), y=52, year = year1), aes(x=x, y=y), color = "#417c5b", linewidth=1.5)+
#   geom_text(
#     data = tibble(x=-118, y=52, year = year1, lab = "Treated"), aes(x=x, y=y, label=lab), family = "Helvetica", color = ut_colors[4], size=4)+
#   theme(
#     text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
#     strip.text = element_text(vjust=0, size=12, family="Helvetica", color = ut_colors[4]))+
#   coord_map()


map_plot_county <-
  map_plot_county+
  geom_path(
    data = 
      state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")) %>% 
      expand_grid(year = c(seq(year1,year2))) %>% 
      left_join(
        tibble(
          region = c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey"), 
          ban_year = c(2014, 2014, 2014, 2016, 2022, 2023, 2016, 2024, 2021)
        )) %>% filter(year %in% c(seq(year1,year2, by =2))) %>% 
      mutate(ban = ifelse(ban_year < 2017, "In panel", "Out of panel")),
    aes(x = long, y = lat, group = group, color = ban),
    linewidth= 1.5
  )+
  scale_color_manual(values=c("#2c6846", "#8fbc8f"), guide = guide_legend(order = 2, legend.spacing.x=unit(-1, "cm"), vjust=1.5 ))+
  labs(color="")+
  geom_text(
    data=pop_coverage %>% filter(year %in% c(seq(year1, year2, by =2))), 
    family = "Helvetica", color = ut_colors[4], size=4,
    aes(x=label_x, y=label_y, label = pop), family = "Helvetica", color = ut_colors[4])+
  theme(
    text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
    strip.text = element_text(vjust=0, size=12, family="Helvetica", color = ut_colors[4]),
    legend.key = element_blank()
  )+
  coord_map()



map_plot_county <-
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(seq(year1,year2, by=2))), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = ut_colors[4], 
    linewidth= 0.5
  )+
  
  geom_path(
    data = 
      state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")) %>% 
      expand_grid(year = c(seq(year1,year2))) %>% 
      left_join(
        tibble(
          region = c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey"), 
          ban_year = c(2014, 2014, 2014, 2016, 2022, 2023, 2016, 2024, 2021)
        )) %>% filter(year %in% c(seq(year1,year2, by =2))) %>% 
      filter(ban_year <2017) %>% 
      mutate(ban = ifelse(ban_year < 2017, "Treated", "Out of panel")
      ),
    aes(x = long, y = lat, group = group, color = ban),
    linewidth= 1.5
  )+
  #scale_color_manual(values=c("seagreen", "#734e6c"), guide = guide_legend(order = 2, legend.spacing.x=unit(-1, "cm"), vjust=1.5 ))+
  scale_color_manual(values=c("seagreen", "#734e6c"), guide = guide_legend(order = 2, legend.spacing.x=unit(-1, "cm"), vjust=1.5))+
  scale_fill_manual(
    values =c(
      ">1.1" = "#8c8c8c", 
      "0.9-1.1" = "#a3a3a3", 
      "0.7-0.9" ="#c0c0c0",
      "0.5-0.7" = "#d0d0d0", 
      "< 0.5" ="#e0e0e0",
      "No data" = "white"
    ), 
    guide = guide_legend(override.aes = list(colour = c("black", "black", "black", "black", "black", "black"))))+
  guides(
    fill = guide_legend(nrow = 1, override.aes = list(colour = borders), order =1), 
    color = guide_legend(nrow=1, title.position = "bottom", title.hjust = 0.5, order = 2))+
  labs (x="", y="", fill = "Disposal (tons per capita)")+
  labs(color="")+
  geom_text(
    data=pop_coverage %>% filter(year %in% c(seq(year1, year2, by =2))), 
    family = "Helvetica", color = ut_colors[4], size=4,
    aes(x=label_x, y=label_y, label = pop), family = "Helvetica", color = ut_colors[4])+
  theme(
    panel.border = element_blank(),
    legend.position = "top", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #text = element_text(size=25, element_text(family="Helvetica")), 
    strip.background = element_blank(), 
    #legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines"),panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_blank(), 
    text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
    legend.text = element_text(size=12, family="Helvetica", color = ut_colors[4]),
    legend.key = element_blank(), 
    legend.box = "vertical", # Stacks legends vertically
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"),  # Adjust the space around the entire set of legends
    legend.box.spacing = unit(0, "lines") 
  )

# png(paste0(figure_path, "/map_plot_county_borders.png"), bg = "transparent", width = 12, height = 6, units = "in", res=300)
# print(map_plot_county)
# dev.off()

png(paste0(figure_path, "/map_plot_county_SC_only2018_alt2.png"), bg = "transparent", width = 11, height = 7, units = "in", res=1200)
print(map_plot_county)
dev.off()
```

### d1. Same plot but curved

```{r}


map_plot_county <- 
  ggplot()+
  geom_polygon(
    data = 
      us_map(regions = "counties",  exclude = c("HI", "AK")) %>% as_tibble() %>% 
      mutate(
        county = str_to_lower(county), 
        county = str_replace_all(county, " county", ""), 
        county = str_replace_all(county, " ", ""), 
        county = str_replace_all(county, "o'", "o"), 
        county = ifelse(county=="ste.genevieve", "stegenevieve", county)
      ) %>% 
      left_join(
        county_us %>% 
          filter(year %in% year2) %>% 
          mutate(
            subregion = str_replace_all(subregion, "st ", "st. "),
            subregion = str_replace_all(subregion, " ", "")
          ) %>% 
          group_by(region, subregion) %>% 
          summarise(tons_pc_frac = unique(tons_pc_frac)) %>% 
          left_join(
            tibble(
              abbr= state.abb, 
              region = state.name
            ) %>% 
              mutate(region= str_to_lower(region)), 
            by = "region"
          ) %>% 
          select(subregion, tons_pc_frac, abbr), 
        by = c("county"= "subregion", "abbr")
      ), 
    aes(x = x, y = y, group = group, fill=tons_pc_frac), 
    linewidth= 0.5, 
  )+
  geom_path(
    data = us_map(regions = "states", exclude = c("HI", "AK")), 
    aes(x = x, y = y, group = group), 
    color = "#3f4040", 
    linewidth= 0.6
  )+
  geom_path(
    data = us_map(regions = "counties", exclude = c("HI", "AK")), 
    aes(x = x, y = y, group = group), 
    color = "#3f4040", 
    linewidth= 0.1
  )+
  geom_text(
    data=pop_coverage %>% 
      filter(year %in% c(seq(year1, year2, by =2))) %>% 
      mutate(label_x = label_x*10^4, label_y = -(label_y-10)*10^5), 
    family = "Helvetica", color = ut_colors[4], size=4,
    aes(x=label_x, y=label_y, label = pop), family = "Helvetica", color = ut_colors[4])+
  scale_fill_manual(
    values =c(
      ">1.1" = "#626767", 
      "0.9-1.1" = "#939797", 
      "0.7-0.9" ="#adb0b0",
        "0.5-0.7" = "#c8caca", 
      "< 0.5" ="#e3e4e4"),
    na.value = "grey100", guide = guide_legend(order = 1,  legend.spacing.x=unit(-1, "cm"), byrow=TRUE)) +
  coord_equal()+ 
  labs (x="", y="", fill = "Disposal (tons per capita)")+
  ggnewscale::new_scale_color()+
  geom_path(
    data = us_map(regions = "states", include = c("MA", "CT", "VT", "CA", "RI")), 
    aes(x = x, y = y, group = group, color = "Treated"), 
    linewidth= 1.5)+
  scale_color_manual(breaks = c("Treated"), values = c("seagreen"), guide = guide_legend(order = 2,  legend.spacing.x=unit(-1, "cm"), byrow=TRUE))+
  labs(colour = "")+
  theme(
    panel.border = element_blank(),
    legend.position = "top", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family = "Helvetica",size = 10, color= ut_colors[4]), 
    strip.background = element_blank(), 
    legend.title = element_text(size = 11, family = "Helvetica"),
    legend.text = element_text(size = 11, family = "Helvetica"),
    panel.spacing = unit(2, "lines"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_blank(), 
    legend.key = element_blank(), 
    legend.text.align = 0.5
    
  ) 


png(paste0(figure_path, "/map_plot_county_SC_only2018.png"), bg = "transparent", width = 10, height = 5, units = "in", res=1200)
print(map_plot_county)
dev.off()
```



### d2. County Level Science (more years)


```{r}
year1 <- 2008
year2 <- 2018
year3 <- 2015
state_us <- map_data("state")


county_us <- 
  map_data("county") %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")
  ) %>% as_tibble() %>% expand_grid(year = c(seq(year1,year2))) %>% 
  left_join(
    power2 %>% 
      filter(year %in%c(seq(year1,year2)), !is.na(county_name), type == "disposal") %>% 
      left_join(population, by = c("year", "county_name", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>% 
      select(county_name, tons_pc, state_id, year),
    by = c("state_id", "year", "subregion" = "county_name")
  ) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(seq(year1,year2)), is.na(county_name), type == "disposal") %>% 
      left_join(population %>% group_by (state_id, year) %>% summarise(pop = sum(pop)), by = c("year", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>%
      select(tons_pc, state_id, year),
    by = c("state_id", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(tons_pc.x) & !is.na(tons_pc.y), tons_pc.y, NA),
    tons_pc = ifelse(!is.na(tons_pc.x) & is.na(tons_pc.y), tons_pc.x, tons_pc)
  ) %>% 
  select(long, lat, group, order, region, subregion, state_id, tons_pc, year) %>% 
  mutate(
    tons_pc_frac = factor(
      ifelse(is.na(tons_pc), "No data",
             ifelse(tons_pc >= 1.1, ">1.1", 
                    ifelse(tons_pc >= 0.9, "0.9-1.1", 
                           ifelse(tons_pc >= 0.7, "0.7-0.9",
                                  ifelse(tons_pc >= 0.5, "0.5-0.7", "< 0.5"))))),
      levels = c("No data", "< 0.5", "0.5-0.7", "0.7-0.9", "0.9-1.1", ">1.1"))
  )


pop_coverage <- 
  county_us %>% 
  filter(!is.na(tons_pc)) %>% 
  group_by(year, region) %>% 
  summarise(subregion=unique(subregion)) %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")) %>% 
  left_join(
    population %>% 
      group_by(year) %>% mutate(total_pop = sum(pop, na.rm=TRUE)), 
    by = c("state_id", "subregion"= "county_name", "year")) %>% 
  group_by(year) %>% 
  summarise(
    pop = 100*sum(pop/total_pop, na.rm=TRUE) %>% round(2)
  ) %>% 
  mutate(
    pop = paste0(pop, "%"), 
    pop= ifelse(year==min(year), paste0("Population Coverage: ", pop), pop),
    label_x = ifelse(year==min(year), -115, -112),
    label_y = 28 
  )


map_plot_county1 <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(year1, year2)), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  scale_fill_manual(
    values =c(
      ">1.1" = "#707070", 
      "0.9-1.1" = "#a3a3a3", 
      "0.7-0.9" ="#c0c0c0",
      "0.5-0.7" = "#d0d0d0", 
      "< 0.5" ="#e0e0e0",
      "No data" = "grey100"), 
  )+
  guides(fill = guide_legend(nrow = 1, override.aes = list(colour = borders)))+
  labs (x="", y="", fill = "Tons Per Capita")+
  facet_grid(cols= vars(year))+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "grey70", 
    linewidth= 0.1
  )+
  geom_path(
    data =   state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")), 
    aes(x = long, y = lat, group = group), 
    color = ut_colors[3], 
    linewidth= 0.5
  )+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family="Helvetica"), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines") 
  ) 

map_plot_county1

# png(paste0(figure_path, "/map_plot_county_MT.png"), bg = "transparent", width = 13, height = 5, units = "in", res=300)
# print(map_plot_county1)
# dev.off()

sum_stats <- 
  dt %>% filter(type=="disposal", year %in% c(year1, year2)) %>% 
  group_by(year) %>% 
  summarise(
    mean = mean(tons_pc) %>% round(2),
    min = min(tons_pc)%>% round(2),
    max = max(tons_pc)%>% round(2),
    sd = sd(tons_pc)%>% round(2),
  ) %>% 
  rename (
    Mean = mean, Min = min, Max=max, `St. Dev`=sd
  ) %>% 
  pivot_longer(cols = c("Mean", "Min", "Max", "St. Dev")) %>%
  left_join(
    tibble (
      xlab = rep(-122, 4),
      ylab = c(30, 29, 28, 27),
      name = c("Mean", "Min", "Max", "St. Dev")
    ), by = c("name")
  ) %>%
  mutate(
    label = paste0(name , ": ", value)
  )



transparent_color <- rgb(0, 0, 0, alpha = 0)

map_plot_county <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(seq(year1,year2, by=2))), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  scale_fill_manual(
    values =c(
      ">1.1" = "#626767", 
      "0.9-1.1" = "#939797", 
      "0.7-0.9" ="#adb0b0",
      "0.5-0.7" = "#c8caca", 
      "< 0.5" ="#e3e4e4",
      "No data" = "grey100"), 
  )+
  guides(fill = guide_legend(nrow = 1, override.aes = list(colour = borders)))+
  labs (x="", y="", fill = "Disposal (tons per capita)")+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "#9aa0a0", 
    linewidth= 0.5
  )+
  #ggnewscale::new_scale_color()+
  facet_wrap(vars(year), ncol=2)+
  theme(
    panel.border = element_blank(),
    legend.position = "top", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #text = element_text(size=25, element_text(family="Helvetica")), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines"),panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_blank()
  ) 



map_plot_county <- 
  map_plot_county+
  geom_path(
    data = 
      state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")) %>% 
      expand_grid(year = c(seq(year1,year2))) %>% 
      left_join(
        tibble(
          region = c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey"), 
          ban_year = c(2014, 2014, 2014, 2016, 2022, 2023, 2016, 2024, 2021)
        )) %>% filter(year %in% c(seq(year1,year2, by =2))) %>% 
      mutate(ban = ifelse(year>=ban_year, 1, 0)) %>% filter(ban==1),
      #mutate(ban = ifelse(is.na(ban_year), 0, 1)) %>% filter (ban==1),
    aes(x = long, y = lat, group = group),
    color="#417c5b",
    linewidth= 1.5
  )+
  #scale_color_manual(values="#417c5b", name="")+
  #labs(x="", y="",color="" )+
  geom_text(
    data=pop_coverage %>% filter(year %in% c(seq(year1, year2, by =2))), 
    family = "Helvetica", color = ut_colors[4], size=5.5,
    aes(x=label_x, y=label_y, label = pop), family = "Helvetica", color = ut_colors[4])+
  geom_line(
    data = tibble(x=seq(-124, -122), y=52, year = year1), aes(x=x, y=y), color = "#417c5b", linewidth=2)+
  geom_text(
    data = tibble(x=-118, y=52, year = year1, lab = "Treated"), aes(x=x, y=y, label=lab), family = "Helvetica", color = ut_colors[4], size=5.5)+
  theme(
    text = element_text(size=19, family="Helvetica", color = ut_colors[4]),
    strip.text = element_text(vjust=0, size=17, family="Helvetica", color = ut_colors[4]))


# png(paste0(figure_path, "/map_plot_county_borders.png"), bg = "transparent", width = 12, height = 6, units = "in", res=300)
# print(map_plot_county)
# dev.off()

png(paste0(figure_path, "/map_plot_county_SC.png"), bg = "transparent", width = 15, height = 15, units = "in", res=300)
print(map_plot_county)
dev.off()
```


#### For presentation
```{r}
year1 <- 2010
year2 <- 2018
year3 <- 2015
state_us <- map_data("state")


county_us <- 
  map_data("county") %>% 
  left_join(
    tibble (
      state_name = state.name %>% tolower,
      state_id = state.abb
    ), 
    by = c("region" = "state_name")
  ) %>% as_tibble() %>% expand_grid(year = c(year1,year2, year3)) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(year1, year2, year3), !is.na(county_name), type == "disposal") %>% 
      left_join(population, by = c("year", "county_name", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>% 
      select(county_name, tons_pc, state_id, year),
    by = c("state_id", "year", "subregion" = "county_name")
  ) %>% 
  left_join(
    power2 %>% 
      filter(year %in% c(year1, year2, year3), is.na(county_name), type == "disposal") %>% 
      left_join(population %>% group_by (state_id, year) %>% summarise(pop = sum(pop)), by = c("year", "state_id")) %>% 
      mutate(tons_pc = tons/pop) %>%
      select(tons_pc, state_id, year),
    by = c("state_id", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(tons_pc.x) & !is.na(tons_pc.y), tons_pc.y, NA),
    tons_pc = ifelse(!is.na(tons_pc.x) & is.na(tons_pc.y), tons_pc.x, tons_pc)
  ) %>% 
  select(long, lat, group, order, region, subregion, state_id, tons_pc, year) %>% 
  mutate(
   tons_pc_frac = factor(
     ifelse(tons_pc >= 1.1, ">1.1", 
            ifelse(tons_pc >= 0.9, "0.9-1.1", 
                   ifelse(tons_pc >= 0.7, "0.7-0.9",
                   ifelse(tons_pc >= 0.5, "0.5-0.7", "< 0.5")))),
     levels = c("< 0.5", "0.5-0.7", "0.7-0.9", "0.9-1.1", ">1.1"))
  )

sum_stats <- 
  dt %>% filter(type=="disposal", year %in% c(year3)) %>% 
  group_by(year) %>% 
  summarise(
    mean = mean(tons_pc) %>% round(2),
    min = min(tons_pc)%>% round(2), 
    max = max(tons_pc)%>% round(2), 
    sd = sd(tons_pc)%>% round(2)
  ) %>% 
  rename (
    Mean = mean, Min = min, Max=max, `St. Dev`=sd
  ) %>% 
  pivot_longer(cols = c("Mean", "Min", "Max", "St. Dev")) %>% 
  left_join(
    tibble (
      xlab = rep(-122, 4), 
      ylab = c(30, 29, 28, 27), 
      name = c("Mean", "Min", "Max", "St. Dev")
    ), by = c("name")
  ) %>% 
  mutate(
    label = paste0(name , ": ", value)
  )



transparent_color <- rgb(0, 0, 0, alpha = 0)

map_plot_county <- 
  ggplot() + 
  geom_polygon(
    data = county_us %>% filter(year %in% c(year3)), 
    aes(x = long, y = lat, group = group, fill = as.factor(tons_pc_frac)), 
    linewidth= 0.1
  )+
  scale_fill_manual(
    values =c(
      ">1.1" = "#626767", 
      "0.9-1.1" = "#939797", 
      "0.7-0.9" ="#adb0b0",
      "0.5-0.7" = "#c8caca", 
      "< 0.5" ="#e3e4e4"),
    na.value = "grey100" )+
  labs (x="", y="", fill = "Disposal (tons per capita)")+
  geom_path(
    data = state_us, 
    aes(x = long, y = lat, group = group), 
    color = "#9aa0a0", 
    linewidth= 0.5
  )+
  geom_text(data=sum_stats, aes(x=xlab, y=ylab, label = label), family = "Helvetica", color = ut_colors[4])+ theme(strip.text = element_text(size = 15))+
  geom_text(
    data = tibble(x=-119, y=52, year = 2010, lab = ""), aes(x=x, y=y, label=lab), family = "Helvetica", color = ut_colors[4])+
  theme(
    panel.border = element_blank(),
    legend.position = "top", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(size=14, element_text(family="Helvetica")), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines"),panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_blank()
  ) 


png(paste0(figure_path, "/map_plot_county_presentation.png"), bg = "transparent", width = 12, height = 7, units = "in", res=300)
print(map_plot_county)
dev.off()

map_plot_county <- 
  map_plot_county+
  geom_path(
    data =   state_us %>% filter(region %in% c("connecticut", "vermont", "massachusetts", "rhode island", "new york", "maryland", "california", "washington", "new jersey")),
    aes(x = long, y = lat, group = group),
    color = "#417c5b",
    linewidth= 1.5
  )+
  geom_text(data=sum_stats, aes(x=xlab, y=ylab, label = label), family = "Helvetica", color = ut_colors[4])+ theme(strip.text = element_text(size = 15))+
  geom_line(
    data = tibble(x=seq(-124, -122), y=52, year = 2010), aes(x=x, y=y), color = "#417c5b", linewidth=1)+
  geom_text(
    data = tibble(x=-119, y=52, year = 2010, lab = "Treated"), aes(x=x, y=y, label=lab), family = "Helvetica", color = ut_colors[4])+
  theme(
    strip.text= element_text(vjust=-1.3), 
    text = element_text(size=14, element_text(family="Helvetica")), 

  )

png(paste0(figure_path, "/map_plot_county_borders.png"), bg = "transparent", width = 12, height = 7, units = "in", res=300)
print(map_plot_county)
dev.off()


```


## Figure 2: Per Capita Barplot

### Disposal

```{r}

col <- "grey20"

plotCol_trans <- c(rgb(col2rgb(col)[1,1],col2rgb(col)[2,1], col2rgb(col)[3,1],alpha =50, max=255))

barplot <- 
  dt %>%
  filter(
    type == "disposal", 
    year %in% c(2018, 2012, 2015)
  ) %>% 
  ungroup%>%
  mutate(
    state_id = state_id %>% as.factor,
    state_id = fct_reorder(state_id, -tons_pc, mean)
  ) %>%
  ggplot()+
  aes(
    x= state_id, y=tons_pc
  )+
  geom_bar(stat="identity", color= "white", fill=plotCol_trans )+
  labs(x="", y="Disposal")+
  facet_grid(vars(year))+
  scale_y_continuous(breaks=c(0, 0.75, 1.5))+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    #axis.ticks = element_blank(), 
    #axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())


ggsave(barplot, filename = "barplot.pdf", device = cairo_pdf, 
       path= figure_path,
       width = 15, height = 6, units = "in")

```

### Composting 

```{r}

barplot_composting <- 
  dt %>%
  filter(
    type == "composting", 
    year %in% c(2018, 2012, 2015)
  ) %>% 
  ungroup%>%
  mutate(
    state_id = state_id %>% as.factor,
    state_id = fct_reorder(state_id, -tons_pc, mean)
  ) %>%
  ggplot()+
  aes(
    x= state_id, y=tons_pc
  )+
  geom_bar(stat="identity", color= "white", fill=plotCol_trans )+
  labs(x="", y="Composting")+
  facet_grid(vars(year))+
  scale_y_continuous(breaks=c(0, 0.2))+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    #axis.ticks = element_blank(), 
    #axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica",size = 16), 
    legend.title = element_blank(),
    strip.background = element_blank(), 
    legend.key = element_blank())




ggsave(barplot_composting, filename = "barplot_composting.pdf", device = cairo_pdf, 
       path= figure_path,
       width = 15, height = 6, units = "in")

```

## Table 2: Summary Statistics

```{r}

dt %>% 
  filter(
    type %in% c("composting", "disposal", "recycling"), 
    tons_pc > 0, 
    year >= 2000
  ) %>% 
  mutate(
    type = paste(str_to_upper(substr(type,1,1)),(substring(type,2)), sep="")
  ) %>%  
  group_by(type) %>% 
  summarise(
    Observations = n(),
    Mean = mean(tons_pc, na.rm = TRUE), 
    St.Dev= sd(tons_pc, na.rm = TRUE), 
    Min = min(tons_pc, na.rm = TRUE), 
    Max = max(tons_pc, na.rm = TRUE)
  )


# State Means
plot_table_fun <- function(type_chosen)
{
  dt %>% 
    filter(
      type == type_chosen, 
      year >=2000
    ) %>% 
    mutate(
      type = paste(str_to_upper(substr(type,1,1)),(substring(type,2)), sep="")
    ) %>% 
    group_by (state_id, type) %>% 
    summarise(
      avg = mean(tons_pc, na.rm = TRUE), 
      st_dev = sd(tons_pc, na.rm = TRUE)
    ) %>%
    ggplot()+
    aes(x = avg)+
    geom_density(col=ut_colors[4])+
    labs(x="", y= "")+
    scale_x_continuous(limits = c(0,1),breaks=c(0,1))+
    theme_classic()+
    theme(
      strip.background = element_rect(color = "white", fill = "white"),
      panel.grid.major = element_blank(), 
      #text = element_text(size = 16), 
      axis.ticks.y = element_blank(), 
      axis.text.y=element_blank(),
      axis.line.y = element_blank()
      )
}
  
plot_table_state_recycling <- plot_table_fun("recycling")
plot_table_state_disposal <- plot_table_fun("disposal")
plot_table_state_composting <- plot_table_fun("composting")

ggsave(
  "plot_table_state_recycling.jpeg", plot_table_state_recycling, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)
ggsave(
  "plot_table_state_disposal.jpeg", plot_table_state_disposal, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)
ggsave(
  "plot_table_state_composting.jpeg", plot_table_state_composting, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)




# Year Means
plot_table_fun <- function(type_chosen)
{
  dt %>% 
    filter(
      type == type_chosen,
      year >= 2000
    ) %>% 
    mutate(
      type = paste(str_to_upper(substr(type,1,1)),(substring(type,2)), sep="")
    ) %>% 
    group_by (year, type) %>% 
    summarise(
      avg = mean(tons_pc, na.rm = TRUE), 
      st_dev = sd(tons_pc, na.rm = TRUE)
    ) %>%
    ggplot()+
    aes(x = avg)+
    geom_density(col=ut_colors[4])+
    labs(x="", y= "")+
    scale_x_continuous(limits = c(0,1),breaks=c(0,1))+
    theme_classic()+
    theme(
      strip.background = element_rect(color = "white", fill = "white"),
      panel.grid.major = element_blank(), 
      #text = element_text(size = 16), 
      axis.ticks.y = element_blank(), 
      axis.line.y = element_blank(),
      axis.text.y=element_blank()
      )
}
  
plot_table_year_recycling <- plot_table_fun("recycling")
plot_table_year_disposal <- plot_table_fun("disposal")
plot_table_year_composting <- plot_table_fun("composting")

ggsave(
  "plot_table_year_recycling.jpeg", plot_table_year_recycling, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)
ggsave(
  "plot_table_year_disposal.jpeg", plot_table_year_disposal, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)
ggsave(
  "plot_table_year_composting.jpeg", plot_table_year_composting, 
  path= figure_path, 
  height = 2, width = 5, dpi = 320)


```

## Figure 3: Vermont Facilities

```{r}
facilities <- read.csv(paste0(post_syp_path,"/03. Bans/food_processors_list_VT.csv"))


facilities_map <- 
  ggplot() + 
  geom_polygon(
    data = map_data("state") %>%  filter(region %in% c("vermont")), 
    aes(x = long, y = lat),
    linewidth= 0.1, 
    fill = "white", 
    color = "grey20"
  )+
  geom_point(
    data = 
      facilities %>% as_tibble %>% filter(STATE =="VT") %>%  
      select(Longitude, Latitude, TYPE) %>% 
      rename(
        long = Longitude, 
        lat = Latitude, 
        type = TYPE
      ) %>%
      mutate(
        type = ifelse(type == "Food Scraps Management Facility", "Composting Facilities", "Landfill-bound Stations"),
        type = factor(type, levels = c("Landfill-bound Stations", "Composting Facilities"))
      ), 
    aes(x=long, y= lat), 
    size =2, 
    color =rgb(100, 80, 200, maxColorValue = 255)
  )+
  facet_grid(cols = vars(type))+
  labs(x="", y="", color = "")+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family="Helvetica", size = 16), 
    #legend.text=element_text(size=14),
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines") 
    #legend.key.width = unit(2.5, "cm"), 
    #legend.key.height = unit(.25, "cm")
  ) 

ggsave(facilities_map, filename = "facilities_map.pdf", device = cairo_pdf,
       path= figure_path,
       width = 5, height = 4, dpi=320, units = "in")
```


```{r}
generators_map <- 
  ggplot() + 
  geom_polygon(
    data = map_data("state") %>%  filter(region %in% c("massachusetts"), lat > 41.5), 
    aes(x = long, y = lat),
    linewidth= 0.1, 
    fill = "white", 
    color = "grey20"
  )+
  geom_point(
    data = 
      food_generators_MA %>% as_tibble %>%  
      #select(Lat, Long, Type, tons, DEP_Code) %>% 
      rename(
        long = Long, 
        lat = Lat, 
        type = Type
      ) %>% 
      mutate(long=-long) %>% 
      filter(
        lat > 41.5, 
        type %in% c("R", "G", "F")) %>% 
      mutate(
        type = ifelse(type == "R", "Restaurant", ifelse(type == "G", "Grocery Store", "Manufacturer")), 
        tons = ifelse(DEP_Code == "G1", tons, NA)
      ), 
    aes(x=long, y= lat, color = type), 
    size =2
  )+  labs(x="", y="", color = "")+
  scale_color_manual(values = gray(seq(0.8, 0.3, length.out = 3)))+
  theme(
    panel.border = element_blank(),
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family="Helvetica", size = 16), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines") 
  ) 

generators_map

generators_map_whole_foods <- 
  ggplot() + 
  geom_polygon(
    data = map_data("state") %>%  filter(region %in% c("massachusetts"), lat > 41.5), 
    aes(x = long, y = lat),
    linewidth= 0.1, 
    fill = "white", 
    color = "grey20"
  )+
  geom_point(
    data = 
      food_generators_MA %>% as_tibble %>% filter(Name == "Whole Foods Market") %>% 
      #select(Lat, Long, Type, tons, DEP_Code) %>% 
      rename(
        long = Long, 
        lat = Lat, 
        type = Type
      ) %>% 
      mutate(long=-long) %>% 
      filter(
        lat > 41.5, 
        type %in% c("R", "G", "F")) %>% 
      mutate(
        type = ifelse(type == "R", "Restaurant", ifelse(type == "G", "Grocery Store", "Manufacturer")), 
        tons = ifelse(DEP_Code == "G1", tons, NA)
      ), 
    aes(x=long, y= lat, color = type), 
    size =2
  )+  labs(x="", y="", color = "")+
  ggrepel::geom_text_repel(
    data = 
      food_generators_MA %>% as_tibble %>%  filter(Name == "Whole Foods Market") %>% 
      #select(Lat, Long, Type, tons, DEP_Code) %>% 
      rename(
        long = Long, 
        lat = Lat, 
        type = Type
      ) %>% 
      mutate(long=-long) %>% 
      filter(
        lat > 41.5), 
    aes(x=long, y= lat, label = tons), color = ut_colors[4]
  )+
  scale_color_manual(values = gray(seq(0.8, 0.3, length.out = 3)))+
  theme(
    panel.border = element_blank(),
    legend.position = "none", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    text = element_text(family="Helvetica", size = 16), 
    strip.background = element_blank(), 
    legend.title = element_text(vjust=.3),
    panel.spacing = unit(2, "lines") 
  ) 


ggsave(generators_map, filename = "generators_map.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 6, dpi=320, units = "in")

ggsave(generators_map_whole_foods, filename = "generators_map_whole_foods.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 6, dpi=320, units = "in")

```


# Analysis of Variance

## Cleaning 

Here I exclude observations as we do in the main analysis

```{r}

power2 <- read.csv("power2_impexp.csv")

year_start <- 2006
year_cutoff <- 2018
year_end <- 2011

dt <- power2

dt <- 
  dt %>% 
  filter(
    year >= year_start, 
    year <= year_cutoff, 
    state_id != "OH",
    type %in% c("disposal", "msw_disposed")
  ) %>% 
  group_by (year, state_id, county_name) %>% 
  summarise(tons = sum(tons)) %>% 
  left_join (
    population %>% group_by(state_id, year) %>% summarise(state_pop = sum(pop)), 
    by = c("state_id", "year")
  ) %>%
  left_join (
    population,
    by = c("state_id", "county_name", "year")
  ) %>% 
  mutate(
    tons_pc = ifelse(is.na(county_name),tons/state_pop, tons/pop), 
    county_id = ifelse(is.na(county_name), state_id, paste0(county_name, state_id) )
  ) %>% 
  filter(
    tons_pc > 0.2
  )

exc<- 
  as.data.frame(
    dt %>% 
      group_by(county_id) %>% 
      filter(state_id != "CT", state_id != "RI") %>% 
      summarize(
        m = mean(tons_pc), 
        min_year = min(year), 
        min_tons = min(tons_pc), 
        max_tons = max(tons_pc)) %>%
      filter(
        m < 0.3 | min_year > year_start | max_tons > 2.5)
  )

dt <- dt[!(dt$county_id %in% exc$county_id),]
dt <- dt[dt$year >=year_start  & dt$year <=year_cutoff,]
exc<- 
  as.data.frame(
    dt %>% 
      group_by(county_id) %>% 
      summarize(n=  n()) %>% 
      filter(
        n < (year_cutoff- year_start+1)
      )
  )
dt <- dt[!(dt$county_id %in% exc$county_id),]
# Percentage change in disposal tons
f <- 
  as.data.frame(
    dt %>% 
      filter(state_id != "RI") %>% 
      group_by(county_id) %>% 
      mutate(
        percentage = (tons-dplyr::lag(tons, n = 1, default = NA))/dplyr::lag(tons, n = 1, default = NA),
        percentage_1 = (tons-dplyr::lead(tons, n = 1, default = NA))/dplyr::lead(tons, n = 1, default = NA)
      )
  )

f <- f[!is.na(f$percentage),]
threshold <- 0.6
exclude2 <- unique(f$county_id[f$percentage > threshold | f$percentage < -threshold | f$percentage_1 > threshold | f$percentage_1 < -threshold])
```

## ANOVA
```{r}

regions <-
  tibble(
    state_id = c("CT" ,"IN" ,"MN" ,"UT" ,"WI" ,"OR", "TX" ,"VT" ,"WA" ,"CA", "MI" ,"PA" ,"NJ", "FL" ,"MS" ,"NC" ,"OH" ,"SC", "IL", "MA", "GA", "IA", "KY", "TN" ,"MO" ,"CO" ,"DE","RI" ,"MD", "NM" ,"NV" ,"ME", "OK" ,"AZ", "AL", "NY") ,
    region = c("Northeast", "Midwest", "Midwest", "West","Midwest","West", "Southwest", "Northeast", "West", "West","Midwest", "Northeast", "Northeast", "Southeast", "Southeast", "Southeast", "Midwest", "Southeast", "Midwest", "Northeast", "Southeast", "Midwest", "Southeast", "Southeast", "Midwest", "West", "Northeast", "Northeast", "Northeast", "Southwest", "West", "Northeast","Southwest", "Southwest", "Southeast", "Northeast")
  )


dt_anova <- 
  power2 %>% 
  as_tibble  %>% 
  filter(year >=2006, year <=2018) %>% 
  mutate(
    county_id = ifelse(is.na(county_name), state_id, paste0(county_name, state_id, sep =""))
  ) %>% 
  filter(type == "disposal") %>%
  group_by(county_id) %>% 
  mutate(n=n()) %>%  filter(n==13) %>% 
  left_join(
    population, 
    by = c("year", "state_id", "county_name")
  ) %>% 
  left_join(
    population %>% group_by(year, state_id) %>% summarise(state_pop = sum (pop)), 
    by = c("state_id", "year")
  ) %>% 
  mutate(
    pop = ifelse(is.na(county_name), state_pop, pop),
    tons_pc = tons/pop
  ) %>% 
  group_by(state_id, year) %>% 
  mutate(tons_pc_state = sum(tons)/sum(pop)) %>% 
  select(
    year, state_id, county_name, type, tons, tons_pc, tons_pc_state, pop
  ) %>% 
  ungroup %>% 
  arrange(year, state_id) %>% 
  left_join(
    regions, by =c("state_id")
  ) %>% 
  mutate(
    county_id = ifelse(is.na(county_name), state_id, paste0(county_name, state_id, sep =""))
  ) %>% 
  filter(!county_id %in% c(exclude2, exc %>% pluck("county_id")))


lm11 <- lm(tons_pc ~ as.factor(region), data= dt_anova%>% filter(!is.na(county_name)))
summary(lm11)

lm12 <- lm(tons_pc_state ~ as.factor(region), data= dt_anova %>% group_by(state_id, year, region) %>% summarise(tons_pc_state = mean(tons_pc_state)))
summary(lm12)


lm21 <- lm(tons_pc ~ as.factor(state_id), data= dt_anova%>% filter(!is.na(county_name)))
summary(lm21)

lm22 <- lm(tons_pc_state ~ as.factor(state_id), data= dt_anova %>% group_by(state_id, year, region) %>% summarise(tons_pc_state = mean(tons_pc_state)))
summary(lm22)

lm3 <- fixest::feols(tons_pc ~ 1|county_id, data= dt_anova %>% filter(!is.na(tons_pc)))
summary(lm3)

lm41 <- lm(tons_pc ~ as.factor(year), data= dt_anova%>% filter(!is.na(county_name)))
summary(lm41)

lm42 <- lm(tons_pc_state ~ as.factor(year), data= dt_anova %>% group_by(state_id, year, region) %>% summarise(tons_pc_state = mean(tons_pc_state)))
summary(lm42)

lm5 <- fixest::feols(tons_pc ~ 1|state_id_year, data= dt_anova%>% filter(!is.na(county_name)) %>% mutate(state_id_year = paste0(state_id, year, sep="")))
summary(lm5)

install.packages("xtable")
library(xtable)
  

cbind(
  col1 = c(
    "Region FE", 
    "State FE", 
    "County FE", 
    "Year FE", 
    "State-Year FE", 
    "Number of Counties", 
    "Number of States", 
    "Observations"), 
  County_Year = c(
    summary(lm11)$adj.r.squared %>% round(2), 
    summary(lm21)$adj.r.squared %>% round(2), 
    fixest::r2(lm3, "r2") %>% round(2), 
    summary(lm41)$adj.r.squared %>% round(2),
    fixest::r2(lm5, "r2") %>% round(2), 
    dt_anova %>%  filter(!is.na(county_name)) %>% summarise(n = n_distinct(county_id)) %>%  pluck("n"), 
    dt_anova %>%  filter(!is.na(county_name)) %>% summarise(n = n_distinct(state_id)) %>%  pluck("n"), 
    dt_anova %>%  filter(!is.na(county_name)) %>% nrow
  ) ,
  State_Year = c(
    summary(lm12)$adj.r.squared %>% round(2), 
    summary(lm22)$adj.r.squared %>% round(2), 
    NA, 
    summary(lm42)$adj.r.squared %>% round(2), 
    NA, 
    NA, 
    dt_anova %>% summarise(n = n_distinct(state_id)) %>%  pluck("n"), 
    dt_anova %>% group_by(state_id, year, region) %>% summarise(tons_pc_state = mean(tons_pc_state)) %>% nrow
  ) 
)  %>%
  {
    print(xtable(.), include.rownames=FALSE)
  }

remove.packages("xtable")



dt_anova %>% 
  group_by(year) %>% 
  summarise(pop = sum(pop, na.rm=TRUE)) %>% 
  left_join(
    population %>% 
      filter (!state_id %in% c("AK", "HI", "DC")) %>% 
      group_by (year) %>% 
      summarize(total_pop= sum(pop, na.rm = TRUE)),
    by = "year"
  ) %>% 
  mutate(fraction = pop/total_pop) %>% summarise(mean(fraction))
  
  
  


```

