---
title: "data_section_basic_data_manipulations"
author: "Fiori Anglou"
date: "2024-01-04"
output: html_document
---


```{r, include=FALSE}
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyverse)
library(extrafont)
library(latex2exp)
library(ggnewscale)
#rmarkdown::render("C:/Users/fa24575/Desktop/what .Rmd")
state_data_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/03. State_Data"
post_syp_path <- "C:/Users/fa24575/Dropbox/Organic Waste Bans/06. Post SYP"
figure_path <- "C:/Users/fa24575/Dropbox/Apps/Overleaf/Organic Waste Bans/Figures"
```


# Basic Data

Apart from waste information, I also use population data (from the Bureau of Labor) and GDP data. The GDP is standardized in 2012 dollars and is in millions. In the analysis, wherever I use it, I normalize it with the population. 

```{r, include=FALSE}
loadfonts(device = "win")

plotCol <- c('royalblue4','deepskyblue3','skyblue','purple1','purple4','lightslateblue','darkmagenta', 'mediumorchid', 'goldenrod', 'honeydew3', 'firebrick3','palegreen3','plum', "aquamarine", "brown4", "cyan4", "darkslategray3", "darkolivegreen4")

ut_colors <- c(
  rgb(132, 59,14, max=255), 
  rgb(255, 127, 21, max=255), 
  rgb(191,87,0, max=255), 
  rgb(51,73,72, max=255), 
  rgb(156, 173, 183, max=255), 
  rgb(191,87,0,alpha=50, max=255)
)

# Population
population <- read.csv(paste0(state_data_path,"/00. Controls/Population/population.csv"))
population <- cbind(population[1:2], stack(population[3:31]))
colnames(population)<- c("state_id", "county_name", "pop", "year")

population <- 
  population %>% 
  mutate(
    year = substring(year, 2) %>% as.integer, 
    pop = pop %>% as.numeric,
    county_name = ifelse(county_name%in%c("doña ana","do\xf1a ana"), "dona ana", county_name)
  ) %>% 
  filter(
    !state_id %in% c("AK", "co", "ia")
  )# contiguous states, DC is considered a contiguous state


population_2020 <- read.csv(paste0(state_data_path,"/00. Controls/Population/population_2020.csv"))
population_2020 <- population_2020[population_2020$state_id !="DC",]
population_2020$county_name[population_2020$county_name %in% c("doña ana", "do\xf1a ana")] <- "dona ana"
population <- rbind(population, population_2020)
rm(population2020)

population$county_name[population$county_name %in% c("doña ana", "do\xf1a ana")] <- "dona ana"

# GDP
gdp <- read.csv(paste0(state_data_path,"/00. Controls/State_GDP/annual_gdp.csv"))
gdp<- gdp[gdp$LineCode==1,]
gdp <- cbind(gdp[1:5], stack(gdp[6:29]))
gdp <- gdp[,c("state_id", "values", "ind")]
gdp$ind <- substring(gdp$ind, 2)
colnames(gdp) <- c("state_id", "gross_current", "year")
gdp$gross_current <- as.numeric(gdp$gross_current)
```



# Gathering the datasets


## State and County Level

Then I enlarge the previous dataset by including county-level information as well. The main difference is that while before, i used as ID the state ID, now I will use a new field, county ID. The county ID is equal to the state ID if the state does not report on the county level while it is equal to the county name concatenated with the state ID if the state reports by counties. 

```{r, include=FALSE, message=FALSE}


#Alabama -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
alabama <- read.csv(paste0(state_data_path,"/Alabama/import_R/alabama.csv"))

al_imports <-  
  alabama %>%  
  group_by(year) %>% 
  summarise(tons = sum(msw_out_of_state)) %>% 
  mutate(
    destination ="AL",
    origin = "unknown",
    source_data = "AL",
    type = "disposal", 
    county_name = NA
  ) %>%
  filter(year > 2010) %>% 
  select(year,county_name, tons, destination, origin, source_data)


alabama <-  
  alabama %>%  
  group_by(year) %>% 
  summarise(tons = sum(msw_in_state)) %>% 
  mutate(
    state_id ="AL", 
    type = "disposal", 
    county_name = NA
  ) %>%
  filter(year > 2010) %>% 
  select(year, state_id, county_name, type, tons)



#Arizona -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
arizona <- read.csv(paste0(state_data_path,"/Arizona/import_R/arizona.csv"))

arizona <-  
  arizona %>% 
  filter(landfill_type %in% c("", "msw")) %>% 
  mutate(
    state_id ="AZ", 
    type = "disposal", 
    county_name = NA
  ) %>%
  group_by(year, state_id, county_name, type) %>% 
  summarize(tons = sum(weight, na.rm = TRUE)) %>% 
  ungroup %>% 
  filter(year >=2013)


#California -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
california <- read.csv(paste0(state_data_path,"/California/import_R/california.csv"))
ca_exports <- read.csv(paste0(state_data_path,"/California/import_R/ca_exports.csv"))

california <- 
  california %>%  
  rename(county_name = County, year = Report.Year, quarter = Report.Quarter, disposal =Diposal.Ton, export = Export.Ton) %>% 
  select(county_name, year, county_name, year, quarter, disposal, export) %>% 
  mutate(
    county_name = str_to_lower(county_name),
    disposal = ifelse(county_name == "calaveras" & year == 2016 & disposal> 100000, 12139.75,disposal), # calaveras an outlier
    total = ifelse(is.na(disposal), 0, disposal) + ifelse(is.na(export), 0, export), 
    state_id = "CA", 
    type = "disposal"  
    ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarize(tons = sum(total, na.rm=TRUE)) %>% ungroup

ca_exports<-
  ca_exports %>%
  rename(
    year = Report.Year, 
    county_name = County.Name, 
    state_name = Destination.State, 
    tons = Disposal.Ton
  ) %>% 
  select(year, county_name, state_name, tons) %>%  as_tibble() %>% 
  mutate(
    state_name = tolower(state_name)
  ) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    ) %>% as_tibble %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ), 
    by = c("state_name")
  ) %>% 
  mutate(
    destination = state_id, 
    origin = "CA", 
    county_name = tolower(county_name), 
    source_data = "CA"
  ) %>% 
  ungroup %>% 
  select(year, county_name, tons, destination, origin, source_data)


#Colorado -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
conversion_rates <- read.csv(paste0(state_data_path,"/Colorado/import_R/CO_conversion_rates.csv"))
names(conversion_rates) <- c("year", "volume_CY", "equivalent_tons", "conversion")

colorado <- read.csv(paste0(state_data_path,"/Colorado/import_R/CO_msw_disposal.csv"))
colorado_recycling <- read.csv(paste0(state_data_path,"/Colorado/import_R/CO_recycling.csv"))

colorado <- 
  colorado %>% 
  rename(county_name = county) %>% 
  left_join(
    ., 
    conversion_rates %>% select(year, conversion), 
    by = c("year")) %>% 
  mutate(
    CY = CY * conversion, 
    state_id ="CO", 
    type = "disposal") %>% 
  rename(tons = CY) %>% 
  group_by(county_name, year, state_id, type) %>% 
  summarise(tons = sum(tons))%>% 
  mutate(tons=tons*0.7) %>% 
  select(year, state_id, county_name,type, tons) %>%
  rbind (
    colorado_recycling %>% 
      mutate(
        material = str_to_lower(material), 
        county_name = NA, 
        state_id = "CO"
      )%>% 
      filter(material %in% c("compost", "yard trimmings"))%>%
      rename(
        type = material,
        tons = total)%>%
      mutate(type = "composting") %>%
      select(year, state_id, county_name,type, tons)
  )


rm(conversion_rates, colorado_recycling)

#Connecticut --------------------------------------------------------------------------------------------------------------------------------------------
msw_lf <- read.csv(paste0(state_data_path,"/Connecticut/import_R/MSW_LF.csv"))
msw_oos <- read.csv(paste0(state_data_path,"/Connecticut/import_R/MSW_OOS.csv"))
composting <- read.csv(paste0(state_data_path,"/Connecticut/import_R/composting.csv"))
recycling <- read.csv(paste0(state_data_path,"/Connecticut/import_R/MSW_Recycling.csv"))
counties_cities <- read.csv(paste0(state_data_path,"/Connecticut/import_R/counties_cities.csv"))
ct_exports_additional <- read.csv(paste0(state_data_path,"/Connecticut//import_R/exports_website.csv"))

connecticut <- 
  msw_lf %>%  
  as_tibble() %>% 
  filter(
    !town %in% c("international", "massachusetts","new hampshire", "new jersey", "new york", "rhode island", "vermont")
  )  %>% 
  group_by(town, year) %>%
  pivot_longer(
    cols = c("msw", "bulky", "totals"), 
    values_to = "tons", 
    names_to = "category"
  ) %>% group_by(category, town, year) %>% 
  summarise(tons = sum(tons, na.rm = TRUE)) %>% 
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>% 
  filter(category== "msw") %>% 
  group_by(year, county) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))%>% 
  mutate (type = "disposal") %>% 
  rbind ( 
    composting %>% 
      filter(
        !town %in% c("international", "massachusetts", "new jersey", "new york", "rhode island", "vermont"), 
        item %in% c("COMPOST - FINISHED", "YARD WASTE COMPOST", "WOOD - BRUSH COMPOST", "LEAVES")) %>%
      group_by(town, year) %>%
      summarise( tons = sum(totals, na.rm = TRUE)) %>% 
      left_join(., counties_cities, by =c("town"), all.x= TRUE) %>% 
      group_by(year, county) %>% 
      summarise( tons = sum(tons, na.rm = TRUE)) %>% 
      mutate (type = "composting") %>% filter(!is.na(county))
  ) %>% 
  mutate (state_id = "CT") %>% 
  rename (county_name = county)  %>%
  left_join(population, by =c("county_name", "year", "state_id"))%>% 
  left_join(
    population %>% 
      filter(state_id =="CT") %>% 
      group_by(year, state_id) %>% 
      summarise(state_pop = sum(pop, na.rm=TRUE)) , by =c("state_id", "year")
  ) %>% 
  ungroup %>% 
  group_by (county_name, year, type, state_id, state_pop, pop) %>% 
  summarise(tons= sum(tons, na.rm = TRUE)) %>% 
  ungroup %>% 
  filter(!is.na(county_name))

# connecticut <-
#   connecticut %>%
#   left_join(
#     connecticut %>%
#       filter(is.na(county_name)) %>%
#       group_by(year, type) %>%
#       summarise(unacc = sum(tons, na.rm=TRUE)),
#     by =c("year", "type")
#   ) %>%
#   group_by(year, type) %>%
#   mutate (
#     state_pop = sum(pop, na.rm = TRUE),
#     unacc = ifelse(is.na(unacc), 0, unacc),
#     tons  = unacc * pop/ state_pop + tons,
#     tons_pc = tons/pop
#     ) %>%
#   filter(!is.na(county_name)) %>%
#   select(-unacc)


recycling <- 
  recycling %>% 
  as_tibble %>% 
  mutate(
    town = str_to_lower(town), 
    facility_name = str_to_lower(facility_name)
  ) %>% 
  group_by (year, town) %>% 
  summarise(
    residential = sum(residential, na.rm = TRUE), 
    nonresidential = sum(nonresidential, na.rm = TRUE), 
    mixed = sum(mixed, na.rm = TRUE), 
    total = sum(total, na.rm = TRUE)
  ) %>% 
  ungroup %>% 
  left_join(counties_cities, by =c("town"), all.x= TRUE) %>% 
  mutate (state_id = "CT") %>% 
  rename (county_name = county)  %>%
  left_join(population, by =c("county_name", "year", "state_id"))%>% 
  left_join(
    population %>% 
      filter(state_id =="CT") %>% 
      group_by(year, state_id) %>% 
      summarise(state_pop = sum(pop, na.rm=TRUE)) , by =c("state_id", "year")
  ) %>% 
  rename(tons = total) %>% mutate(type = "recycling") %>% 
  select(year, town, county_name, state_id, pop, state_pop, tons, type)


recycling<-
  recycling %>%
  group_by (year, county_name, state_id, pop, state_pop, type) %>%
  summarise(
    tons = sum(tons)
  ) %>%
  ungroup %>%
  filter(
    !is.na(county_name)
  ) %>%
  left_join(
    recycling %>%
      filter(
        town %in% c("town not selected", "unedentified - conn.", "unedentified - other")
      ) %>%
      group_by(year, type) %>%
      summarise(unacc = sum(tons, na.rm=TRUE)),
    by =c("year", "type")
  ) %>%
  mutate (
    unacc = ifelse(is.na(unacc), 0, unacc),
    tons  = unacc * pop/ state_pop + tons,
    tons_pc = tons/pop) %>%
  filter(!is.na(county_name))  %>%
  select(year, state_id, county_name, type, tons)

connecticut <- 
  connecticut %>%  
  select(year, state_id, county_name, type, tons) %>% 
  rbind(recycling %>%  select(year, state_id, county_name, type, tons) )


ct_exports <- 
  msw_oos %>% 
  mutate(
    ind_1 = ifelse(facility_desc== "No Facility Type",1,0), 
    ind_2 = ifelse(facility_name == "NO FACILITY SELECTED",1,0)) %>% 
  filter(ind_1*ind_2!=1)%>%  #these should be excluded, see april 14 email
  pivot_longer(
    cols = c("msw", "rec", "bulky"), 
    names_to = "type", 
    values_to = "tons"
  ) %>% 
  group_by(year, state, type) %>%  
  summarise(tons = sum(tons, na.rm=TRUE)) %>%  
  filter(
    tons>0
  ) %>%  
  rename(
    destination = state
  ) %>% 
  group_by(year, destination, type) %>% 
  summarise(tons = sum(tons, na.rm=TRUE)) %>% 
  mutate(
    origin = "CT", 
    type = ifelse(type %in% c("msw"), "disposal", "recycling"), 
    source_data = "CT", 
    county_name = NA, 
    destination = ifelse(destination%in%c("OOS", "UN", "OS"), "unknown", destination)
  ) %>% 
  filter(type == "disposal") %>% 
  group_by(year, county_name, destination, origin, source_data) %>%  summarise(tons = sum(tons)) %>% 
  select(year, county_name, tons, destination, origin, source_data)


# ct_exports <-
#   ct_exports %>%
#   rbind(
#     tibble(
#       year = 2008:2014,
#       county_name = NA,
#       tons = 0,
#       destination = "unknown",
#       origin = "CT",
#       source_data  = "CT"
#     )) %>%
#   left_join(
#     ct_exports_additional %>%
#       group_by(year) %>%
#       summarise(exported_tons = sum(exported_tons)),
#     by = "year") %>%
#   group_by(year) %>%
#   mutate(
#     total_yearly = sum(tons),
#     deficit = ifelse(exported_tons - total_yearly>0, exported_tons - total_yearly, 0),
#     deficit = ifelse(is.na(deficit), 0, deficit)
#   ) %>%
#   ungroup %>%
#   mutate(
#     tons = ifelse(destination == "unknown", tons + deficit, tons)
#   ) %>% select(year, county_name, tons, destination, origin, source_data)



ct_imports <- 
  msw_lf %>%   
  filter(
    town %in% c("massachusetts", "new jersey", "new york", "rhode island", "vermont", "new hampshire")
  ) %>% 
  group_by (town, year) %>% 
  summarise(tons = sum(msw)) %>% 
  ungroup() %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    ) %>% as_tibble %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ), 
    by = c("town" = "state_name")
  ) %>% 
  rename(origin = state_id) %>% 
  mutate(
    destination = "CT", 
    source_data = "CT", 
    county_name = NA
  )%>% select(year, county_name, tons, destination, origin, source_data)

rm(msw_lf, msw_oos, counties_cities, recycling, composting, ct_exports_additional)
#Florida -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

florida <-read.csv(paste0(state_data_path,"/Florida/import_R/florida.csv"))

florida <- 
  florida %>% 
  group_by (state_id, year, county_name, type) %>% 
  summarise(tons = sum(tons)) %>% 
  pivot_wider(
    names_from = type, 
    values_from = tons
  ) %>% 
  mutate(
    disposal = msw_generated -  msw_recycled
  ) %>% 
  pivot_longer(
    cols = c("msw_generated", "msw_recycled", "food_recycled", "food_total", "disposal", "yard_recycled"), 
    names_to = "type", 
    values_to = "tons")%>% 
  select(year, state_id, county_name,type, tons) %>% 
  mutate(
    type = ifelse(type %in% c("food_recycled", "yard_recycled"), "composting", type)
  ) %>% 
  group_by (year, state_id, county_name,type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))

#Georgia -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
georgia <- read.csv(paste0(state_data_path,"/Georgia/import_R/georgia.csv"))

georgia <-
  georgia %>% 
  filter(
    type %in% c("Municipal Solid Waste Landfill","Unlined Sanitary Landfill", "Waste To Energy Facility", "Processor", "Sanitary Landfill", "Inert Landfill") 
  ) %>% 
  pivot_longer(
    cols = c("Q1", "Q2", "Q3", "Q4"), 
    names_to = "quarter", 
    values_to = "tons"
  ) %>% 
  mutate(
    type = "disposal", 
    state_id = "GA", 
    county_name = NA, 
    tons = tons %>% as.numeric
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))

# Delaware -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
delaware <- read.csv(paste0(state_data_path,"/Delaware/import_R/waste.csv"))
delaware$type[delaware$type=="Landfill"]<- "disposal"
delaware$type[delaware$type=="Recycling"]<- "recycling"
delaware$type[delaware$type=="Total"]<- "generation"


delaware <- 
  delaware %>% 
  mutate(
    state_id = "DE", 
    county_name = NA
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))


# Illinois -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
illinois_1 <- read.csv(paste0(state_data_path,"/Illinois/import_R/illinois_1_v2.csv"))
illinois_2 <- read.csv(paste0(state_data_path,"/Illinois/import_R/illinois_2.csv"))
illinois_3 <- read.csv(paste0(state_data_path,"/Illinois/import_R/illinois_3_v2.csv"))


illinois <- 
  rbind(
    illinois_1 %>%  
      select(state_id, year, type, tons) %>%  
      mutate(
        imports = ifelse(type == "imports", 1, 0), 
        type = "disposal"
      ), 
    illinois_2 %>%  
      select(Year, net_disposal, disposal_oos) %>% 
      pivot_longer(
        cols = c("disposal_oos", "net_disposal"), 
        names_to = "type", 
        values_to = "tons"
      ) %>% 
      rename(
        year = Year
      ) %>% 
      mutate(
        state_id = "IL",
        imports = ifelse(type == "disposal_oos", 1, 0), 
        type = "disposal"
      ) %>%  select(state_id, year, type, tons, imports), 
    illinois_3 %>%
      select(
        state_id, year, type, tons
      ) %>% 
      mutate(
        type = "disposal", 
        imports = 0
      )
  ) %>% 
  group_by(state_id, year, type, imports) %>% 
  summarise(tons = sum(tons)) %>% 
  mutate(tons = tons*0.7) # usual msw percentage

rm(illinois_1, illinois_2, illinois_3) 
 
il_imports <- 
  illinois %>%  
  filter(imports !=0) %>% 
  rename(
    destination = state_id
  ) %>% 
  mutate(
    source_data = "IL", 
    origin = "unknown", 
    year = as.integer(year), 
    county_name = NA
  ) %>% 
  ungroup %>% 
  select(year, county_name, tons, destination, origin, source_data)%>% 
  mutate(tons = tons*0.7) # usual msw percentage

illinois <- 
  illinois %>% 
  ungroup %>% 
  filter(imports==0) %>% 
  mutate(county_name = NA) %>% 
  select(year, state_id, county_name, type, tons)

#2012 has super super low disposal for Norhwestern Illinois --> I use the average of 2013 and 2014
# 4602132.727 (2013) and 4575769 (2011) --> 
# Prior to that it was 2871463



# Indiana --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

indiana_1 <- read.csv(paste0(state_data_path,"/Indiana/import_R/indiana_1.csv"))
indiana_2 <- read.csv(paste0(state_data_path,"/Indiana/import_R/indiana_2.csv"))


indiana <- 
  indiana_1 %>% as_tibble %>% 
  mutate(Start.Date = str_sub(Start.Date, start = str_length(Start.Date)-3, end= str_length(Start.Date))) %>% 
  rename(
    year = Start.Date, 
    facility_name = Facility.Name,
    facility_type = Facility.Type,
    state_name = Origin.State, 
    county_name = Origin.County, 
    tons = Municipal.Solid.Waste
  ) %>%  
  select(
    year, facility_name, facility_type, state_name, county_name, tons
  ) %>%
  filter(
    facility_type %in% c("Municipal Solid Waste Landfill", "Resource Recovery System", "Solid Waste Incinerator >= 10 Tons/Day", "Transfer Station")
  )%>% 
  rbind(
    indiana_2 %>% as_tibble %>% 
      filter(
        Waste.Type == "Municipal Solid Waste"
      ) %>% 
      mutate(
        Start.Date = str_sub(Start.Date, start = str_length(Start.Date)-3, end= str_length(Start.Date)), 
        Facility.Type = str_to_lower(Facility.Type)) %>% 
      rename(
        year = Start.Date, 
        facility_name = Facility.Name,
        facility_type = Facility.Type,
        state_name = Origin.State, 
        county_name = Origin.County, 
        tons = Tonnage
      ) %>% 
      select(
        year, facility_name, facility_type, state_name, county_name, tons
      )
  ) %>% 
  filter(tons > 0) %>% 
  mutate(
    county_name= str_to_lower(county_name), 
    state_name = str_to_lower(state_name), 
    facility_type = str_to_lower(facility_type)
  ) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    ) %>% as_tibble %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ), 
    by = c("state_name")
  ) %>% 
  filter(
    #state_id =="IN" , 
    facility_type !="transfer station"
  ) %>% 
  ungroup


in_imports <- 
  indiana %>%
  select(year, state_id, county_name, tons) %>% 
  group_by( year, state_id, county_name) %>% 
  summarise(tons = sum(tons)) %>%  
  ungroup %>%  
  mutate(
    imports = ifelse(state_id == "IN", 0, state_id),
    state_id = "IN"
  ) %>%  
  group_by(
    year, state_id, imports
  ) %>% 
  summarise(tons = sum(tons)) %>% 
  ungroup() %>% 
  filter(imports!=0) %>% 
  rename(origin = imports, destination = state_id) %>% 
  mutate(source_data = "IN", county_name = NA, year = as.integer(year)) %>% 
  select(year, county_name, tons, destination, origin, source_data)

indiana <- 
  indiana %>% 
  filter(state_id == "IN") %>% 
  mutate(
    county_name = NA, 
    type = "disposal"
  ) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons))

rm(indiana_1, indiana_2)

# Iowa -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

iowa <- read.csv(paste0(state_data_path,"/Iowa/import_R/iowa_v2.csv"))

# fy OK - checked May 2023
iowa <- 
  iowa %>% 
  mutate(
    tons = as.numeric(tons), 
    state_id ="IA", 
    county_name = NA, 
    type = "disposal"
  )  %>% 
  filter(
    year <= 2020 
  ) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))

ia_imports <- read.csv(paste0(state_data_path,"/Iowa/import_R/iowa_imp.csv"))
ia_exports <- read.csv(paste0(state_data_path,"/Iowa/import_R/iowa_exp.csv"))

ia_imports <- 
  ia_imports%>% 
  group_by(year, state) %>%  
  summarise(
    imports = sum(tons)
  ) %>%  
  rename(
    origin = state, 
    tons = imports
  ) %>% 
  mutate(
    county_name = NA,
    destination = "IA", 
    source_data = "IA"
  ) %>%
  select(year, county_name, tons, destination, origin, source_data)

ia_exports <- 
  ia_exports %>% 
  group_by(year, state) %>%  
  summarise(
    exports = sum(tons)
  ) %>%  
  rename(
    destination = state, 
    tons= exports
  ) %>% 
  mutate(
    county_name = NA,
    origin = "IA",
    source_data = "IA"
  )%>%
  select(year, county_name, tons, destination, origin, source_data)


iowa <- 
  iowa %>% 
  filter(year <=2021) %>% 
  left_join(
    ia_exports %>%  group_by(year) %>%  summarise(exported_tons = sum(tons, na.rm = TRUE)), 
    by = "year"
  ) %>% 
  left_join(
    ia_imports %>%  group_by(year) %>%  summarise(imported_tons = sum(tons, na.rm = TRUE)), 
    by = "year"
  ) %>% 
  mutate(
    imported_tons = ifelse(is.na(imported_tons), 0, imported_tons),
    exported_tons = ifelse(is.na(exported_tons), 0, exported_tons),
    tons = tons - imported_tons + exported_tons
  ) %>% select(year, state_id, county_name, type, tons)

# Kentucky -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

kentucky <- read.csv(paste0(state_data_path,"/Kentucky/import_R/kentucky_v2.csv"))

kentucky <- 
  kentucky %>%  as.tibble() %>% 
  rename(
    year = Disposal.Year, 
    state_id = Source.State, 
    county_name = Source.County, 
    landfill_type = Landfill.Description, 
    tons = MSW.Quantity..tons.
  ) %>% 
  filter(
    tons >0
  ) %>%  
  select(
    year, state_id, county_name, landfill_type, tons
  ) %>%  
  mutate(
    county_name = str_to_lower(county_name)
  ) %>%  
  filter(
    !landfill_type %in% c("CDD Landfill <1 Acre-SW-RPBR", "CDD Landfill >1 Acre", "Special Waste Landfill-Coal" )
  ) %>% 
  group_by(year, state_id) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))  %>% 
  mutate(
    imports = ifelse(state_id == "KY", 0, state_id), 
    state_id = "KY", 
    type = "disposal", 
    county_name = NA
  )

ky_imports <- 
  kentucky %>% 
  filter(imports !=0) %>% 
  rename(
    destination = state_id, 
    origin = imports
  ) %>% 
  mutate(source_data = "KY")%>%
  select(year, county_name, tons, destination, origin, source_data)

kentucky <- 
  kentucky %>%
  filter(imports==0) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))
  


# Maine -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

maine <- read.csv(paste0(state_data_path,"/Maine/import_R/maine_v2.csv"))

# disposal refers to total disposal in-state (ie. includes imports.) However I only have data for 2011 imports. 
# I will supplement wiht MA/ VT data


maine <- 
  maine %>% 
  group_by(year, type) %>% 
  summarise(tons = sum(tons, na.rm=TRUE)) %>% ungroup %>% 
  pivot_wider(names_from =type, values_from = tons) %>%
  mutate(disposal = disposal+exports) %>% 
  select(year, composting, disposal, recycling) %>% 
  pivot_longer(cols = c("disposal", "composting", "recycling"), names_to = "type", values_to = "tons") %>% 
  mutate(
    state_id = "ME", 
    county_name = NA
  ) %>% 
  select(year, state_id, county_name, type, tons)


# Maryland -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

maryland <- read.csv(paste0(state_data_path,"/Maryland/import_R/maryland_v2.csv"))


md_exports <- 
  maryland  %>%  filter(type == "exports") %>% 
  mutate(county_name = NA, source_data = "MD", origin = "MD") %>%
  select(year, county_name, tons, destination, origin, source_data)

maryland <- 
  maryland %>% 
  group_by(year, type) %>% 
  summarise(tons = sum(tons, na.rm=TRUE)) %>% ungroup %>% 
  pivot_wider(names_from =type, values_from = tons) %>% 
  mutate(
    disposal = disposal+exports-imports, 
    recycling = ifelse(year < 2010, NA, recycling)) %>% 
  select(year, disposal, recycling, composting) %>% 
  pivot_longer(
    cols = c("disposal", "recycling", "composting"), 
    names_to = "type", 
    values_to = "tons"
  ) %>% 
  mutate(
    county_name = NA, 
    state_id = "MD"
  )%>% 
  select(year, state_id, county_name, type, tons)


# Massachusetts -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ma <- read.csv(paste0(state_data_path,"/Massachusetts/import_R/treated_statewide_imp_exp.csv"))
ma_exports <- read.csv(paste0(state_data_path,"/Massachusetts/import_R/ma_exports.csv"))
ma_imports <- read.csv(paste0(state_data_path,"/Massachusetts/import_R/ma_imports.csv"))

ma <- 
  ma %>% 
  mutate(
    type = ifelse(type == "Disposal", "disposal", type), 
    type = ifelse(type == "Total Generation", "generation", type),
    type = ifelse(type == "Composting", "composting", type),
    type = ifelse(type == "Recycling", "recycling", type), 
    state_id = "MA", 
    county_name = NA, 
    imports = ifelse(imports=="export", -1, ifelse(imports=="import", 1, 0))
  ) %>% 
  filter(imports == 0) %>% #in-state disposal
  group_by (year, state_id, county_name, type, imports) %>% 
  summarize(tons = sum(tons, na.rm=TRUE)) %>% ungroup

# Add 2013, as we know 2013 has no data. They did not publish anything
ma_2013 <- 
  ma %>% 
  filter(year == 2012|year == 2014) %>% 
  group_by(type, imports) %>% 
  summarise(tons = mean(tons)) %>% 
  mutate(
    year = 2013, 
    state_id = "MA", 
    county_name = NA
  ) %>% 
  group_by(year, state_id, county_name, type, imports) %>% 
  summarise(tons = mean(tons)) %>% 
  ungroup

ma <- 
  ma %>% 
  rbind(ma_2013) %>% 
  select(-imports)

rm(ma_2013)

ma_exports <- 
  ma_exports %>% 
  mutate(
    county_name = NA, 
    source_data = "MA"
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data) %>% 
  rbind(
    ma_exports %>% 
      filter(year == 2012|year == 2014) %>% 
      group_by(origin, destination) %>% 
      summarise(tons = mean(tons)) %>% 
      mutate(
        year = 2013, 
        source_data = "MA", 
        county_name = NA
      ) %>% 
      group_by(year, source_data, county_name, origin, destination) %>% 
      summarise(tons = mean(tons)) %>% ungroup %>% select(year, county_name, tons, destination, origin, source_data)
  ) %>% as_tibble

ma_imports <- 
  ma_imports %>% 
  mutate(
    county_name = NA, 
    source_data = "MA"
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data) %>% 
  rbind(
    ma_imports %>% 
      filter(year == 2012|year == 2014) %>% 
      group_by(origin, destination) %>% 
      summarise(tons = mean(tons)) %>% 
      mutate(
        year = 2013, 
        source_data = "MA", 
        county_name = NA
      ) %>% 
      group_by(year, source_data, county_name, origin, destination) %>% 
      summarise(tons = mean(tons)) %>% ungroup %>% select(year, county_name, tons, destination, origin, source_data)
  ) %>% as_tibble

#adding ma exports
ma <-
  ma %>% as_tibble %>% 
  left_join(
    ma_exports %>% group_by(year) %>%  summarise(exported_tons = sum(tons)), 
    by = "year"
  ) %>% 
  mutate(
    tons = ifelse(type == "disposal", tons+exported_tons, tons)
  ) %>% select(-exported_tons)


# Michigan -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

michigan <-  read.csv(paste0(state_data_path,"/Michigan/import_R/michigan_v2.csv"))
michigan_imp <-  read.csv(paste0(state_data_path,"/Michigan/import_R/michigan_imp_v2.csv"))

michigan<- 
  michigan %>% as_tibble() %>% 
  select(state_id, year, tons) %>% 
  mutate(
    type = "disposal", 
    county_name = NA, 
    imports= 0
  ) %>% 
  rbind(
    michigan_imp %>%  as_tibble %>% 
      select(
        state_id, year, tons
      ) %>% 
      mutate(
        type = "disposal", 
        county_name = NA, 
        imports = state_id, 
        state_id = "MI"
      ) %>%  
      select(state_id, year, tons, type, county_name, imports)
  ) %>%  
  group_by(
    year, state_id, type, imports
  ) %>% 
  summarise(
    tons = sum(tons, na.rm=TRUE)
  )

rm(michigan_imp)
# the financial year runs from october to september so when in the above it says it is year=2009 it means it is oct-dec 2008 and jan to sep 2009. We will split this 25-75

michigan <- 
  michigan %>% as_tibble %>% 
  left_join(
   michigan %>%  
     as_tibble %>% 
     mutate(
       year = year-1, 
       tons_2 = tons *0.25
     ) %>%  select(state_id, year, type, imports, tons_2), 
   by = c("state_id", "year", "type", "imports")
  ) %>%  
  mutate(
    tons = tons*0.75 + tons_2
  ) %>%  
  select(-tons_2)

mi_imports <-
  michigan %>% 
  filter(
    imports!=0
  ) %>% 
  rename(
    origin = imports, 
    destination = state_id
  ) %>% 
  mutate(
    source_data = "MI", 
    county_name = NA, 
  ) %>% 
  select(year, county_name, tons, destination,origin, source_data)

michigan <- 
  michigan %>% 
  filter(imports==0) %>% 
  mutate(county_name = NA) %>% 
  select(year, state_id, county_name,type, tons)

# Minnesota -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

minnesota <- read.csv(paste0(state_data_path,"/Minnesota/import_R/treated.csv"))
names(minnesota) <- c("county_name", "type", "year", "tons")

minnesota <- 
  minnesota %>% 
  mutate(
    county_name = str_to_lower(county_name), 
    county_name = ifelse(county_name=="todd solid waste", "todd", county_name), 
    county_name = ifelse(county_name %in% c("st. louis - partial", "wlssd"), "st. louis", county_name), 
    state_id = "MN", 
    type = str_to_lower(type)
  )

rr <- 
  minnesota %>% 
  filter (county_name=="redwood/renville") %>%
  mutate(
    redwood = tons, 
    renville = tons
  ) %>%
  select(type, year, redwood, renville, state_id) %>% 
  pivot_longer(
    cols =c("redwood", "renville"),
    names_to = "county_name", 
    values_to = "tons"
  ) %>% 
  left_join(., population %>% mutate(year = as.integer(year)), by =c("year", "state_id", "county_name")) %>% 
  left_join(., 
            population %>% 
              mutate(year = as.integer(year)) %>% 
              filter(state_id == "MN", 
                     county_name %in% c("redwood", "renville")) %>% 
              group_by(year, state_id) %>% 
              summarise(sum_pop = sum(pop)), 
            by= c("year", "state_id")
  ) %>% 
  mutate(tons  = tons * pop/ sum_pop) %>% 
  select(county_name, type, year, tons, state_id)


pd <- 
  minnesota %>% 
  filter (county_name=="pope/douglas") %>%
  mutate(
    pope = tons, 
    douglas = tons) %>%
  select(type, year, pope, douglas, state_id) %>% 
  pivot_longer(
    cols =c("pope", "douglas"),
    names_to = "county_name", 
    values_to = "tons"
  ) %>% 
  left_join(., population %>% mutate(year = as.integer(year)), by =c("year", "state_id", "county_name")) %>% 
  left_join(., 
            population %>% 
              mutate(year = as.integer(year)) %>% 
              filter(state_id == "MN", 
                     county_name %in% c("pope", "douglas")) %>% 
              group_by(year, state_id) %>% 
              summarise(sum_pop = sum(pop)), 
            by= c("year", "state_id")
  ) %>% 
  mutate(tons  = tons * pop/ sum_pop) %>% 
  select(county_name, type, year, tons, state_id)

minnesota <- 
  minnesota %>% 
  rbind(., pd, rr) %>% 
  mutate(
    type = ifelse(type %in% c("organics", "msw composting"), "composting", type), 
    type = ifelse(type %in% c("wte","landfill", "onsite"), "disposal", type), 
    type = ifelse(type =="all", "generation", type), 
    type = ifelse(type =="recycling", "recycling", type)
  ) %>% 
  filter (
    !county_name %in% c("pope/douglas", "redwood/renville")
  )%>%
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons))%>% 
  select(year, state_id, county_name,type, tons)


# Mississippi -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#here tons refer to total waste, i have to subtract the imports
mississippi <- read.csv(paste0(state_data_path,"/Mississippi/import_R/mississippi.csv"))

mississippi <- 
  mississippi %>% as_tibble () %>%   
  rename(
    tons = total
  ) %>% 
  mutate( 
    tons = as.numeric(tons), 
    state_id = "MS", 
    county_name = NA, 
    type = "disposal"
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE), imports = sum(imports, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(
    tons = tons - imports
  ) %>% 
  pivot_longer(
    cols = c("tons", "imports"), 
    names_to = "imports", 
    values_to = "tons"
  ) %>% 
  mutate( imports = ifelse(imports=="imports", 1, 0))
  

ms_imports <- 
  mississippi %>%  
  filter(imports ==1 ) %>% 
  mutate(
    origin = "unknown", 
    source_data = "MS", 
    county_name = NA
  ) %>% 
  rename(destination = state_id) %>% 
  select(year, county_name, tons, destination,origin, source_data)


mississippi<- 
  mississippi %>%  
  filter(imports ==0 ) %>% 
  select(year, state_id, county_name,type, tons)

# Missouri -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

missouri <- read.csv(paste0(state_data_path,"/Missouri/import_R/missouri.csv"))


missouri <- 
  missouri %>% 
  pivot_longer(
    cols = c("Q1", "Q2", "Q3", "Q4"), 
    names_to = "quarter",
    values_to = "tons", 
    names_prefix = "Q_"
  ) %>%
  mutate(
    quarter = substr(quarter, 2,2), 
    date = paste0(year ,"-", quarter), 
    tons = tons %>% as.numeric
  ) %>% 
  group_by (year, type, date) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))

missouri$tons[missouri$date=="2019-4"]<-mean(missouri$tons[missouri$date %in% c("2018-4", "2020-4")])

missouri <- 
  missouri %>% 
  mutate (
    type = "disposal", 
    county_name = NA,
    state_id = "MO"
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise( tons = sum(tons, na.rm = TRUE))

# Nevada -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

nevada <- read.csv(paste0(state_data_path,"/Nevada/import_R/nevada.csv"))

nevada <- nevada %>%
  pivot_longer(
    cols = c("total_msw",
             "paper_total",
             "metals_total",
             "plastic_total",
             "glass_total" ,         
             "organics_total",
             "food_total",
             "special_waste_total",
             "textiles_total",
             "other_materials_total", 
             "msw_diverted"), 
    names_to = "material", 
    values_to = "tons"
  ) %>% 
  filter(material %in% c("msw_diverted", "organics_total", "total_msw")) %>% 
  mutate(
    county_name = ifelse(county_name == "carson city", "carson city (independent city)", county_name), 
    material = ifelse(material=="total_msw", "disposal", material), 
    material = ifelse(material=="organics_total", "composting", material), 
    material = ifelse(material=="msw_diverted", "recycling", material), 
    state_id = "NV"
  ) %>%
  rename(type = material) %>% 
  group_by(year,state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE))


# New Jersey -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
newjersey_composting <- read.csv(paste0(state_data_path,"/New Jersey/import_R/newjersey_composting.csv"))
newjersey <- read.csv(paste0(state_data_path,"/New Jersey/import_R/newjersey.csv"))


newjersey <-newjersey %>%  
  rename ( 
    year = Year, county_name=County, total_generation = Tons.Generation, 
    msw_generated = MSW_Total_Generation, msw_recycled =Recycling, msw_disposed = Disposal
  ) %>% 
  mutate(
    county_name = str_to_lower(county_name), 
    state_id = "NJ") %>% 
  pivot_longer(
    cols = c("total_generation", "msw_generated", "msw_recycled","msw_disposed"), 
    names_to = "type",
    values_to = "tons"
  ) %>%
  filter(
    type != "total_generation") %>% 
  group_by (year, state_id, county_name,type)%>% 
  summarize(tons=sum(tons)) %>% 
  rbind(
    newjersey_composting %>% 
      filter (
        material %in% c( "Brush/Tree Parts",
                         "Grass Clippings",
                         "Leaves", 
                         "Food Waste")) %>%
      mutate (
        county_name = str_to_lower(county_name), 
        material = str_to_lower(material), 
        material = "composting", 
        state_id = "NJ") %>% 
      rename (type = material)%>% 
      group_by(year, state_id, county_name, type) %>% 
      summarise(tons = sum(tons))
  ) %>% 
  mutate (
    type = ifelse(type=="msw_disposed", "disposal", type),
    type = ifelse(type=="msw_generated", "generation", type),
    type = ifelse(type=="msw_recycled", "recycling", type)
  )

# Add 2015 it is missing from the organics data (mean between 2015 and 2014)
newjersey <- rbind(
  newjersey, 
  newjersey %>% 
    filter( 
      type == "composting", 
      year >= 2014, 
      year <= 2016) %>% 
    group_by(state_id, county_name, type) %>% 
    summarise(tons = mean(tons, na.rm= TRUE)) %>% 
    mutate(year =  2015) %>% 
    select(year, state_id, county_name, type, tons))


# New Mexico -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
nm <- read.csv(paste0(state_data_path,"/New Mexico/import_R/nm.csv"))

nm <- 
  nm %>% 
  mutate(
    tons = as.numeric(tons)
  )%>%
  group_by (year, state_id, county_name, type) %>% 
  summarise (tons = sum(tons, na.rm=TRUE)) %>% 
  pivot_wider(
    names_from = type, 
    values_from = tons
  ) %>% 
  mutate(
    disposal = generation - recycling
  ) %>% 
  pivot_longer(
    cols= c("generation", "recycling", "disposal"), 
    names_to = "type", 
    values_to = "tons"
  ) 

# New York -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ny <- read.csv(paste0(state_data_path,"/New York/import_R/ny.csv"))

ny <-
  ny %>% 
  rename(
    waste_type = Waste.Type, 
    tons = Amount..in.tons., 
    to_from = Material.To.From, 
    county_name = County, 
    state_id = State
  ) %>% 
  filter(
    to_from %in% c("ADC - service area", "service area", "BUD - Service Area", "Service Area")
  ) %>% 
  select(
    year, waste_type, tons, county_name, state_id
  ) %>%  as_tibble %>% 
  mutate(
    state_id = ifelse(state_id == "QC", "CAN", state_id),
    state_id = ifelse(state_id %in% c("Not Reported", "not reported") & county_name=="Canada", "CAN", state_id), 
    county_name = str_to_lower(county_name)
  ) %>% 
  group_by(year, state_id, county_name) %>% 
  summarise(tons = sum(tons)) %>% 
  ungroup %>% 
  left_join(
    population %>%  filter(state_id=="NY") %>% select(county_name, year, pop), by =c("county_name", "year")
  )

ny_imports <-
  ny %>% 
  filter(!state_id %in% c("NY", "ON", "CAN", "Not Reported", "not reported")) %>%
  rename(origin = state_id) %>% 
  mutate(
    county_name = NA, 
    destination = "NY", 
    source_data = "NY"
  ) %>% select(year, county_name, tons, destination, origin, source_data)

ny <- 
  ny %>% 
  filter(state_id == "NY") %>% 
  mutate(type = "disposal") %>% 
  select(year, state_id, county_name, type, tons)
  
  

# North Carolina -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
nc <- read.csv(paste0(state_data_path,"/North Carolina/import_R/nc.csv"))
nc$county_name <- tolower(nc$county_name)
nc$year <- nc$year +1
nc <- as.data.frame(nc %>% group_by (year, county_name)%>% summarize(weight=sum(weight)))
nc <- as.data.frame(nc %>% group_by(county_name) %>% mutate(ma = zoo::rollmean(weight, k = 2, fill = weight)))

nc <- nc[,c("year", "county_name", "ma")]
colnames(nc) <- c("year", "county_name", "weight")
nc<- nc[nc$year <2021,] #no 2021 info
nc$date <- paste0(nc$year ,"-",1)
nc$state_id <- "NC"


nc <- 
  nc %>% 
  mutate(
    type = "disposal"
  ) %>%
  group_by (year, state_id, county_name, type) %>% 
  summarise (tons = sum(weight, na.rm=TRUE))

nc_imports <- read.csv(paste0(state_data_path,"/North Carolina/import_R/nc_imports_exports.csv"))

nc_imp<- 
  nc_imports %>%  
  rename(
    year = FINANCIAL.YEAR) %>%  
  group_by (year, state_id) %>% 
  summarise(
    exports = sum(exports), 
    imports = sum(imports, na.rm = TRUE)
  ) %>%  
  group_by(state_id) %>% 
  mutate(
    exports = zoo::rollmean(exports, k = 2, fill = exports),
    imports = zoo::rollmean(imports, k = 2, fill = imports)
  ) 

nc_imports <- 
  nc_imp %>% 
  select(year, state_id, imports) %>% 
  filter(imports > 0) %>% 
  rename(
    tons =imports, 
    origin =  state_id
  ) %>% 
  mutate(
    origin = "unknown", 
    source_data = "NC", 
    destination = "NC", 
    county_name = NA
  ) %>%   
  select(year, county_name, tons, destination,origin, source_data)


nc_exports <- 
  nc_imp %>% 
  select(year, state_id, exports) %>% 
  filter(!is.na(exports)) %>% 
  rename(
    tons =exports, 
    destination =  state_id
  ) %>% 
  mutate(
    origin = "NC", 
    source_data = "NC", 
    county_name = NA
  ) %>% 
  select(year, county_name, tons, destination,origin, source_data)

rm(nc_imp)

# Ohio -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ohio <- read.csv(paste0(state_data_path,"/Ohio/import_R/ohio_groups.csv"))
ohio$county_name <- tolower(ohio$county_name)

pop_oh <- population[population$state_id=="OH" & population$year> 1999,]
ohio <- merge(x=ohio, y=pop_oh, by=c("year", "county_name"), all.x=TRUE) 
ohio_no <- ohio[ohio$group==0,] # no need for extra treatment
ohio <- ohio[ohio$group!=0,] # counties that report together
a <- as.data.frame(ohio %>% group_by (group, year, type) %>% summarize(group_pop = sum(pop)))
ohio <- merge(x=ohio, y=a, by=c("year", "group", "type"), all.x= TRUE)
ohio$tons <- ohio$tons* ohio$pop/ohio$group_pop
ohio <- ohio[,c("year", "county_name","type","tons", "group", "state_id", "pop")]
ohio <- rbind(ohio, ohio_no)
ohio$type[ohio$type=="Disposed"] <- "disposal"
ohio$type[ohio$type=="Reduced/Recycled"] <- "recycling"
f <- as.data.frame (
  ohio %>% 
    group_by(year, county_name, state_id, pop) %>% 
    summarize(tons=sum(tons, na.rm = TRUE)))
f$type <- "generation"
ohio <- rbind(f   [,c("state_id", "county_name", "year", "type","tons" , "pop")],
              ohio[,c("state_id", "county_name", "year", "type","tons" , "pop")])


ohio <- 
  ohio %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise (tons = sum(tons, na.rm=TRUE))

ohio_imports <- read.csv(paste0(state_data_path,"/Ohio/import_R/ohio_imports.csv"))
ohio_exports<- read.csv(paste0(state_data_path,"/Ohio/import_R/ohio_exports.csv"))

ohio_imports<-
  ohio_imports %>% as_tibble()%>% 
  left_join(
    tibble(
      state_name = state.name, 
      state_id = state.abb
    ), 
    by = "state_name"
  ) %>% 
  rename(origin =  state_id) %>% select(-state_name) %>%  
  mutate(
    #percentage = mean(actual_msw/tons, na.rm = TRUE), # use max to get the 2018 percentage
    county_name = NA, 
    destination = "OH", 
    source_data = "OH" 
    #tons = tons *percentage, #ususal percentage of MSW - additional conservative, 
    #tons = ifelse(!is.na(actual_msw), actual_msw, tons)
  ) %>%  
  select(year, county_name, tons, origin, destination, source_data)


ohio_exports<-
  ohio_exports %>% as_tibble()%>% 
  left_join(
    tibble(
      state_name = state.name, 
      state_id = state.abb
    ), 
    by = "state_name"
  ) %>% 
  rename(destination = state_id) %>% select(-state_name) %>%  
  mutate(
    county_name = NA, 
    origin = "OH", 
    source_data = "OH", 
    tons = tons *0.7* 0.5 #ususal percentage of MSW - additional conservative
  ) %>%  
  select(year, county_name, tons, origin, destination, source_data)

# Oklahoma -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
oklahoma <- read.csv(paste0(state_data_path,"/Oklahoma/import_R/oklahoma.csv"))

oklahoma <-
  oklahoma %>% 
  rename(
    tons = tons_reported
  ) %>% 
  mutate(
    state_id = "OK", 
    type = "disposal", 
    county_name = NA
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise (tons = sum(tons, na.rm=TRUE)) %>% 
  mutate(tons=0.7*tons) #usual percentage of MSW

# Oregon -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

oregon_disposed <- read.csv(paste0(state_data_path,"/Oregon/import_R/oregon_disposed.csv"))
oregon_generated <- read.csv(paste0(state_data_path,"/Oregon/import_R/oregon_generated.csv"))
oregon_recovered <- read.csv(paste0(state_data_path,"/Oregon/import_R/oregon_recovered.csv"))
oregon_composting <- read.csv(paste0(state_data_path,"/Oregon/import_R/oregon_composting.csv"))

oregon <- 
  oregon_disposed %>% 
  rbind(oregon_generated, oregon_recovered) %>% 
  pivot_longer(
    cols= 3:30,
    names_to = "year", 
    values_to = "tons") %>% 
  mutate(
    year = substr(year, 2, 5) %>% as.integer, 
    county_name = str_to_lower(county_name)) %>%
  rbind ( # adding composting too
    oregon_composting %>% 
      rename(
        county_name = Wasteshed, 
        type = Name) %>% 
      mutate(
        county_name = str_to_lower(county_name), 
        type = str_to_lower(type))  
  ) %>% 
  filter (county_name == "metro") %>% # handling metro
  select(type, year, tons) %>% 
  mutate (
    multnomah  = tons, 
    clackamas =  tons, 
    washington = tons, 
    state_id = "OR") %>% 
  pivot_longer(
    cols = c("clackamas", "multnomah", "washington"), 
    names_to = "county_name", 
    values_to = "value") %>% 
  select(type, year, value, state_id, county_name) %>% 
  rename(tons = value) %>% 
  left_join(., population %>% mutate(year=as.integer(year)), by =c("county_name", "year", "state_id"))%>% 
  left_join(., population %>% 
              mutate(year=as.integer(year)) %>% 
              filter(county_name %in% c("clackamas", "multnomah", "washington"), 
                     state_id == "OR") %>% 
              group_by (year, state_id) %>% 
              summarise(state_pop = sum(pop)), by =c("year", "state_id")) %>%
  mutate(
    tons = tons * pop / state_pop) %>% 
  select(county_name, type, year, tons) %>% 
  rbind(
    oregon_disposed %>% 
      rbind(oregon_generated, oregon_recovered) %>% 
      pivot_longer(
        cols= 3:30,
        names_to = "year", 
        values_to = "tons") %>% 
      mutate(
        year = substr(year, 2, 5) %>% as.integer, 
        county_name = str_to_lower(county_name)) %>% 
      filter (county_name != "metro"), 
    
    oregon_composting %>% 
      rename(
        county_name = Wasteshed, 
        type = Name) %>% 
      mutate(
        county_name = str_to_lower(county_name), 
        type = str_to_lower(type))%>% 
      filter (county_name != "metro")
  ) %>% 
  mutate(
    county_name = ifelse(county_name %in% c("milton freewater", "milton-freew."), "umatilla", county_name), 
    state_id = "OR", 
    type = ifelse(type == "food waste", "organics", type)
  ) %>% 
  select(year, state_id, county_name,type, tons) 


oregon <- 
  oregon %>%
  group_by(year, state_id, type, county_name) %>% 
  summarise(tons = sum(tons)) %>% 
  mutate(
    type = ifelse(type == "msw_disposed","disposal", type), 
    type = ifelse(type == "msw_recycled", "recycling", type), 
    type = ifelse(type == "organics", "composting", type),
  ) %>%  ungroup %>% select(year, state_id, county_name, type, tons)



# Pennsylvania -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

pen <- read.csv(paste0(state_data_path,"/Pennsylvania/import_R/pen_v2.csv"))
pen_composting <- read.csv(paste0(state_data_path,"/Pennsylvania/import_R/pen_composting.csv"))
pen_recycling <- read.csv(paste0(state_data_path,"/Pennsylvania/import_R/pen_recycling.csv"))


pen <- 
  pen %>% 
  rename(
    county_name=County.State.Waste.Origination, 
    msw = Municipal
  ) %>%  
  select(
    county_name, msw, year, pa_cnty_or_st_code
  ) %>%  as_tibble %>% 
  mutate(
    county_name = str_to_lower(county_name), 
    imports = ifelse(pa_cnty_or_st_code %in% state.abb, pa_cnty_or_st_code , 0) 
  ) %>%  
  group_by(county_name, year, imports) %>% 
  summarise(
    tons = sum(msw)
  ) %>% 
  mutate(
    state_id = "PA", 
    type = "disposal"
  ) %>%  
  group_by(state_id, year, type, imports, county_name) %>% 
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  select(
    year, state_id, county_name, type, tons, imports
  ) %>% 
  filter(!county_name %in% c("canada","district of columbia", "puerto rico"))


pa_imports <- 
  pen %>% 
  filter(imports!=0, tons >0) %>%
  group_by(imports, year, state_id, type) %>% 
  summarise(tons = sum(tons)) %>% 
  rename(
    origin = imports, 
    destination = state_id
  ) %>% 
  mutate(source_data = "PA", county_name = NA) %>% 
  select(year, county_name, tons, destination, origin, source_data)


pen <- 
  pen %>% filter(imports ==0) %>% ungroup %>%
  select(-imports) %>% 
  rbind(
    pen_recycling %>%  as_tibble() %>% 
      rename(
        county_name = County, 
        year = Year
      ) %>% 
      mutate(
        county_name = tolower(county_name), 
        state_id = "PA", 
        type = "recycling") %>% 
      filter(
        year > 1995, 
        year < 2021
      ) %>% 
      group_by(year,county_name, type, state_id) %>% 
      summarise(tons = sum(tons)) %>%  
      select(
        year, state_id, county_name, type, tons
      ), 
    
    pen_composting %>% 
      pivot_longer(
        cols = c("food_res","wood_res", "yard_res", "food", "wood", "yard"), 
        names_to = "item",
        values_to = "tons") %>% 
      mutate (
        county = tolower(county), 
        item = ifelse(
          str_detect(item, "_"), 
          substr(item, 1, 4), 
          item)) %>% 
      rename(county_name = county) %>% 
      group_by (year, county_name, item) %>% 
      summarise(tons  = sum(tons, na.rm=TRUE)) %>% 
      mutate(
        type = "composting", 
        state_id = "PA") %>% 
      select(
        year, state_id, county_name, type, tons
      )
  )


rm(pen_recycling)



# Rhode Island -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ri <-  read.csv(paste0(state_data_path,"/Rhode Island/import_R/ri_v2.csv"))

ri <- 
  ri %>%
  mutate(
    tons = as.numeric(tons), 
    county_name = NA, 
    type = "disposal", 
    state_id = "RI"
  ) %>%
  mutate(
    ici = ifelse(year<2016, tons*factor_for_landfill, total_ridem*factor_for_ridem-residential), 
    tons = ici + residential, 
    county_name= NA, 
    type = "disposal", 
    state_id = "RI"
  ) %>%  select(year, state_id, county_name, type, tons)
  
#for 2009 i use the average of 2008 and 2010, it is abnormally low
# for 2020 i don't multiply with 0.62 because it seems like that number is MSW (also is similar to numbers from RIDEM)

# South Carolina -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

sc <- read.csv(paste0(state_data_path,"/South Carolina/import_R/sc.csv"))

sc <- 
  sc %>% 
  mutate(
    county_name = str_to_lower(county_name)) %>% 
  pivot_longer(
    cols= c("msw_recycled","msw_disposed", "msw_generated", "food_waste", "organics"), 
    names_to = "type",
    values_to = "tons") %>% 
  filter(year < 2021) %>% 
  mutate(
    state_id = "SC", 
    type = ifelse(type %in% c("food_waste", "organics"), "composting", type), 
    type = ifelse(type == "msw_recycled", "recycling", type), 
    type = ifelse(type == "msw_disposed", "disposal", type), 
    type = ifelse(type == "msw_generated", "generation", type)
  )%>% 
  group_by(year, state_id, county_name, type) %>%
  summarise(tons = sum(tons, na.rm = TRUE))

#make it into calendar year, when it says 2017 it means jan-jun 2016 and july- dec 2017

sc <- 
  sc %>%  
  group_by(county_name, type) %>% 
  mutate(
    tons = zoo::rollmean(tons, k = 2, fill = tons)
  )


# Tennessee -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
tn_disposal <- read.csv(paste0(state_data_path,"/Tennessee/import_R/tn_disposal.csv"))
tn_diversion <- read.csv(paste0(state_data_path,"/Tennessee/import_R/tn_diversion.csv"))

tn <-
  #this disposal includes exports
  tn_disposal %>% 
  mutate(
    state_id = "TN", 
    type = "disposal") %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons= sum(tons,na.rm = TRUE)) %>% 
  rbind(
    tn_diversion %>% 
      pivot_longer(
        cols = c("recycling", "food_donation", "composting"), 
        names_to = "type", 
        values_to = "tons"
      ) %>% 
      mutate(
        state_id = "TN", 
        county_name = ifelse(county_name == "town of jonesborough", "washington", county_name)
      )%>% 
      group_by (year, state_id, county_name, type) %>% 
      summarise(tons= sum(tons,na.rm = TRUE))
  ) %>% 
  filter(
    !county_name %in% c("test account tdec", "davidson dd test")
  )

tn_exports <- 
  tn_disposal %>%  as_tibble %>%  
  filter(type %in% c("Class I - Exported out of Tennessee", "Class 1 - Exported out of Tennessee")) %>% 
  mutate(
    landfill_name = tolower(landfill_name)
  ) %>% 
  rename(
    state_name = landfill_name
  ) %>% 
  left_join(
    cbind (
      state_id = state.abb, 
      state_name = state.name
    ) %>% as_tibble %>% 
      mutate(
        state_name = str_to_lower(state_name)
      ), 
    by = c("state_name")
  ) %>%  
  group_by(year, county_name, state_id) %>% 
  summarise(tons = sum(tons, na.rm=TRUE)) %>% 
  rename(destination = state_id) %>% 
  mutate(
    origin = "TN", 
    source_data = "TN", 
    destination = ifelse(is.na(destination), "unknown", destination)
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data)

tn <- 
  tn %>% filter(!county_name %in% c("santek", "hoth")) %>% 
  left_join(
    tn %>% 
      filter(county_name %in% c("santek", "hoth")) %>% 
      group_by (year, state_id, type) %>% 
      summarise (tons_unaccounted = sum(tons)) %>% 
      left_join (
        population %>% 
          group_by (state_id, year) %>% 
          summarise(state_pop= sum(pop)), 
        by = c("state_id",  "year")
        ), 
    by = c("type", "year", "state_id")
  ) %>% 
  left_join(population, by =c("state_id", "county_name", "year")) %>% 
  mutate (
    tons = ifelse(is.na(tons_unaccounted), tons, tons +tons_unaccounted*pop/state_pop)
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons= sum(tons,na.rm = TRUE)) %>% 
  ungroup


# Texas -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
texas <- read.csv(paste0(state_data_path,"/Texas/import_R/texas.csv"))

texas <- 
  texas %>% 
  mutate(
    state_id = "TX", 
    type = "disposal", 
    county_name = NA
  ) %>% 
  filter(year > 1991) %>% 
  mutate(
    msw_percentage = ifelse(is.na(msw_percentage), 0.66, msw_percentage), 
    tons = msw_percentage* tons
  ) %>% 
  group_by (year, state_id, county_name, type) %>% 
  summarise(tons= sum(tons,na.rm = TRUE))  

tx_imports <- read.csv(paste0(state_data_path,"/Texas/import_R/imports.csv"))

tx_imports<-
  tx_imports %>%  as_tibble () %>%  
  mutate(
    destination = "TX", 
    origin = "unknown", 
    source_data = "TX",
    tons = imports,
    county_name = NA
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data)

texas <- 
  texas %>% 
  left_join(
    tx_imports %>% rename(imports = tons) %>% select(year, imports), 
    by = "year"
  ) %>% 
  mutate(
    imports = ifelse(is.na(imports), 34000, imports),
    tons = tons - imports
  ) %>% 
  select(-imports) %>%  ungroup

# Utah -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

utah <- read.csv(paste0(state_data_path,"/Utah/import_R/utah_2.csv"))

utah <- 
  utah %>% 
  rename (
      disposal = inStateMunicipalTotal, 
      composting = inStateCompostTotal, 
      recycling = tonsRecycled, 
      county_name = county, 
      year = reportPeriod) %>% 
    filter(facilityType!="Transfer Station") %>%
    pivot_longer(
      cols = c("disposal", "recycling", "composting"), 
      names_to = "type", 
      values_to = "tons") %>%
    filter(!is.na(tons)) 
    

utah <- 
  utah %>% 
  group_by(year, county_name, type, tons) %>% 
  summarize(number=n()) %>% 
  filter(number!=1) %>%
  rbind(
    utah %>% 
      filter(facilityType!="Transfer Station") %>%
      group_by(year, county_name, type, tons) %>% 
      summarize(number=n()) %>% 
      filter(number==1)
  ) %>%   
  mutate(
    state_id ="UT",
    county_name = NA
  ) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarize(tons=sum(tons, na.rm = TRUE)) 


# Vermont -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

vermont <- read.csv(paste0(state_data_path,"/Vermont/import_R/vermont.csv"))
vermont_composting <- read.csv(paste0(state_data_path,"/Vermont/import_R/vermont_composting.csv"))
vt_exports <- read.csv(paste0(state_data_path,"/Vermont/import_R/vermont_export.csv"))

vermont <- 
  vermont %>% 
  pivot_longer(
    cols = c("msw_generated", "msw_diverted","msw_disposed"), 
    names_to = "type", 
    values_to = "tons") %>% 
  rbind (., vermont_composting %>% 
           rename(organics=Organics, 
                  food_rescue = Food.Rescue) %>% 
           pivot_longer(
             cols= c("organics", "food_rescue"), 
             names_to = "type", 
             values_to = "tons") %>% 
           mutate(state_id = "VT") %>% 
           select(year, state_id, type, tons)) %>% 
  mutate(
    county_name = NA, 
    type = ifelse(type == "msw_diverted", "recycling", type), 
    type = ifelse(type == "msw_disposed", "disposal", type), 
    type = ifelse(type == "msw_generated", "generation", type),
    type = ifelse(type %in% c("organics", "food_rescue"), "composting", type)
  ) 

vt_exports<-
  vt_exports %>%  filter(state_id!= "VT") %>% as_tibble() %>% 
  rename(
    destination = state_id
  ) %>% 
  mutate(
    origin = "VT", 
    source_data = "VT", 
    county_name = NA
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data)



# Washington -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

wa <- read.csv(paste0(state_data_path,"/Washington/import_R/wa.csv"))

wa <- 
  wa %>% 
  mutate(
    county_name = str_to_lower(county_name), 
    type = "disposal", 
    state_id = "WA"
  ) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE)) %>% 
  filter(
    !county_name %in% c(
      "unknown county", 
      "unknown", 
      "_unknown", 
      "_unspecified", 
      "unspecified", 
      "out of state")) # OOS WASTE ONLY IN 2017


# Wisconsin -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
wi <- read.csv(paste0(state_data_path,"/Wisconsin/import_R/wi.csv"))

wi <- 
  wi %>% 
  mutate(
    county_name = str_to_lower(county_name), 
    state_id = "WI", 
    tons = as.numeric(tons),
    imported_tons = as.numeric(imported_tons), 
    county_name = NA, #disposal is reported by facilities
    tons = ifelse(is.na(tons), 0, tons)
  ) %>% 
  group_by(year, state_id, county_name, type) %>% 
  summarise(tons = sum(tons, na.rm = TRUE)) %>% 
  pivot_wider(
    names_from = "type", 
    values_from = "tons") %>% 
  mutate(
    disposal = ifelse(!is.na(exported), disposal-imported+exported, disposal)
  )%>% 
  select(year, state_id, county_name, disposal, recycling) %>% 
  pivot_longer(
    cols = c("disposal", "recycling"), 
    names_to = "type", 
    values_to = "tons"
  )


wi_imports <-  read.csv(paste0(state_data_path,"/Wisconsin/import_R/wi_imports.csv"))

wi_imports<-
  wi_imports %>%  as_tibble %>% 
  filter(
    imports >0
  ) %>% 
  rename(
    tons = imports, 
    origin =state_id
  ) %>% 
  mutate(
    destination = "WI", 
    source_data = "WI", 
    county_name = NA
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data)


wi_exports <-  read.csv(paste0(state_data_path,"/Wisconsin/import_R/wi_exports.csv"))

wi_exports<-
  wi_exports %>%  as_tibble %>% 
  filter(
    exports >0
  ) %>% 
  rename(
    tons = exports, 
    destination =state_id
  ) %>% 
  mutate(
    origin = "WI", 
    source_data = "WI", 
    county_name = NA
  ) %>% 
  select(year, county_name, tons, destination, origin, source_data)

#for wisconsin imports and exports prior to 2005 are not available so i will drop the data prior to 2005

wi <- 
  wi %>% 
  filter(year >= 2005) %>% 
  left_join(
    wi_exports %>%  group_by(year) %>%  summarise(exported_tons = sum(tons, na.rm = TRUE)), 
    by = "year"
  ) %>% 
  left_join(
    wi_imports %>%  group_by(year) %>%  summarise(imported_tons = sum(tons, na.rm = TRUE)), 
    by = "year"
  ) %>% 
  mutate(
    imported_tons = ifelse(is.na(imported_tons), 0, imported_tons),
    exported_tons = ifelse(is.na(exported_tons), 0, exported_tons),
    tons = tons - imported_tons + exported_tons
  )%>% select(year, state_id, county_name, type, tons)


```


## Combining Everything

```{r, echo=FALSE}

power2 <- 
  rbind(
    alabama,
    arizona, 
    california, 
    colorado, 
    delaware,
    florida, 
    georgia, 
    illinois, 
    indiana, 
    iowa, 
    kentucky, 
    maine, 
    maryland, 
    ma,
    michigan,
    minnesota,
    mississippi,
    missouri,
    nevada,
    newjersey,
    nm,
    ny,
    nc,
    ohio,
    oklahoma,
    oregon,
    pen,
    ri,
    sc,
    tn,
    texas,
    utah,
    vermont,
    wa,
    wi
  ) %>% 
  mutate(
    year = as.integer(year)
  )

#write.csv(power2, "power2_2.csv", row.names = FALSE)


# rm(
#   arizona, california, colorado, connecticut, alabama,
#   delaware,florida, georgia,  illinois,  indiana, iowa,
#   kentucky, maine, maryland, ma, michigan, minnesota, mississippi,
#   missouri,  nevada,  newjersey, nm, nc, ohio, oklahoma, oregon, pen, ri,
#   sc, tn, texas, utah, vermont, wa,  wi, a, f, f3, newjersey_composting, ohio_no,
#   oregon_composting, oregon_disposed, oregon_generated, oregon_recovered, pd,
#   pen_composting, pop_oh, rr, tn_disposal, vermont_composting, tn_diversion
# )


```
## Imports- Exports

```{r}
imports <- rbind(
  al_imports,
  ia_imports, 
  il_imports, 
  in_imports, 
  ky_imports, 
  ma_imports, 
  mi_imports, 
  ms_imports, 
  ny_imports, 
  nc_imports,
  ohio_imports,
  pa_imports, 
  tx_imports, 
  wi_imports
) %>%  ungroup


exports <- rbind(
  ca_exports, 
  ia_exports, 
  ma_exports, 
  md_exports, 
  nc_exports,
  ohio_exports, 
  tn_exports, 
  vt_exports, 
  wi_exports
) %>%  ungroup

rm(
  ct_imports,
  ia_imports,
  il_imports,
  in_imports,
  ky_imports,
  ma_imports,
  mi_imports,
  ms_imports,
  nc_imports,
  pa_imports,
  tx_imports,
  wi_imports,
  ca_exports,
  ct_exports,
  ia_exports,
  ma_exports,
  nc_exports,
  tn_exports,
  vt_exports,
  wi_exports, 
  al_imports
)
#   
```

### Connecticut 

```{r}
msw_lf <- read.csv(paste0(state_data_path,"/Connecticut/vol2/MSW_LF.csv"))
msw_oos <- read.csv(paste0(state_data_path,"/Connecticut/vol2/MSW_OOS.csv"))
composting <- read.csv(paste0(state_data_path,"/Connecticut/import_R/composting.csv"))
recycling <- read.csv(paste0(state_data_path,"/Connecticut/import_R/MSW_Recycling.csv"))
counties_cities <- read.csv(paste0(state_data_path,"/Connecticut/import_R/counties_cities.csv"))

# Excluding facilities that are for recycling or for CD
facility_exc <-   
  msw_lf %>%
  as_tibble() %>%
  rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
  group_by(town, year, source_facility) %>%
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  mutate(town = str_to_lower(town)) %>%
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
  filter(is.na(county), town %in% c("town not selected")) %>% 
  mutate(source_facility = ifelse(str_detect(source_facility, "WINTER"), "WINTER BROS", source_facility)) %>% 
  group_by(source_facility) %>% summarise(n = n()) %>%  
  filter(str_detect(source_facility, "RECY")|
           str_detect(source_facility, "C&D")) %>%  
  pluck ("source_facility")

facility_exc <- c(facility_exc, "MID - CT RRF")

# tons that come from many counties
na_tons <-
  msw_lf %>%
  as_tibble() %>%
  rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
  group_by(town, year, source_facility) %>%
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  mutate(town = str_to_lower(town)) %>%
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
  filter(is.na(county), town %in% c("town not selected")) %>% 
  mutate(source_facility = ifelse(str_detect(source_facility, "WINTER"), "WINTER BROS", source_facility)) %>% 
  filter(!source_facility %in% facility_exc) %>% 
  group_by (year) %>% summarise(tons_na  = sum(tons))

# tons that are from excluded counties but seem to be double counts
excluded_tons <- 
  msw_lf %>%
  as_tibble() %>%
  rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
  group_by(town, year, facility) %>%
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  mutate(town = str_to_lower(town)) %>%
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
  filter(!is.na(county)) %>% 
  group_by (year, facility) %>% summarise(tons  = sum(tons)) %>% 
  left_join(
    msw_lf %>%
      as_tibble() %>%
      rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
      group_by(town, year, source_facility) %>%
      summarise(tons = sum(tons, na.rm = TRUE)) %>%
      mutate(town = str_to_lower(town)) %>%
      left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
      filter(is.na(county), town %in% c("town not selected")) %>% 
      filter(!source_facility %in% facility_exc) %>% 
      ungroup %>% 
      group_by(year, source_facility) %>% 
      summarise(tons_na = sum(tons)), 
    by =c("year", "facility"= "source_facility")
  ) %>% filter(!is.na(tons_na)) %>% group_by(year) %>% summarise(tons_exc = sum(tons_na))

# Exports
ct_exports <-
  msw_oos %>%
  rename(town = Origin.TownName , year = ReportYear, tons = Msw, destination = State) %>%
  group_by(year, destination) %>% summarise(exports = sum(tons, na.rm = TRUE)) %>% #group_by(year) %>% summarise(exports = sum(exports)) %>%
  left_join(
    rbind(imports,exports) %>% filter(origin == "CT", source_data != "CT") %>%
      select(year, destination, tons) %>% rename(exports_2= tons),
    by = c("year", "destination")
  )%>%
  filter(!destination %in% c("OS", "OOS")) %>%
  mutate(
    exports = ifelse(destination%in% c("MA", "OH") & year> 2014 & year < 2020, exports_2, exports),
    exports = ifelse(destination%in% c("NY") & year> 2014 & year < 2019, exports_2, exports)) %>%
  mutate(
    county_name = NA,
    source_data = "CT",
    origin = "CT",
    tons = exports
  ) %>% ungroup %>% select(year, county_name, tons, destination, origin, source_data)

# Imports
ct_imports <- 
  msw_lf %>%
  as_tibble() %>%
  rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
  group_by(town, year, source_facility) %>%
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  mutate(town = str_to_lower(town)) %>%
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
  filter(is.na(county), town %in% c("massachusetts", "new jersey", "new york", "rhode island", "vermont")) %>% 
  left_join(
    tibble (state_name = state.name %>% str_to_lower(), state_id = state.abb), 
    by = c("town"="state_name")
  ) %>% 
  rename(origin =state_id) %>% 
  mutate(destination = "CT", source_data = "CT", county_name = NA)%>% 
  ungroup %>% select(year, county_name, tons, destination, origin, source_data)

# Final
connecticut <- 
  msw_lf %>%
  as_tibble() %>%
  rename(town = TownName, year = ReportYear, tons = SumOfMsw, facility=Reporting.Facility.Name, source_facility = Source.Facility.Name..if.not.from.Town.) %>%
  group_by(town, year, source_facility) %>%
  summarise(tons = sum(tons, na.rm = TRUE)) %>%
  mutate(town = str_to_lower(town)) %>%
  left_join(., counties_cities, by =c("town"), all.x= TRUE) %>%
  filter(!is.na(county)) %>% 
  group_by (year, county) %>% 
  summarise(tons  = sum(tons)) %>% 
  left_join( # Adding NA tons
    na_tons %>%  
      left_join(excluded_tons, by= "year") %>% 
      mutate( # Excluding double counts
        tons_exc = ifelse(is.na(tons_exc), 0, tons_exc), 
        tons_na = tons_na - tons_exc
      ) %>% select(year, tons_na)
  ) %>% 
  left_join(
    ct_exports %>%
      group_by(year) %>% 
      summarise(exports = sum(tons)) %>% 
      #mutate(exports = ifelse(year == 2015, (lag(exports,n=1, default=NA)+lead(exports,n=1, default=NA))/2, exports)) %>% 
      ungroup, 
    by = "year"
  ) %>% 
  rename(county_name = county) %>% 
  mutate(state_id = "CT") %>% 
  left_join(
    population, by = c("state_id", "year", "county_name")
  ) %>% 
  group_by(year) %>% 
  mutate( # distributing based on population
    state_pop = sum(pop), 
    exports = ifelse(is.na(exports), 0, exports), 
    tons = tons+(exports+tons_na) *pop/state_pop, 
    type = "disposal") %>% 
  ungroup %>% 
  select(year, state_id, county_name, type, tons) %>% 
  rbind(
    #recycling
    recycling %>% 
      as_tibble %>% 
      mutate(
        town = str_to_lower(town), 
        facility_name = str_to_lower(facility_name)
      ) %>% 
      filter(
        !town %in% c("international", "massachusetts", "new jersey", "new york", "rhode island", "vermont") 
      ) %>% 
      group_by (year, town) %>% 
      summarise(
        residential = sum(residential, na.rm = TRUE), 
        nonresidential = sum(nonresidential, na.rm = TRUE), 
        mixed = sum(mixed, na.rm = TRUE), 
        tons = sum(total, na.rm = TRUE)
      ) %>% 
      ungroup %>% 
      left_join(counties_cities, by =c("town"), all.x= TRUE) %>% 
      mutate (state_id = "CT", type = "recycling") %>% 
      rename (county_name = county) %>%
      select(year, state_id, county_name, type, tons), 
    # composting
    composting %>% 
      filter(
        !town %in% c("international", "massachusetts", "new jersey", "new york", "rhode island", "vermont"), 
        item %in% c("COMPOST - FINISHED", "YARD WASTE COMPOST")) %>% # compost finished AND LEAVES ARE THE SAME if i include both i double count
      group_by(town, year) %>%
      summarise( tons = sum(totals, na.rm = TRUE)) %>% 
      left_join(., counties_cities, by =c("town"), all.x= TRUE) %>% 
      group_by(year, county) %>% 
      summarise( tons = sum(tons, na.rm = TRUE)) %>% 
      mutate (type = "composting") %>% filter(!is.na(county)) %>% 
      ungroup %>% 
      rename(county_name = county) %>% mutate(state_id = "CT") %>% 
      select(year, state_id, county_name, type, tons)
  )

rm(facility_exc, na_tons, excluded_tons, msw_lf, recycling, composting, counties_cities, msw_oos)
```

#### Integrating CT 

```{r}
imports <- rbind(imports, ct_imports)
exports <- rbind(exports, ct_exports)
power2 <- rbind(power2, connecticut)
```


### Tennessee Data

For TN, there are some entries that have "unknown" export state. 
However, we have the counties where the waste originated from. I assume hat it. 

Hamilton county borders with both GA and AL. I use AL because historically more waste was sent there. 

```{r}

exports<-
  exports %>% 
  left_join(
    data.frame(
      county_name = c(
        "Fayette", "Hamilton", "Hardin", "Sequatchie", "Shelby", "Bradley", 
        "McNairy", "Tipton", "Lauderdale", "Lawrence", "Cheatham"),
      bordering_state = c("MS", "AL", "MS", "GA", "MS", "GA", "MS", "MS", "MS", "AL", "KY") 
    ) %>% mutate(county_name = tolower(county_name)), 
    by = c("county_name")
  ) %>%  
  mutate(
    destination = ifelse(destination=="unknown" & !is.na(bordering_state), bordering_state, destination)
  ) %>% 
  select(-bordering_state)
  


```


### Overlapping Data
```{r, eval=FALSE}
#here we find which pairs have overlapping data
msw_oos <- read.csv(paste0(state_data_path,"/Connecticut/vol2/MSW_OOS.csv"))

overlapping <- rbind(
  imports, 
  exports %>% 
    filter(source_data!="CT") %>% #exclude CT data because I have already processed them
    rbind( # and include raw CT data 
    msw_oos %>%
    rename(town = Origin.TownName , year = ReportYear, tons = Msw, destination = State) %>%
    group_by(year, destination) %>% summarise(exports = sum(tons, na.rm = TRUE)) %>% #group_by(year) %>% summarise(exports = sum(exports)) %>%
    mutate(
        county_name = NA,
        source_data = "CT",
        origin = "CT",
        tons = exports
    ) %>% ungroup %>% select(year, county_name, tons, destination, origin, source_data))
) %>%  
  group_by(origin, destination, source_data, year) %>%
  summarise(tons = sum(tons)) %>%
  group_by(origin, destination, year) %>%
  summarise(n = n()) %>%
  filter(
    n>1
  ) %>%  summarise(source_data=unique(origin, destination)) %>% select(-source_data) %>% 
  mutate(
    id  = paste0(origin, " -> ",destination) 
  ) %>% pluck("id")

discrepancies_plot <- 
  rbind(
    imports, 
    exports %>% 
      filter(source_data!="CT") %>% #exclude CT data because I have already processed them
      rbind( # and include raw CT data 
        msw_oos %>%
          rename(town = Origin.TownName , year = ReportYear, tons = Msw, destination = State) %>%
          group_by(year, destination) %>% summarise(exports = sum(tons, na.rm = TRUE)) %>% #group_by(year) %>% summarise(exports = sum(exports)) %>%
          mutate(
            county_name = NA,
            source_data = "CT",
            origin = "CT",
            tons = exports
          ) %>% ungroup %>% select(year, county_name, tons, destination, origin, source_data))
  ) %>% 
  mutate(
    id = paste0(origin, " -> ",destination)
  ) %>% 
  filter(
    id %in% overlapping, 
    !id %in% c("WI -> IA")
  ) %>% group_by(year, source_data, id) %>% 
  summarise(
    tons = sum(tons)
  ) %>% 
  mutate(
    source_data = ifelse(source_data == substr(id, start=1, stop=2), "Origin", "Destination")
  ) %>% 
  group_by(id) %>% 
  filter(year >= 2005, min(tons)> 1000) %>%  
  ggplot()+
  geom_line(aes(x=year, y=tons/10^3, color = source_data))+
  facet_wrap(vars(id), ncol = 4, scales="free") +
  scale_color_manual (values= c("#1F77B4", "#FF7F0E"))+
  scale_y_continuous(breaks = scales::pretty_breaks(3))+
  labs(x= "", color = "Data from: ", y = TeX("Tons ('000)"))+
  theme_classic()+
  theme(
    strip.background = element_rect(color = "white", fill = "white"),
    panel.grid.major.x = element_blank() ,
    panel.grid.major.y = element_blank(), 
    text = element_text(family = "Helvetica",size = 15, color = ut_colors[4]), 
    axis.line.x = element_blank(),
    axis.line.y = element_blank(), 
    legend.position = "top"
  )
discrepancies_plot

ggsave(discrepancies_plot, filename = "discrepancies_plot.pdf", device = cairo_pdf,
       path= figure_path,
       width = 14, height = 7, dpi=320, units = "in")

#rm(msw_oos)
```


### Exports -Imports Plots

```{r, eval=FALSE}

coordinates <- 
  tibble(
    state_id = state.abb, 
    x = state.center$x, 
    y = state.center$y
  ) %>% 
  rbind(
    tibble(
      state_id = "unknown", 
      x= -75, 
      y =32
    )
  )

impoexpo <- 
  rbind(
    exports, 
    imports
  ) %>% 
  mutate(
    id = paste0(origin, destination)
  ) %>% 
  group_by(origin, destination, year, source_data) %>% 
  summarise(
    tons = sum(tons, na.rm=TRUE)
  ) %>% 
  group_by(origin, destination, year) %>% 
  summarise(
    tons = mean(tons, na.rm = TRUE)
  ) %>% 
  filter(tons >0) %>% 
  left_join (
    coordinates , by = c("origin" = "state_id")
  ) %>%  rename(origin_x=x, origin_y=y) %>% 
  left_join(
    coordinates , by = c("destination" = "state_id")
  ) %>%  rename(destination_x=x, destination_y=y) %>% 
  mutate(
    destination_x = destination_x+0.5
  )



map_plot_function <- function (dt, year_chosen)
{
  usMap <- borders("state", colour="white", fill="grey90")

  ggplot() + usMap +
  geom_curve(
    data=dt %>% filter(year == year_chosen),
    aes(x=origin_x, y=origin_y, xend=destination_x, yend=destination_y),
    col="grey70",
    linewidth=.5,
    curvature=0.2) +
  geom_point(
    data=dt %>% filter(year == year_chosen),
    aes(x=origin_x, y=origin_y, color= "Origin"), 
    #colour="#417c5b",
    size=1.5) +
  geom_point(
    data=dt%>% filter(year == year_chosen),
    aes(x=destination_x, y=destination_y, color = "Destination"), 
    #colour="goldenrod"
    ) +
  scale_color_manual(breaks = c("Destination", "Origin"),values = c("#1F77B4", "#FF7F0E"))+
  labs(x="", y = "", color = "", title = paste0(year_chosen))+
  theme(
    legend.position = "bottom", 
    panel.background = element_blank(),
    axis.ticks = element_blank(), 
    axis.text=element_blank(),
    #plot.title = element_text(hjust = 0.5, size=10),
    legend.text=element_text(family = "Helvetica",size=11),
    #plot.caption = element_text(hjust=0.5,size = 10)
    text = element_text(family = "Helvetica", size = 11), 
    plot.title = element_text(hjust = 0.5)
  ) 
}



p1 <- map_plot_function(impoexpo, 2000)
p2 <- map_plot_function(impoexpo, 2005)
p3 <- map_plot_function(impoexpo, 2010)
p4 <- map_plot_function(impoexpo, 2018)

imp_exp_graph <- ggpubr::ggarrange(p1,p2,p3,p4, common.legend = TRUE, ncol = 4)


ggsave(imp_exp_graph, filename = "imp_exp_graph.pdf", device = cairo_pdf,
       path= figure_path,
       width = 15, height = 3, dpi=320, units = "in")

```

### Supplementing the data 

```{r}

states_need_export_data <- c("CO", "GA", "IL", "IN", "KY", "MO", "MS", "PA", "RI", "TX", "NY", "OH", "AZ", "OK", "AL", "NY") # CT needs after 2010, OH needs before 2010

states_need_import_data <- c("CO", "GA", "MO", "RI", "TN", "IL", "OH", "AZ","ME", "OK") # illinois needs after 2012

imported_tons_reported <- 
  rbind(
  imports,
  exports
) %>% 
  filter(
    destination %in% states_need_import_data
  ) %>% 
  group_by(
    year, destination, source_data
  ) %>% 
  summarise(imported_tons  = sum(tons, na.rm=TRUE)) %>% ungroup() %>% 
  filter(imported_tons > 100) %>% 
  filter(!(destination == "IL" & year <= 2012)) %>% # illinois needs after 2012
  filter(!(destination == "OH" & year >=2010)) #OH needs before 2010


exported_tons_reported <- 
rbind(
  imports,
  exports
) %>% 
  filter(
    origin %in% states_need_export_data, 
    origin != source_data
  ) %>% 
  #mutate(tons = ifelse(source_data == "OH", tons*0.5, tons)) %>% 
  group_by(
    year, origin
  ) %>% 
  summarise(exported_tons  = sum(tons, na.rm=TRUE)) %>% ungroup() %>% 
  filter(exported_tons > 100) %>% 
  filter(!(origin == "OH"& year >=2010)) #OH needs before 2010

power2_imp_exp <-
  power2 %>% filter(type == "disposal") %>% 
  left_join(
    population %>%  
      group_by (state_id, year) %>% 
      summarise(
        state_pop = sum(pop)
      ), 
    by = c("state_id", "year")
  ) %>% 
  filter(year < 2021) %>%  
  left_join(population, by = c("state_id", "year", "county_name")) %>% 
  left_join(
    exported_tons_reported %>%  group_by(year, origin) %>% summarise(exported_tons = sum(exported_tons)),
    by = c("state_id" = "origin", "year")
  ) %>% 
  left_join(
    imported_tons_reported %>%  group_by(year, destination) %>% summarise(imported_tons = sum(imported_tons)), 
    by = c("state_id" = "destination", "year")
  ) %>%  
  mutate(
    exported_tons = ifelse(is.na(exported_tons), 0,exported_tons),
    imported_tons = ifelse(is.na(imported_tons), 0,imported_tons), 
    tons = ifelse(!is.na(pop), tons + exported_tons * pop/state_pop, tons+ exported_tons),
    tons = ifelse(!is.na(pop), tons - imported_tons * pop/state_pop, tons- imported_tons)
  ) %>% 
  select(year, state_id, county_name, type, tons) %>% 
  rbind(
    power2 %>%  filter(type!="disposal")%>% 
      select(year, state_id, county_name, type, tons) 
  )



```

```{r}
power2_imp_exp %>%  mutate(datatype = "all") %>% 
  rbind(
    power2 %>% mutate(datatype = "original")
  ) %>% 
  filter(type == "disposal", year> 2005) %>% 
  filter(state_id %in% c("CT", "RI", "ME", "OK", "AL", "NY"), year <=2020) %>% 
  group_by(year, state_id, datatype) %>% 
  summarise(tons = sum(tons)) %>% 
  ggplot()+aes(x=year, y=tons, color=datatype) + 
  geom_line()+
  facet_grid(rows = vars(state_id), scales = "free_y")


power2 <- power2_imp_exp


# ia_exports %>% group_by(year) %>% filter(year<2020, year > 2005) %>%  summarise(tons = sum(tons)) %>% ggplot + aes(x=year, y=tons)+geom_line()
# 
# ia_imports %>% group_by(year) %>% filter(year<2021, year > 2005) %>%  summarise(tons = sum(tons)) %>% ggplot + aes(x=year, y=tons)+geom_line()

```



## Save power2

```{r}
#write.csv(power2_imp_exp, "power2_impexp.csv", row.names = FALSE)
```

